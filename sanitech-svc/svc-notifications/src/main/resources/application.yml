# =========================
# Server
# =========================
server:
  port: ${SERVER_PORT:8087}

# =========================
# Spring Application
# =========================
spring:
  application:
    name: "@project.artifactId@"
  profiles:
    active: "@spring.active.profile@"

  # =========================
  # Database (PostgreSQL)
  # =========================
  datasource:
    url: jdbc:postgresql://${DATABASE_HOST}:${DATABASE_PORT:5432}/${DATABASE_NAME}
    username: ${DATABASE_USER}
    password: ${DATABASE_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      pool-name: ${spring.application.name}-pool
      minimum-idle: 5
      maximum-pool-size: 10
      auto-commit: true
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  # =========================
  # JPA / Hibernate
  # =========================
  jpa:
    open-in-view: false
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        default_batch_fetch_size: 50
        show_sql: false
        format_sql: false

  # =========================
  # Flyway
  # =========================
  flyway:
    enabled: true
    locations: classpath:db/migration

  # =========================
  # Security / OAuth2 Resource Server
  # =========================
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: ${OAUTH2_SCHEME}://${OAUTH2_HOST}:${OAUTH2_PORT}/realms/${OAUTH2_REALM}/protocol/openid-connect/certs

  # =========================
  # Kafka
  # =========================
  kafka:
    bootstrap-servers: ${KAFKA_HOST}:${KAFKA_PORT}
    consumer:
      group-id: ${KAFKA_CONSUMER_GROUP:svc-notifications}
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
      retries: ${KAFKA_PRODUCER_RETRIES:10}
      properties:
        acks: ${KAFKA_PRODUCER_ACKS:all}
        linger.ms: ${KAFKA_PRODUCER_LINGER_MS:5}

  # =========================
  # Mail (SMTP)
  # =========================
  mail:
    host: ${MAIL_HOST:localhost}
    port: ${MAIL_PORT:1025}
    properties:
      mail.smtp.auth: false
      mail.smtp.starttls.enable: false

# =========================
# Sanitech Commons
# =========================
sanitech:
  cors:
    enabled: true
    path-patterns:
      - "/api/**"
    allowed-origins:
      - ${SANITECH_CORS_ALLOWED_ORIGINS:http://localhost:4200}
    allowed-methods:
      - "GET"
      - "POST"
      - "PUT"
      - "PATCH"
      - "DELETE"
      - "OPTIONS"
    allowed-headers:
      - "*"
    exposed-headers:
      - "Location"
      - "X-Request-Id"
    allow-credentials: false
    max-age: 3600

  security:
    enabled: true
    public-endpoints:
      - /v3/api-docs/**
      - /swagger-ui/**
      - /swagger-ui.html
      - /actuator/health/**
      - /actuator/info
      - /actuator/metrics/**
      - /actuator/prometheus

  openapi:
    enabled: true
    group: notifications
    packages-to-scan:
      - it.sanitech.notifications.web
    title: Sanitech â€” Notifications API
    version: v1

  directory:
    url: ${DIRECTORY_URL:http://localhost:8082}

  outbox:
    publisher:
      topic: ${OUTBOX_TOPIC:notifications.events}
      enabled: ${OUTBOX_PUBLISHER_ENABLED:false}
      fixed-delay-ms: ${OUTBOX_PUBLISHER_DELAY_MS:1000}

  notifications:
    mail:
      from: ${MAIL_FROM:no-reply@sanitech.example}
    dispatcher:
      delay-ms: ${NOTIFICATIONS_DISPATCHER_DELAY_MS:2000}
      batch-size: ${NOTIFICATIONS_DISPATCHER_BATCH_SIZE:50}
    activation-consumer:
      enabled: ${ACTIVATION_CONSUMER_ENABLED:true}
      topic: ${NOTIFICATIONS_EVENTS_TOPIC:notifications.events}
      group-id: ${ACTIVATION_CONSUMER_GROUP_ID:svc-notifications-activation}
    payment-reminder-consumer:
      enabled: ${PAYMENT_REMINDER_CONSUMER_ENABLED:true}
      topic: ${NOTIFICATIONS_EVENTS_TOPIC:notifications.events}
      group-id: ${PAYMENT_REMINDER_CONSUMER_GROUP_ID:svc-notifications-payment-reminder}
    account-status-consumer:
      enabled: ${ACCOUNT_STATUS_CONSUMER_ENABLED:true}
      topic: ${NOTIFICATIONS_EVENTS_TOPIC:notifications.events}
      group-id: ${ACCOUNT_STATUS_CONSUMER_GROUP_ID:svc-notifications-account-status}
    service-completion-consumer:
      enabled: ${SERVICE_COMPLETION_CONSUMER_ENABLED:true}
      topic: ${NOTIFICATIONS_EVENTS_TOPIC:notifications.events}
      group-id: ${SERVICE_COMPLETION_CONSUMER_GROUP_ID:svc-notifications-service-completion}

# =========================
# Management / Actuator
# =========================
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus,metrics
  endpoint:
    health:
      probes:
        enabled: true

# =========================
# Resilience4j
# =========================
resilience4j:
  retry:
    instances:
      outboxPublish:
        maxAttempts: 3
        waitDuration: 500ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2.0
        retryExceptions:
          - org.apache.kafka.common.errors.TimeoutException
          - org.apache.kafka.common.errors.NetworkException
          - org.springframework.kafka.KafkaException

      notificationEmail:
        maxAttempts: 3
        waitDuration: 500ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2.0
        retryExceptions:
          - org.springframework.mail.MailException

  ratelimiter:
    instances:
      notificationsApi:
        limitForPeriod: 60
        limitRefreshPeriod: 1s
        timeoutDuration: 0

  bulkhead:
    instances:
      notificationsRead:
        maxConcurrentCalls: 50
        maxWaitDuration: 0

# =========================
# OpenAPI / Swagger
# =========================
springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    enabled: true
    path: /swagger-ui
    operationsSorter: method
    tagsSorter: alpha
    use-root-path: false
  default-produces-media-type: application/json
  default-consumes-media-type: application/json

# =========================
# Logging
# =========================
logging:
  level:
    root: INFO
    it.sanitech: DEBUG
    # Riduce il log verboso di Hibernate sui metadati del datasource
    org.hibernate.engine.jdbc.env.internal.JdbcEnvironmentInitiator: WARN
