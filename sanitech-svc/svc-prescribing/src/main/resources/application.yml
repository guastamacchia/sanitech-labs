# =========================
# Server
# =========================
server:
  port: ${SERVER_PORT:8091}

# =========================
# Spring Application
# =========================
spring:
  application:
    name: "@project.artifactId@"
  profiles:
    active: "@spring.active.profile@"

  # =========================
  # Database (PostgreSQL)
  # =========================
  datasource:
    url: jdbc:postgresql://${DATABASE_HOST}:${DATABASE_PORT:5432}/${DATABASE_NAME}
    username: ${DATABASE_USER}
    password: ${DATABASE_PASSWORD}

  # =========================
  # JPA / Hibernate
  # =========================
  jpa:
    open-in-view: false
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        default_batch_fetch_size: 50
        show_sql: false
        format_sql: false
        jdbc:
          time_zone: UTC

  # =========================
  # Flyway
  # =========================
  flyway:
    enabled: true
    locations: classpath:db/migration

  # =========================
  # Security / OAuth2 Resource Server
  # =========================
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: ${OAUTH2_SCHEME}://${OAUTH2_HOST}:${OAUTH2_PORT}/realms/${OAUTH2_REALM}/protocol/openid-connect/certs

  # =========================
  # Kafka
  # =========================
  kafka:
    bootstrap-servers: ${KAFKA_HOST}:${KAFKA_PORT}
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
      retries: ${KAFKA_PRODUCER_RETRIES:10}
      properties:
        acks: ${KAFKA_PRODUCER_ACKS:all}
        linger.ms: ${KAFKA_PRODUCER_LINGER_MS:5}

# =========================
# Sanitech Commons
# =========================
sanitech:
  cors:
    enabled: true
    path-patterns:
      - /api/**
    allowed-origins:
      - ${SANITECH_CORS_ALLOWED_ORIGINS:http://localhost:4200}
    allowed-methods:
      - "GET"
      - "POST"
      - "PUT"
      - "PATCH"
      - "DELETE"
      - "OPTIONS"
    allowed-headers:
      - "*"
    exposed-headers:
      - "Location"
    allow-credentials: false
    max-age: 3600

  security:
    enabled: true
    public-endpoints:
      - /v3/api-docs/**
      - /swagger-ui/**
      - /swagger-ui.html
      - /actuator/health/**
      - /actuator/info
      - /actuator/metrics/**
      - /actuator/prometheus

  openapi:
    enabled: true
    group: prescribing
    packages-to-scan:
      - it.sanitech.prescribing.web
    title: Sanitech â€” Prescribing API
    version: v1

  integrations:
    consents:
      base-url: ${CONSENTS_BASE_URL:http://localhost:8085}

  outbox:
    publisher:
      topic: ${OUTBOX_TOPIC:prescribing.events}
      enabled: ${OUTBOX_PUBLISHER_ENABLED:false}
      fixed-delay-ms: ${OUTBOX_PUBLISHER_DELAY_MS:1000}

# =========================
# Management / Actuator
# =========================
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus,metrics
  endpoint:
    health:
      probes:
        enabled: true

# =========================
# OpenAPI / Swagger
# =========================
springdoc:
  api-docs:
    enabled: true
  swagger-ui:
    enabled: true
    path: /swagger-ui.html

# =========================
# Resilience4j
# =========================
resilience4j:
  ratelimiter:
    instances:
      prescribingApi:
        limitForPeriod: 60
        limitRefreshPeriod: 1s
        timeoutDuration: 0

  bulkhead:
    instances:
      prescribingRead:
        maxConcurrentCalls: 30
        maxWaitDuration: 0

  retry:
    instances:
      outboxPublish:
        maxAttempts: 5
        waitDuration: 250ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
        retryExceptions:
          - java.lang.Exception

      consents:
        maxAttempts: 3
        waitDuration: 200ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2

  circuitbreaker:
    instances:
      consents:
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 20
        minimumNumberOfCalls: 10
        permittedNumberOfCallsInHalfOpenState: 5
        waitDurationInOpenState: 10s
        failureRateThreshold: 50
        slowCallRateThreshold: 50
        slowCallDurationThreshold: 2s

# =========================
# Logging
# =========================
logging:
  level:
    root: INFO
    it.sanitech: DEBUG
