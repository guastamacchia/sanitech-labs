<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2">
          <li class="breadcrumb-item"><a routerLink="/portal/doctor">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">La mia agenda</li>
        </ol>
      </nav>
      <h2 class="mb-1 fw-bold">La mia agenda</h2>
      <p class="text-muted mb-0">Gestisci slot e appuntamenti settimanali</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" (click)="loadSlots()" [disabled]="isLoading">
        <i class="bi bi-arrow-clockwise me-1"></i>
        Aggiorna
      </button>
      <button class="btn btn-primary" (click)="openCreateSlotModal()">
        <i class="bi bi-plus-lg me-1"></i>
        Crea slot
      </button>
      <button class="btn btn-outline-secondary" routerLink="/portal/doctor">
        <i class="bi bi-arrow-left me-1"></i>
        Torna indietro
      </button>
    </div>
  </div>

  <!-- Alert messages -->
  <div class="alert alert-success alert-dismissible fade show" *ngIf="successMessage" role="alert">
    <i class="bi bi-check-circle me-2"></i>
    {{ successMessage }}
    <button type="button" class="btn-close" aria-label="Chiudi" (click)="successMessage = ''"></button>
  </div>

  <!-- Loading -->
  <div class="text-center py-5" *ngIf="isLoading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Caricamento...</span>
    </div>
    <p class="text-muted mt-2">Caricamento agenda...</p>
  </div>

  <!-- Stats Cards -->
  <div class="row g-3 mb-4" *ngIf="!isLoading">
    <div class="col-md-3">
      <div class="card card-glass h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
              <i class="bi bi-calendar-week text-primary fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ totalSlots }}</h3>
              <small class="text-muted">Slot totali</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-glass h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
              <i class="bi bi-check-circle text-success fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ availableSlots }}</h3>
              <small class="text-muted">Disponibili</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-glass h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-info bg-opacity-10 p-3 me-3">
              <i class="bi bi-person-check text-info fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ bookedSlots }}</h3>
              <small class="text-muted">Prenotati</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-glass h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-secondary bg-opacity-10 p-3 me-3">
              <i class="bi bi-slash-circle text-secondary fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ blockedSlots }}</h3>
              <small class="text-muted">Bloccati</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toggle vista -->
  <div class="d-flex justify-content-between align-items-center mb-3" *ngIf="!isLoading">
    <div class="btn-group" role="group">
      <input type="radio" class="btn-check" name="viewMode" id="viewCalendar" value="calendar" [(ngModel)]="viewMode">
      <label class="btn btn-outline-primary" for="viewCalendar">
        <i class="bi bi-calendar-week me-1"></i>Calendario
      </label>
      <input type="radio" class="btn-check" name="viewMode" id="viewList" value="list" [(ngModel)]="viewMode">
      <label class="btn btn-outline-primary" for="viewList">
        <i class="bi bi-list-ul me-1"></i>Prossimi appuntamenti
      </label>
    </div>
    <!-- Legenda -->
    <div class="d-flex gap-3 flex-wrap" *ngIf="viewMode === 'calendar'">
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-success bg-opacity-25 text-success border border-success">&nbsp;&nbsp;&nbsp;</span>
        <small class="text-muted">Disponibile</small>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-primary bg-opacity-25 text-primary border border-primary">&nbsp;&nbsp;&nbsp;</span>
        <small class="text-muted">Prenotato</small>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-secondary bg-opacity-25 text-secondary border border-secondary">&nbsp;&nbsp;&nbsp;</span>
        <small class="text-muted">Bloccato</small>
      </div>
    </div>
  </div>

  <!-- Vista CALENDARIO -->
  <ng-container *ngIf="viewMode === 'calendar' && !isLoading">
    <!-- Navigazione settimana -->
    <div class="card card-glass border-0 shadow-sm mb-4">
      <div class="card-body py-2">
        <div class="d-flex justify-content-between align-items-center">
          <button class="btn btn-outline-secondary btn-sm" (click)="previousWeek()">
            <i class="bi bi-chevron-left me-1"></i>Settimana precedente
          </button>
          <div class="d-flex align-items-center gap-3">
            <h5 class="mb-0 fw-semibold">{{ getWeekRangeLabel() }}</h5>
            <button class="btn btn-sm btn-outline-primary" (click)="goToToday()">Oggi</button>
          </div>
          <button class="btn btn-outline-secondary btn-sm" (click)="nextWeek()">
            Settimana successiva<i class="bi bi-chevron-right ms-1"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Calendario settimanale -->
    <div class="card card-glass border-0 shadow-sm">
      <div class="card-body p-0">
        <div class="row g-0">
          <div *ngFor="let day of weekDays" class="col border-end" [class.bg-light]="isPast(day)" [class.border-primary]="isToday(day)" [class.border-2]="isToday(day)">
            <!-- Header giorno -->
            <div class="p-3 border-bottom text-center" [class.bg-primary]="isToday(day)" [class.bg-opacity-10]="isToday(day)">
              <div class="fw-semibold" [class.text-primary]="isToday(day)">{{ formatShortDate(day) }}</div>
              <small class="text-muted" *ngIf="isToday(day)">Oggi</small>
            </div>

            <!-- Slot del giorno -->
            <div class="p-2" style="min-height: 300px;">
              <div *ngFor="let slot of getSlotsForDay(day)"
                   class="mb-2 p-2 rounded border cursor-pointer"
                   [ngClass]="getSlotBgClass(slot)"
                   (click)="openSlotDetail(slot)"
                   style="cursor: pointer;">
                <div class="d-flex justify-content-between align-items-start">
                  <span class="fw-medium small">{{ slot.time }}</span>
                  <i [class]="'bi ' + getModalityIcon(slot.modality)" class="small"></i>
                </div>
                <div *ngIf="slot.status === 'BOOKED'" class="small text-truncate mt-1">
                  {{ slot.patientName }}
                </div>
                <div *ngIf="slot.status === 'BLOCKED'" class="small text-muted mt-1">
                  <i class="bi bi-lock-fill"></i> Bloccato
                </div>
              </div>

              <!-- Nessuno slot -->
              <div *ngIf="getSlotsForDay(day).length === 0" class="text-center text-muted py-4">
                <i class="bi bi-calendar-x d-block mb-2"></i>
                <small>Nessuno slot</small>
                <br>
                <button class="btn btn-sm btn-outline-primary mt-2" (click)="openCreateSlotModal(day)" *ngIf="!isPast(day)">
                  <i class="bi bi-plus"></i> Aggiungi
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Vista LISTA APPUNTAMENTI -->
  <ng-container *ngIf="viewMode === 'list' && !isLoading">
    <div class="card card-glass border-0 shadow-sm">
      <div class="card-header bg-transparent border-bottom">
        <h5 class="mb-0 fw-semibold">
          <i class="bi bi-calendar-check me-2"></i>
          Prossimi appuntamenti confermati
          <span class="badge bg-primary ms-2">{{ upcomingAppointments.length }}</span>
        </h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="ps-4">Paziente</th>
                <th>Data</th>
                <th>Orario</th>
                <th>Modalità</th>
                <th>Motivo</th>
                <th class="pe-4 text-end">Azioni</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let slot of upcomingAppointments">
                <td class="ps-4">
                  <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-primary bg-opacity-10 p-2 me-2">
                      <i class="bi bi-person text-primary"></i>
                    </div>
                    <span class="fw-medium">{{ slot.patientName }}</span>
                  </div>
                </td>
                <td>
                  <span class="fw-medium">{{ formatDate(slot.date) }}</span>
                </td>
                <td>{{ slot.time }}</td>
                <td>
                  <span class="badge" [ngClass]="slot.modality === 'TELEVISIT' ? 'bg-info bg-opacity-10 text-info' : 'bg-success bg-opacity-10 text-success'">
                    <i [class]="'bi me-1 ' + getModalityIcon(slot.modality)"></i>
                    {{ getModalityLabel(slot.modality) }}
                  </span>
                </td>
                <td>
                  <span class="text-muted">{{ slot.visitReason || '-' }}</span>
                </td>
                <td class="pe-4 text-end">
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" (click)="openSlotDetail(slot)" title="Dettagli">
                      <i class="bi bi-eye"></i>
                    </button>
                    <a routerLink="/portal/doctor/patients" class="btn btn-outline-secondary" title="Cartella paziente">
                      <i class="bi bi-folder2-open"></i>
                    </a>
                  </div>
                </td>
              </tr>
              <tr *ngIf="upcomingAppointments.length === 0">
                <td colspan="6" class="text-center py-5 text-muted">
                  <i class="bi bi-calendar-x fs-1 d-block mb-2"></i>
                  <p class="mb-0">Nessun appuntamento programmato.</p>
                  <small>Gli appuntamenti prenotati dai pazienti appariranno qui.</small>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </ng-container>
</div>

<!-- Modal creazione slot -->
<ng-container *ngIf="showCreateSlotModal">
  <div class="modal-backdrop fade show"></div>
  <div class="modal fade show d-block" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-calendar-plus me-2"></i>
            Crea slot disponibilità
          </h5>
          <button type="button" class="btn-close" (click)="closeCreateSlotModal()"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger" *ngIf="errorMessage">
            <i class="bi bi-exclamation-triangle me-2"></i>
            {{ errorMessage }}
          </div>

          <div class="mb-3">
            <label class="form-label">Data *</label>
            <input type="date" class="form-control" [(ngModel)]="slotForm.date">
          </div>

          <div class="row g-3 mb-3">
            <div class="col-6">
              <label class="form-label">Ora inizio</label>
              <input type="time" class="form-control" [(ngModel)]="slotForm.startTime">
            </div>
            <div class="col-6">
              <label class="form-label">Ora fine</label>
              <input type="time" class="form-control" [(ngModel)]="slotForm.endTime">
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Durata singolo appuntamento</label>
            <select class="form-select" [(ngModel)]="slotForm.duration">
              <option [ngValue]="15">15 minuti</option>
              <option [ngValue]="30">30 minuti</option>
              <option [ngValue]="45">45 minuti</option>
              <option [ngValue]="60">60 minuti</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Modalità</label>
            <select class="form-select" [(ngModel)]="slotForm.modality">
              <option value="IN_PERSON">Solo in presenza</option>
              <option value="TELEVISIT">Solo televisita</option>
              <option value="BOTH">Entrambe (scelta del paziente)</option>
            </select>
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="repeatWeekly" [(ngModel)]="slotForm.repeatWeekly">
            <label class="form-check-label" for="repeatWeekly">
              Ripeti settimanalmente
            </label>
          </div>

          <div class="mb-3" *ngIf="slotForm.repeatWeekly">
            <label class="form-label">Per quante settimane?</label>
            <select class="form-select" [(ngModel)]="slotForm.repeatWeeks">
              <option [ngValue]="2">2 settimane</option>
              <option [ngValue]="4">4 settimane</option>
              <option [ngValue]="8">8 settimane</option>
              <option [ngValue]="12">12 settimane</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" (click)="closeCreateSlotModal()">Annulla</button>
          <button type="button" class="btn btn-primary" (click)="createSlots()" [disabled]="isSaving">
            <span class="spinner-border spinner-border-sm me-1" *ngIf="isSaving"></span>
            Crea slot
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!-- Modal dettaglio slot -->
<ng-container *ngIf="showSlotDetailModal && selectedSlot">
  <div class="modal-backdrop fade show"></div>
  <div class="modal fade show d-block" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-clock me-2"></i>
            Slot {{ selectedSlot.time }}
          </h5>
          <button type="button" class="btn-close" (click)="closeSlotDetailModal()"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <div class="d-flex align-items-center gap-2 mb-2">
              <span class="badge" [ngClass]="{
                'bg-success': selectedSlot.status === 'AVAILABLE',
                'bg-primary': selectedSlot.status === 'BOOKED',
                'bg-secondary': selectedSlot.status === 'BLOCKED'
              }">
                {{ selectedSlot.status === 'AVAILABLE' ? 'Disponibile' : selectedSlot.status === 'BOOKED' ? 'Prenotato' : 'Bloccato' }}
              </span>
              <span class="badge bg-light text-dark border">
                <i [class]="'bi ' + getModalityIcon(selectedSlot.modality) + ' me-1'"></i>
                {{ getModalityLabel(selectedSlot.modality) }}
              </span>
            </div>
            <p class="text-muted small mb-0">
              {{ formatDate(selectedSlot.date) }} • Durata: {{ selectedSlot.duration }} minuti
            </p>
          </div>

          <!-- Info paziente se prenotato -->
          <div *ngIf="selectedSlot.status === 'BOOKED'" class="card card-glass border mb-3">
            <div class="card-body">
              <h6 class="fw-semibold mb-2">
                <i class="bi bi-person me-1"></i>
                Paziente
              </h6>
              <p class="mb-1 fw-medium">{{ selectedSlot.patientName }}</p>
              <p class="mb-0 text-muted small">{{ selectedSlot.visitReason }}</p>
            </div>
          </div>

          <!-- Azioni -->
          <div class="d-grid gap-2">
            <!-- Slot disponibile -->
            <button class="btn btn-outline-secondary" (click)="blockSlot(selectedSlot)" *ngIf="selectedSlot.status === 'AVAILABLE'">
              <i class="bi bi-lock me-1"></i>Blocca slot
            </button>

            <!-- Slot bloccato -->
            <button class="btn btn-outline-success" (click)="unblockSlot(selectedSlot)" *ngIf="selectedSlot.status === 'BLOCKED'">
              <i class="bi bi-unlock me-1"></i>Sblocca slot
            </button>

            <!-- Slot prenotato -->
            <ng-container *ngIf="selectedSlot.status === 'BOOKED'">
              <a routerLink="/portal/doctor/patients" class="btn btn-outline-primary" (click)="closeSlotDetailModal()">
                <i class="bi bi-folder2-open me-1"></i>Apri cartella paziente
              </a>
              <button class="btn btn-outline-danger" (click)="cancelAppointment(selectedSlot)">
                <i class="bi bi-x-circle me-1"></i>Cancella appuntamento
              </button>
            </ng-container>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeSlotDetailModal()">Chiudi</button>
        </div>
      </div>
    </div>
  </div>
</ng-container>
