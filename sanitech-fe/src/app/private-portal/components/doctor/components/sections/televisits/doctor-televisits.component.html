<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2">
          <li class="breadcrumb-item"><a routerLink="/portal/doctor">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">Le mie televisite</li>
        </ol>
      </nav>
      <h2 class="mb-1 fw-bold">Le mie televisite</h2>
      <p class="text-muted mb-0">Gestisci le visite a distanza con i tuoi pazienti</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" (click)="loadTelevisits()" [disabled]="isLoading">
        <i class="bi bi-arrow-clockwise me-1"></i>
        Aggiorna
      </button>
      <button class="btn btn-outline-secondary" routerLink="/portal/doctor">
        <i class="bi bi-arrow-left me-1"></i>
        Torna indietro
      </button>
    </div>
  </div>

  <!-- FIX BUG-06: Alert messaggi successo E errore -->
  <div class="alert alert-success alert-dismissible fade show" *ngIf="successMessage" role="alert">
    <i class="bi bi-check-circle me-2"></i>
    {{ successMessage }}
    <button type="button" class="btn-close" aria-label="Chiudi" (click)="successMessage = ''"></button>
  </div>

  <div class="alert alert-danger alert-dismissible fade show" *ngIf="errorMessage" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ errorMessage }}
    <button type="button" class="btn-close" aria-label="Chiudi" (click)="errorMessage = ''"></button>
  </div>

  <!-- Loading -->
  <div class="text-center py-5" *ngIf="isLoading" role="status" aria-live="polite">
    <div class="spinner-border text-primary">
      <span class="visually-hidden">Caricamento...</span>
    </div>
    <p class="text-muted mt-2">Caricamento televisite...</p>
  </div>

  <!-- FIX BUG-08: Prossima visita — pulsante Avvia apre solo preparazione, NON chiama startTelevisit() -->
  <div class="card card-glass border-primary border-2 shadow-sm mb-4" *ngIf="nextVisit && !isLoading">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-8">
          <div class="d-flex align-items-center mb-2">
            <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
              <i class="bi bi-camera-video text-primary fs-4"></i>
            </div>
            <div>
              <h5 class="mb-0 fw-bold">Prossima televisita</h5>
              <span class="badge bg-primary">{{ getTimeUntil(nextVisit.scheduledAt) }}</span>
            </div>
          </div>
          <div class="ms-5 ps-3">
            <p class="mb-1"><strong>{{ nextVisit.patientName }}</strong></p>
            <p class="text-muted mb-1">{{ nextVisit.reason }}</p>
            <p class="mb-0 small">
              <i class="bi bi-clock me-1"></i>
              {{ formatTime(nextVisit.scheduledAt) }} - {{ nextVisit.duration }} minuti
            </p>
          </div>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <button class="btn btn-outline-primary me-2" (click)="openPreparation(nextVisit)" aria-label="Prepara visita">
            <i class="bi bi-folder2-open me-1"></i>Prepara visita
          </button>
          <button class="btn btn-success" (click)="openPreparation(nextVisit)" [disabled]="!canStart(nextVisit)" aria-label="Avvia televisita">
            <i class="bi bi-play-fill me-1"></i>Avvia
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row g-3 mb-4" *ngIf="!isLoading">
    <div class="col-md-4">
      <div class="card card-glass h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
              <i class="bi bi-calendar-day text-primary fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ todayVisits }}</h3>
              <small class="text-muted">Oggi</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card card-glass h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-info bg-opacity-10 p-3 me-3">
              <i class="bi bi-calendar-week text-info fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ weekVisits }}</h3>
              <small class="text-muted">Questa settimana</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card card-glass h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
              <i class="bi bi-check-circle text-success fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ completedVisits }}</h3>
              <small class="text-muted">Completate</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FIX BUG-13/18: Filtri — aggiunta opzione Cancellate, rimossa NO_SHOW -->
  <div class="card card-glass border-0 shadow-sm mb-4" *ngIf="!isLoading">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label fw-semibold small text-muted" for="dateFilter">Periodo</label>
          <select class="form-select" id="dateFilter" [(ngModel)]="dateFilter" (ngModelChange)="currentPage = 1">
            <option value="TODAY">Oggi</option>
            <option value="WEEK">Questa settimana</option>
            <option value="ALL">Tutte</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold small text-muted" for="statusFilter">Stato</label>
          <select class="form-select" id="statusFilter" [(ngModel)]="statusFilter" (ngModelChange)="currentPage = 1">
            <option value="ALL">Tutti gli stati</option>
            <option value="SCHEDULED">Programmate</option>
            <option value="IN_PROGRESS">In corso</option>
            <option value="COMPLETED">Completate</option>
            <option value="CANCELLED">Cancellate</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista televisite -->
  <div class="card card-glass border-0 shadow-sm" *ngIf="!isLoading">
    <div class="card-header bg-transparent border-bottom">
      <h5 class="mb-0 fw-semibold">
        <i class="bi bi-list-ul me-2"></i>
        Elenco televisite
        <span class="badge bg-secondary ms-2">{{ filteredTelevisits.length }}</span>
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="list-group list-group-flush">
        <div *ngFor="let televisit of paginatedTelevisits"
             class="list-group-item p-3"
             [class.bg-primary]="televisit.status === 'IN_PROGRESS'"
             [class.bg-opacity-10]="televisit.status === 'IN_PROGRESS'">
          <div class="d-flex align-items-start">
            <!-- FIX BUG-20/G9: Icona differenziata per stato (non solo colore) -->
            <div class="rounded-circle p-2 me-3" [ngClass]="{
              'bg-primary bg-opacity-10': televisit.status === 'SCHEDULED',
              'bg-success bg-opacity-10': televisit.status === 'IN_PROGRESS' || televisit.status === 'COMPLETED',
              'bg-danger bg-opacity-10': televisit.status === 'CANCELLED'
            }">
              <i class="bi" [ngClass]="getStatusIcon(televisit.status)" [class.text-primary]="televisit.status === 'SCHEDULED'"
                 [class.text-success]="televisit.status === 'IN_PROGRESS' || televisit.status === 'COMPLETED'"
                 [class.text-danger]="televisit.status === 'CANCELLED'"></i>
            </div>
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-start mb-1">
                <div>
                  <h6 class="mb-0 fw-semibold">{{ televisit.patientName }}</h6>
                  <small class="text-muted">{{ televisit.reason }}</small>
                </div>
                <span class="badge" [ngClass]="getStatusBadgeClass(televisit.status)" role="status">
                  {{ getStatusLabel(televisit.status) }}
                </span>
              </div>
              <div class="d-flex align-items-center gap-3 mt-2">
                <span class="small">
                  <i class="bi bi-calendar me-1"></i>
                  <span [class.fw-bold]="isToday(televisit.scheduledAt)" [class.text-primary]="isToday(televisit.scheduledAt)">
                    {{ isToday(televisit.scheduledAt) ? 'Oggi' : formatDate(televisit.scheduledAt) }}
                  </span>
                </span>
                <span class="small">
                  <i class="bi bi-clock me-1"></i>
                  {{ formatTime(televisit.scheduledAt) }}
                </span>
                <span class="small text-muted">
                  <i class="bi bi-hourglass me-1"></i>
                  {{ televisit.duration }} min
                </span>
              </div>
              <!-- Note se completata -->
              <div *ngIf="televisit.status === 'COMPLETED' && televisit.notes" class="mt-2 p-2 bg-light rounded small">
                <i class="bi bi-journal-text me-1"></i>
                {{ televisit.notes }}
              </div>
            </div>
            <!-- FIX BUG-04: Mostra azioni anche per IN_PROGRESS -->
            <div class="ms-3 d-flex flex-column gap-1" *ngIf="televisit.status === 'SCHEDULED' || televisit.status === 'IN_PROGRESS'">
              <button class="btn btn-sm btn-outline-primary" (click)="openPreparation(televisit)" aria-label="Prepara visita">
                <i class="bi bi-folder2-open"></i>
              </button>
              <button class="btn btn-sm btn-success" (click)="openPreparation(televisit)" [disabled]="!canStart(televisit)"
                      [attr.aria-label]="'Avvia televisita con ' + televisit.patientName">
                <i class="bi bi-play-fill"></i>
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="filteredTelevisits.length === 0" class="text-center py-5">
          <div class="text-muted">
            <i class="bi bi-camera-video-off fs-1 d-block mb-3"></i>
            <p class="mb-0">Nessuna televisita trovata per i criteri selezionati.</p>
          </div>
        </div>
      </div>
    </div>
    <!-- FIX BUG-20/G7: Paginazione con aria-label -->
    <div class="card-footer bg-transparent border-top" *ngIf="totalPages > 1">
      <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted">
          Pagina {{ currentPage }} di {{ totalPages }}
        </small>
        <nav aria-label="Paginazione televisite">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <button class="page-link" (click)="currentPage = currentPage - 1" [disabled]="currentPage === 1"
                      aria-label="Pagina precedente">
                <i class="bi bi-chevron-left"></i>
              </button>
            </li>
            <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index" [class.active]="currentPage === i + 1">
              <button class="page-link" (click)="currentPage = i + 1" [attr.aria-label]="'Pagina ' + (i + 1)"
                      [attr.aria-current]="currentPage === i + 1 ? 'page' : null">
                {{ i + 1 }}
              </button>
            </li>
            <li class="page-item" [class.disabled]="currentPage === totalPages">
              <button class="page-link" (click)="currentPage = currentPage + 1" [disabled]="currentPage === totalPages"
                      aria-label="Pagina successiva">
                <i class="bi bi-chevron-right"></i>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- FIX BUG-20/G3/G4: Modal preparazione visita con attributi ARIA -->
<ng-container *ngIf="showPreparationModal && selectedTelevisit">
  <div class="modal-backdrop fade show"></div>
  <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="prepModalTitle">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="prepModalTitle">
            <i class="bi bi-folder2-open me-2"></i>
            Prepara televisita
          </h5>
          <button type="button" class="btn-close" (click)="closePreparation()" aria-label="Chiudi modale"></button>
        </div>
        <div class="modal-body">
          <!-- Info paziente -->
          <div class="d-flex align-items-center mb-4">
            <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
              <i class="bi bi-person text-primary fs-4"></i>
            </div>
            <div>
              <h5 class="mb-0 fw-bold">{{ selectedTelevisit.patientName }}</h5>
              <p class="text-muted mb-0">{{ selectedTelevisit.reason }}</p>
            </div>
          </div>

          <!-- Orario -->
          <div class="alert alert-primary border-0 mb-4">
            <div class="d-flex align-items-center">
              <i class="bi bi-clock me-2"></i>
              <span>
                {{ isToday(selectedTelevisit.scheduledAt) ? 'Oggi' : formatDate(selectedTelevisit.scheduledAt) }}
                alle {{ formatTime(selectedTelevisit.scheduledAt) }}
                ({{ selectedTelevisit.duration }} minuti)
              </span>
            </div>
          </div>

          <!-- Accesso rapido — FIX BUG-12: link usano href nativo con target=_blank -->
          <h6 class="fw-semibold mb-3">Accesso rapido alla cartella</h6>
          <div class="row g-3">
            <div class="col-md-4">
              <a href="/portal/doctor/clinical-docs" target="_blank" class="card card-glass border h-100 text-decoration-none">
                <div class="card-body text-center py-3">
                  <i class="bi bi-file-earmark-medical text-primary fs-4 d-block mb-2"></i>
                  <span class="small">Documenti</span>
                </div>
              </a>
            </div>
            <div class="col-md-4">
              <a href="/portal/doctor/prescriptions" target="_blank" class="card card-glass border h-100 text-decoration-none">
                <div class="card-body text-center py-3">
                  <i class="bi bi-prescription2 text-success fs-4 d-block mb-2"></i>
                  <span class="small">Prescrizioni</span>
                </div>
              </a>
            </div>
            <div class="col-md-4">
              <a href="/portal/doctor/patients" target="_blank" class="card card-glass border h-100 text-decoration-none">
                <div class="card-body text-center py-3">
                  <i class="bi bi-folder2 text-info fs-4 d-block mb-2"></i>
                  <span class="small">Cartella completa</span>
                </div>
              </a>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" (click)="closePreparation()">Chiudi</button>
          <button type="button" class="btn btn-success" (click)="startTelevisit()" [disabled]="!canStart(selectedTelevisit)">
            <i class="bi bi-play-fill me-1"></i>
            Avvia televisita
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!-- FIX BUG-20/G3/G4: Modal videochiamata con attributi ARIA -->
<ng-container *ngIf="showVideoModal && selectedTelevisit">
  <div class="modal-backdrop fade show"></div>
  <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="videoModalTitle">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content bg-dark">
        <div class="modal-header bg-dark text-white border-secondary">
          <div class="d-flex align-items-center">
            <span class="badge bg-danger me-2">
              <i class="bi bi-record-circle me-1"></i>LIVE
            </span>
            <h5 class="modal-title mb-0" id="videoModalTitle">
              Televisita con {{ selectedTelevisit.patientName }}
            </h5>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="text-muted small">{{ formatTime(selectedTelevisit.scheduledAt) }}</span>
            <button type="button" class="btn btn-outline-light btn-sm" (click)="closeVideoModal()" aria-label="Chiudi televisita">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>
        <div class="modal-body p-0 d-flex">
          <!-- Area video principale -->
          <div class="flex-grow-1 d-flex align-items-center justify-content-center bg-secondary bg-opacity-25">
            <div class="text-center text-white">
              <i class="bi bi-camera-video fs-1 d-block mb-3"></i>
              <p class="mb-0">In attesa del collegamento del paziente...</p>
              <small class="text-muted">Il paziente vedrà la tua immagine quando si connetterà</small>
            </div>
          </div>

          <!-- Pannello laterale -->
          <div class="bg-dark text-white p-3" style="width: 350px; overflow-y: auto;">
            <!-- Info paziente -->
            <div class="mb-4">
              <h6 class="text-muted small mb-2">PAZIENTE</h6>
              <p class="fw-bold mb-1">{{ selectedTelevisit.patientName }}</p>
              <p class="small text-muted mb-0">{{ selectedTelevisit.reason }}</p>
            </div>

            <!-- Note visita -->
            <div class="mb-4">
              <h6 class="text-muted small mb-2">
                <label for="visitNotesTextarea">NOTE VISITA</label>
              </h6>
              <textarea class="form-control bg-secondary text-white border-0" rows="6" id="visitNotesTextarea"
                        [(ngModel)]="visitNotes"
                        placeholder="Scrivi le note della visita..."></textarea>
            </div>

            <!-- FIX BUG-12: Azioni rapide — usa href nativo con target=_blank -->
            <div class="mb-4">
              <h6 class="text-muted small mb-2">AZIONI RAPIDE</h6>
              <div class="d-grid gap-2">
                <a href="/portal/doctor/prescriptions" target="_blank" class="btn btn-outline-light btn-sm">
                  <i class="bi bi-prescription2 me-1"></i>Nuova prescrizione
                </a>
                <a href="/portal/doctor/clinical-docs" target="_blank" class="btn btn-outline-light btn-sm">
                  <i class="bi bi-file-earmark-medical me-1"></i>Visualizza documenti
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer bg-dark border-secondary justify-content-between">
          <!-- FIX BUG-16: Pulsanti media con handler e stato -->
          <div class="d-flex gap-2">
            <button class="btn" [class.btn-outline-light]="!isMuted" [class.btn-warning]="isMuted"
                    (click)="toggleMute()" [attr.aria-label]="isMuted ? 'Attiva microfono' : 'Disattiva microfono'">
              <i class="bi" [ngClass]="isMuted ? 'bi-mic-mute-fill' : 'bi-mic-fill'"></i>
            </button>
            <button class="btn" [class.btn-outline-light]="!isCameraOff" [class.btn-warning]="isCameraOff"
                    (click)="toggleCamera()" [attr.aria-label]="isCameraOff ? 'Attiva camera' : 'Disattiva camera'">
              <i class="bi" [ngClass]="isCameraOff ? 'bi-camera-video-off-fill' : 'bi-camera-video-fill'"></i>
            </button>
          </div>
          <div class="d-flex gap-2">
            <!-- FIX BUG-10: Testo corretto per il pulsante (non promette referto) -->
            <button class="btn btn-outline-success" (click)="endTelevisit(true)">
              <i class="bi bi-journal-check me-1"></i>Concludi e salva note
            </button>
            <button class="btn btn-danger" (click)="endTelevisit(false)">
              <i class="bi bi-telephone-x me-1"></i>Concludi visita
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!-- FIX BUG-14: Modale di conferma chiusura televisita (sostituisce confirm()) -->
<ng-container *ngIf="showEndConfirmModal">
  <div class="modal-backdrop fade show" style="z-index: 1060;"></div>
  <div class="modal fade show d-block" tabindex="-1" style="z-index: 1061;" role="dialog" aria-modal="true" aria-labelledby="confirmEndTitle">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmEndTitle">Conferma chiusura</h5>
          <button type="button" class="btn-close" (click)="cancelEndConfirm()" aria-label="Annulla"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">Vuoi concludere la televisita?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" (click)="cancelEndConfirm()">Annulla</button>
          <button type="button" class="btn btn-danger" (click)="confirmEndTelevisit()">
            <i class="bi bi-telephone-x me-1"></i>Concludi
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-container>
