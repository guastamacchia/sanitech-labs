<section class="py-4">
  <div class="container-fluid">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
      <div>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-2">
            <li class="breadcrumb-item"><a [routerLink]="portalHomeRoute">{{ portalHomeLabel }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
          </ol>
        </nav>
        <h2 class="mb-1 fw-bold">{{ title }}</h2>
        <p class="text-muted mb-0">{{ description }}</p>
      </div>
      <button class="btn btn-outline-secondary" type="button" (click)="goToPortalHome()">
        <i class="bi bi-arrow-left me-1"></i>
        Torna indietro
      </button>
    </div>

    <ng-template #paginationFooter let-key="key" let-total="total">
      <div class="d-flex flex-wrap align-items-center justify-content-between mt-3">
        <div class="d-flex align-items-center gap-2">
          <small class="text-muted">Elementi per pagina</small>
          <select class="form-select form-select-sm w-auto" [(ngModel)]="pageSize" (ngModelChange)="resetPagination()">
            <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
          </select>
        </div>
        <nav aria-label="Paginazione">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item" [class.disabled]="getPage(key) <= 1">
              <button class="page-link" type="button" (click)="setPage(key, getPage(key) - 1, total)">¬´</button>
            </li>
            <li class="page-item active">
              <span class="page-link">{{ getPage(key) }} / {{ getTotalPages(total) }}</span>
            </li>
            <li class="page-item" [class.disabled]="getPage(key) >= getTotalPages(total)">
              <button class="page-link" type="button" (click)="setPage(key, getPage(key) + 1, total)">¬ª</button>
            </li>
          </ul>
        </nav>
      </div>
    </ng-template>

    <ng-container *ngIf="mode === 'scheduling'; else otherLayouts">
      <ng-template #slotsTable>
        <div class="d-flex align-items-center justify-content-between mb-3" *ngIf="!isDoctor">
          <h5 class="fw-semibold mb-0">Slot disponibili</h5>
          <button class="btn btn-outline-secondary btn-sm" (click)="loadScheduling()" [disabled]="isLoading">
            Aggiorna
          </button>
        </div>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Struttura</th>
                <th>Medico</th>
                <th>Reparto</th>
                <th>Data e ora</th>
                <th>Modalit√†</th>
                <th>Note</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let slot of visibleSlots | slice:getPageSliceStart('slots'):getPageSliceEnd('slots')">
                <td>{{ getFacilityLabel(getDoctorById(slot.doctorId)?.facilityCode || '-') }}</td>
                <td>{{ getDoctorLabel(slot.doctorId) }}</td>
                <td>{{ getDepartmentLabel(getDoctorById(slot.doctorId)?.departmentCode || '-') }}</td>
                <td>{{ formatDate(slot.date) }} ‚Ä¢ {{ slot.time }}</td>
                <td>{{ getModalityLabel(slot.modality) }}</td>
                <td>{{ slot.notes || '-' }}</td>
              </tr>
              <tr *ngIf="!visibleSlots.length">
                <td colspan="6" class="text-center text-muted">Nessuna disponibilit√† attiva.</td>
              </tr>
            </tbody>
          </table>
          <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'slots', total: visibleSlots.length }"></ng-container>
        </div>
      </ng-template>

      <div class="row g-4">
        <ng-container *ngIf="!isDoctor; else doctorAgenda">
          <div class="col-lg-12" *ngIf="!isPatient">
            <div class="accordion" id="availableSlotsAccordion">
              <div class="accordion-item card-glass border-0">
                <h2 class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#availableSlotsCollapse"
                    aria-expanded="false"
                    aria-controls="availableSlotsCollapse">
                    Consulta le disponibilit√† attualmente offerte dalla struttura
                  </button>
                </h2>
                <div
                  id="availableSlotsCollapse"
                  class="accordion-collapse collapse"
                  data-bs-parent="#availableSlotsAccordion">
                  <div class="accordion-body">
                    <ng-container *ngTemplateOutlet="slotsTable"></ng-container>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <ng-container *ngIf="showBookingModal">
            <div
              class="modal-backdrop fade show"
              style="position: fixed; inset: 0; z-index: 1050;"
              (click)="closeBookingModal()"></div>
            <div
              class="modal d-flex align-items-center justify-content-center"
              role="dialog"
              aria-modal="true"
              aria-labelledby="newBookingModalTitle"
              style="position: fixed; inset: 0; z-index: 1055;">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="newBookingModalTitle">Nuova prenotazione</h5>
                    <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeBookingModal()"></button>
                  </div>
                  <div class="modal-body">
                    <form (ngSubmit)="submitBooking()" #bookingFormRef="ngForm">
                      <div class="mb-3">
                        <label class="form-label">Reparto</label>
                        <select
                          class="form-select"
                          name="bookingDepartment"
                          [(ngModel)]="bookingForm.department"
                          (ngModelChange)="bookingForm.slotId = null"
                          required>
                          <option value="" disabled>Seleziona un reparto</option>
                          <option *ngFor="let department of departments" [value]="department.code">
                            {{ department.name }}
                          </option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Slot disponibili</label>
                        <select class="form-select" name="slotId" [(ngModel)]="bookingForm.slotId" required>
                          <option [ngValue]="null" disabled>Seleziona uno slot</option>
                          <option *ngFor="let slot of availableSlots" [ngValue]="slot.id">
                            {{ getSlotLabel(slot) }}
                          </option>
                        </select>
                        <div class="form-text">La disponibilit√† selezionata include medico, data e ora.</div>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Motivo prenotazione</label>
                        <textarea class="form-control" rows="3" name="reason" [(ngModel)]="bookingForm.reason" required></textarea>
                      </div>
                      <div class="alert alert-danger py-2" *ngIf="schedulingError">{{ schedulingError }}</div>
                      <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-outline-secondary" type="button" (click)="closeBookingModal()">Annulla</button>
                        <button class="btn btn-primary" type="submit" [disabled]="bookingFormRef.invalid || isLoading">
                          {{ isLoading ? 'Salvataggio...' : 'Prenota appuntamento' }}
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </ng-container>

        <ng-template #doctorAgenda>
          <div class="col-lg-12">
            <div class="card card-glass">
              <div class="card-body">
                <h5 class="fw-semibold mb-3">Prossimi appuntamenti ricevuti</h5>
                <div class="mb-3" *ngIf="isDoctor">
                  <p class="text-muted small mb-2">Filtra gli appuntamenti selezionando un paziente specifico.</p>
                  <label class="form-label">Paziente</label>
                  <select class="form-select" name="appointmentPatientFilter" [(ngModel)]="appointmentPatientFilterId">
                    <option [ngValue]="null">Tutti i pazienti</option>
                    <option *ngFor="let patient of patients" [ngValue]="patient.id">
                      {{ patient.firstName }} {{ patient.lastName }}
                    </option>
                  </select>
                </div>
                <div class="table-responsive mt-2">
                  <table class="table align-middle">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Reparto</th>
                        <th>Paziente</th>
                        <th>Data e ora</th>
                        <th>Modalit√†</th>
                        <th>Stato</th>
                        <th>Azioni</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let appointment of filteredDoctorReceivedAppointments | slice:getPageSliceStart('appointmentsDoctor'):getPageSliceEnd('appointmentsDoctor')">
                        <td>{{ appointment.id }}</td>
                        <td>{{ getDepartmentLabel(getDoctorById(appointment.doctorId)?.departmentCode || '-') }}</td>
                        <td>{{ getPatientLabel(appointment.patientId) }}</td>
                        <td>
                          {{ formatDate(getSlotById(appointment.slotId)?.date || '') }} ‚Ä¢
                          {{ getSlotById(appointment.slotId)?.time || '-' }}
                        </td>
                        <td>{{ getModalityLabel(getSlotById(appointment.slotId)?.modality || 'IN_PERSON') }}</td>
                        <td>{{ getAppointmentStatusLabel(appointment.status) }}</td>
                        <td>
                          <button
                            class="btn btn-outline-success btn-sm me-2"
                            type="button"
                            aria-label="Conferma appuntamento"
                            title="Conferma appuntamento"
                            (click)="confirmAppointment(appointment)"
                            [disabled]="appointment.status === 'CONFIRMED' || appointment.status === 'REJECTED'">
                            ‚úÖ
                          </button>
                          <button
                            class="btn btn-outline-danger btn-sm"
                            type="button"
                            aria-label="Rifiuta appuntamento"
                            title="Rifiuta appuntamento"
                            (click)="openAppointmentRejectModal(appointment)"
                            [disabled]="appointment.status === 'CONFIRMED' || appointment.status === 'REJECTED'">
                            ‚ùå
                          </button>
                        </td>
                      </tr>
                      <tr *ngIf="!filteredDoctorReceivedAppointments.length">
                        <td colspan="7" class="text-center text-muted">Nessun appuntamento ricevuto.</td>
                      </tr>
                    </tbody>
                  </table>
                  <ng-container
                    *ngTemplateOutlet="paginationFooter; context: { key: 'appointmentsDoctor', total: filteredDoctorReceivedAppointments.length }">
                  </ng-container>
                </div>
              </div>
            </div>
          </div>
        </ng-template>

        <div class="col-12" *ngIf="isDoctor">
          <p class="text-muted mb-0">
            Qui puoi gestire gli appuntamenti disponibili che i pazienti potranno prenotare in agenda.
          </p>
        </div>

        <ng-container *ngIf="isPatient; else doctorScheduling">
          <div class="col-12">
            <div class="card card-glass">
              <div class="card-body">
                <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
                  <h5 class="fw-semibold mb-0">Appuntamenti prenotati</h5>
                  <div class="d-flex flex-wrap gap-2">
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      type="button"
                      (click)="loadScheduling()"
                      [disabled]="isLoading">
                      Aggiorna
                    </button>
                    <button
                      class="btn btn-outline-primary btn-sm"
                      type="button"
                      (click)="openBookingModal()">
                      Nuova prenotazione
                    </button>
                  </div>
                </div>
                <div *ngIf="appointmentsLoadError" class="alert alert-danger mt-2 mb-0" role="alert">
                  {{ appointmentsLoadError }}
                </div>
                <div class="table-responsive mt-2">
                  <table class="table align-middle">
                    <thead>
                      <tr>
                        <th>Reparto</th>
                        <th>Nome del medico</th>
                        <th>Data e ora</th>
                        <th>Motivo</th>
                        <th>Stato</th>
                        <th>Azioni</th>
                      </tr>
                    </thead>
                    <tbody>
                      <ng-container *ngFor="let appointment of appointments | slice:getPageSliceStart('appointments'):getPageSliceEnd('appointments')">
                        <tr>
                          <td>{{ getDepartmentLabel(getDoctorById(appointment.doctorId)?.departmentCode || '-') }}</td>
                          <td>{{ getDoctorLabel(appointment.doctorId) }}</td>
                          <td>
                            {{ formatDate(getSlotById(appointment.slotId)?.date || '') }} ‚Ä¢
                            {{ getSlotById(appointment.slotId)?.time || '-' }}
                          </td>
                          <td>{{ appointment.reason }}</td>
                          <td>
                            <span>{{ getStatusLabel(appointment.status) }}</span>
                          </td>
                          <td>
                            <button
                              class="btn btn-outline-danger btn-sm me-2"
                              type="button"
                              aria-label="Elimina appuntamento"
                              title="Elimina appuntamento"
                              [disabled]="appointment.status !== 'PENDING' && appointment.status !== 'IN_ATTESA'"
                              (click)="openDeleteAppointmentConfirm(appointment)">
                              üóëÔ∏è
                            </button>
                            <button
                              class="btn btn-outline-danger btn-sm me-2"
                              type="button"
                              aria-label="Rifiuta appuntamento"
                              title="Rifiuta appuntamento"
                              (click)="openAppointmentRejectModal(appointment)"
                              [disabled]="appointment.status === 'CONFIRMED' || appointment.status === 'REJECTED'">
                              ‚ùå
                            </button>
                            <button
                              class="btn btn-outline-secondary btn-sm"
                              type="button"
                              aria-label="Riprogramma appuntamento"
                              title="Riprogramma appuntamento"
                              [disabled]="appointment.status !== 'CONFIRMED' || !isAppointmentReschedulable(appointment)"
                              (click)="openAppointmentRescheduleModal(appointment)">
                              üîÑ
                            </button>
                          </td>
                        </tr>
                      </ng-container>
                      <tr *ngIf="!appointments.length && !appointmentsLoadError">
                        <td colspan="6" class="text-center text-muted">Nessun appuntamento registrato.</td>
                      </tr>
                    </tbody>
                  </table>
                    <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'appointments', total: appointments.length }"></ng-container>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-container *ngIf="showAppointmentRescheduleModal">
          <div
            class="modal-backdrop fade show"
            style="position: fixed; inset: 0; z-index: 1050;"
            (click)="closeAppointmentRescheduleModal()"></div>
          <div
            class="modal d-flex align-items-center justify-content-center"
            role="dialog"
            aria-modal="true"
            aria-labelledby="appointmentRescheduleModalTitle"
            style="position: fixed; inset: 0; z-index: 1055;">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="appointmentRescheduleModalTitle">Ripianifica appuntamento</h5>
                  <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeAppointmentRescheduleModal()"></button>
                </div>
                <div class="modal-body">
                  <form (ngSubmit)="submitAppointmentReschedule()" #appointmentRescheduleRef="ngForm">
                    <div class="mb-3">
                      <label class="form-label">Nuova data</label>
                      <input class="form-control" type="date" name="appointmentRescheduleDate" [(ngModel)]="rescheduleAppointmentDate" required />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Motivazione</label>
                      <textarea class="form-control" rows="3" name="appointmentRescheduleReason" [(ngModel)]="rescheduleAppointmentReason" required></textarea>
                    </div>
                    <div class="alert alert-danger py-2" *ngIf="schedulingError">{{ schedulingError }}</div>
                    <div class="d-flex justify-content-end gap-2">
                      <button class="btn btn-outline-secondary" type="button" (click)="closeAppointmentRescheduleModal()">Annulla</button>
                      <button class="btn btn-primary" type="submit" [disabled]="appointmentRescheduleRef.invalid || isLoading">
                        Invia richiesta
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-container *ngIf="showAppointmentRejectModal">
          <div
            class="modal-backdrop fade show"
            style="position: fixed; inset: 0; z-index: 1050;"
            (click)="closeAppointmentRejectModal()"></div>
          <div
            class="modal d-flex align-items-center justify-content-center"
            role="dialog"
            aria-modal="true"
            aria-labelledby="appointmentRejectModalTitle"
            style="position: fixed; inset: 0; z-index: 1055;">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="appointmentRejectModalTitle">Rifiuta appuntamento</h5>
                  <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeAppointmentRejectModal()"></button>
                </div>
                <div class="modal-body">
                  <form (ngSubmit)="submitAppointmentRejection()" #appointmentRejectRef="ngForm">
                    <div class="mb-3">
                      <label class="form-label">Motivazione</label>
                      <textarea class="form-control" rows="3" name="appointmentRejectReason" [(ngModel)]="rejectAppointmentReason" required></textarea>
                    </div>
                    <div class="alert alert-danger py-2" *ngIf="schedulingError">{{ schedulingError }}</div>
                    <div class="d-flex justify-content-end gap-2">
                      <button class="btn btn-outline-secondary" type="button" (click)="closeAppointmentRejectModal()">Annulla</button>
                      <button class="btn btn-danger" type="submit" [disabled]="appointmentRejectRef.invalid || isLoading">
                        Rifiuta appuntamento
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-container *ngIf="showSlotModal">
          <div
            class="modal-backdrop fade show"
            style="position: fixed; inset: 0; z-index: 1050;"
            (click)="closeSlotModal()"></div>
          <div
            class="modal d-flex align-items-center justify-content-center"
            role="dialog"
            aria-modal="true"
            aria-labelledby="slotModalTitle"
            style="position: fixed; inset: 0; z-index: 1055;">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="slotModalTitle">Nuovo slot disponibile</h5>
                  <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeSlotModal()"></button>
                </div>
                <div class="modal-body">
                  <form (ngSubmit)="submitSlot()" #slotFormRef="ngForm">
                    <div class="mb-3">
                      <label class="form-label">Data</label>
                      <input class="form-control" type="date" name="slotDate" [(ngModel)]="slotForm.date" required />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Ora</label>
                      <input class="form-control" type="time" name="slotTime" [(ngModel)]="slotForm.time" required />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Modalit√†</label>
                      <select class="form-select" name="slotModality" [(ngModel)]="slotForm.modality" required>
                        <option [ngValue]="'IN_PERSON'">In presenza</option>
                        <option [ngValue]="'REMOTE'">Da remoto (televisita)</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Note</label>
                      <textarea class="form-control" rows="3" name="slotNotes" [(ngModel)]="slotForm.notes" placeholder="Inserisci note per il paziente"></textarea>
                    </div>
                    <div class="alert alert-danger py-2" *ngIf="schedulingError">{{ schedulingError }}</div>
                    <div class="d-flex justify-content-end gap-2">
                      <button class="btn btn-outline-secondary" type="button" (click)="closeSlotModal()">Annulla</button>
                      <button class="btn btn-primary" type="submit" [disabled]="slotFormRef.invalid || isLoading">
                        {{ isLoading ? 'Salvataggio...' : 'Salva slot' }}
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #doctorScheduling>
          <div class="col-12">
            <div class="card card-glass">
              <div class="card-body">
                <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
                  <h5 class="fw-semibold mb-0">Appuntamenti disponibili</h5>
                  <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-secondary btn-sm" (click)="loadScheduling()" [disabled]="isLoading">
                      Aggiorna
                    </button>
                    <button class="btn btn-outline-primary btn-sm" type="button" (click)="openSlotModal()">
                      Nuovo appuntamento disponibile
                    </button>
                  </div>
                </div>
                <ng-container *ngTemplateOutlet="slotsTable"></ng-container>
              </div>
            </div>
          </div>
        </ng-template>
      </div>
    </ng-container>

    <ng-template #otherLayouts>
      <ng-container *ngIf="mode === 'docs'; else paymentsLayout">
        <div class="row g-4">
          <div class="col-12">
            <div class="card card-glass mb-4">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                  <h5 class="fw-semibold mb-0">Documenti clinici</h5>
                  <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-secondary btn-sm" (click)="loadDocs()" [disabled]="isLoading">
                      Aggiorna
                    </button>
                    <button class="btn btn-primary btn-sm" type="button" (click)="openDocumentModal()" *ngIf="!isPatient">
                      Carica documento
                    </button>
                  </div>
                </div>
                <div class="mb-3" *ngIf="isDoctor">
                  <p class="text-muted small mb-2">Filtra i documenti selezionando un paziente specifico.</p>
                  <label class="form-label">Paziente</label>
                  <select class="form-select" name="docFilterPatient" [(ngModel)]="docFilterPatientId">
                    <option [ngValue]="null">Tutti i pazienti</option>
                    <option *ngFor="let patient of patients" [ngValue]="patient.id">
                      {{ patient.firstName }} {{ patient.lastName }}
                    </option>
                  </select>
                </div>
                <div class="table-responsive mt-2">
                  <table class="table align-middle">
                    <thead>
                      <tr>
                        <th *ngIf="isDoctor">Paziente</th>
                        <th>Tipo</th>
                        <th>Nome</th>
                        <th>Note</th>
                        <th>Caricato da</th>
                        <th>Data e ora</th>
                        <th>Azioni</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let doc of filteredDocuments | slice:getPageSliceStart('documents'):getPageSliceEnd('documents')">
                        <td *ngIf="isDoctor">{{ getPatientLabel(doc.patientId) }}</td>
                        <td>{{ getDocumentTypeLabel(doc.type) }}</td>
                        <td>{{ doc.name }}</td>
                        <td>{{ doc.notes || '-' }}</td>
                        <td>{{ getDocumentUploaderLabel(doc) }}</td>
                        <td>{{ formatDateTime(doc.uploadedAt) }}</td>
                        <td>
                          <button
                            class="btn btn-outline-secondary btn-sm me-2"
                            type="button"
                            aria-label="Visualizza documento"
                            title="Visualizza documento"
                            (click)="viewDocument(doc)">
                            üëÅÔ∏è
                          </button>
                          <button
                            class="btn btn-outline-danger btn-sm"
                            type="button"
                            aria-label="Elimina documento"
                            title="Elimina documento"
                            (click)="openDeleteDocumentConfirm(doc)"
                            [disabled]="!isDocumentDeletable(doc)">
                            üóëÔ∏è
                          </button>
                        </td>
                      </tr>
                      <tr *ngIf="!filteredDocuments.length">
                        <td [attr.colspan]="isDoctor ? 7 : 6" class="text-center text-muted">Nessun documento presente.</td>
                      </tr>
                    </tbody>
                  </table>
                    <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'documents', total: filteredDocuments.length }"></ng-container>
                  </div>
                </div>
              </div>

            <div class="card card-glass">
              <div class="card-body">
                <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
                  <h5 class="fw-semibold mb-0">Consensi informati</h5>
                  <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-secondary btn-sm" type="button" (click)="loadDocs()" [disabled]="isLoading">
                      Aggiorna
                    </button>
                    <button class="btn btn-outline-primary btn-sm" type="button" (click)="openConsentModal()" *ngIf="isPatient">
                      Registra consenso
                    </button>
                  </div>
                </div>
                <div class="mb-3" *ngIf="isDoctor">
                  <p class="text-muted small mb-2">Filtra i consensi selezionando un paziente specifico.</p>
                  <label class="form-label">Paziente</label>
                  <select class="form-select" name="consentPatientFilter" [(ngModel)]="consentPatientFilterId">
                    <option [ngValue]="null">Tutti i pazienti</option>
                    <option *ngFor="let patient of patients" [ngValue]="patient.id">
                      {{ patient.firstName }} {{ patient.lastName }}
                    </option>
                  </select>
                </div>
                <div class="table-responsive mt-2">
                  <table class="table align-middle">
                    <thead>
                      <tr>
                        <th *ngIf="isDoctor">Paziente</th>
                        <th>Tipo</th>
                        <th>Accettato</th>
                        <th>Data firma</th>
                        <th *ngIf="isPatient">Azioni</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let consent of filteredConsents | slice:getPageSliceStart('consents'):getPageSliceEnd('consents')">
                        <td *ngIf="isDoctor">{{ getPatientLabel(consent.patientId) }}</td>
                        <td>{{ getConsentTypeLabel(consent.consentType) }}</td>
                        <td>{{ consent.accepted ? 'Si' : 'No' }}</td>
                        <td>{{ formatDate(consent.signedAt) }}</td>
                        <td *ngIf="isPatient">
                          <button
                            class="btn btn-outline-danger btn-sm"
                            type="button"
                            aria-label="Elimina consenso"
                            title="Elimina consenso"
                            (click)="openDeleteConsentConfirm(consent)">
                            üóëÔ∏è
                          </button>
                          <button
                            class="btn btn-outline-secondary btn-sm ms-2"
                            type="button"
                            aria-label="Modifica consenso"
                            title="Modifica consenso"
                            (click)="editConsent(consent)">
                            ‚úèÔ∏è
                          </button>
                        </td>
                      </tr>
                      <tr *ngIf="!filteredConsents.length">
                        <td [attr.colspan]="4" class="text-center text-muted">Nessun consenso registrato.</td>
                      </tr>
                    </tbody>
                  </table>
                  <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'consents', total: filteredConsents.length }"></ng-container>
                </div>
              </div>
            </div>
          </div>

        </div>

        <ng-container *ngIf="showDocumentModal">
          <div
            class="modal-backdrop fade show"
            style="position: fixed; inset: 0; z-index: 1050;"
            (click)="closeDocumentModal()"></div>
          <div
            class="modal d-flex align-items-center justify-content-center"
            role="dialog"
            aria-modal="true"
            aria-labelledby="uploadDocumentModalTitle"
            style="position: fixed; inset: 0; z-index: 1055;">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="uploadDocumentModalTitle">Carica documento</h5>
                  <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeDocumentModal()"></button>
                </div>
                <div class="modal-body">
                  <form (ngSubmit)="submitDocument()" #docFormRef="ngForm">
                    <div class="mb-3" *ngIf="isDoctor">
                      <label class="form-label">Paziente</label>
                      <select class="form-select" name="docPatientId" [(ngModel)]="docForm.patientId" required>
                        <option [ngValue]="null" disabled>Seleziona un paziente</option>
                        <option *ngFor="let patient of patients" [ngValue]="patient.id">
                          {{ patient.firstName }} {{ patient.lastName }}
                        </option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Tipo documento</label>
                      <select class="form-select" name="docType" [(ngModel)]="docForm.type" required>
                        <option value="REFERT">Referto</option>
                        <option value="CERTIFICATE">Certificato</option>
                        <option value="GENERIC">Documento generico</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Documento</label>
                      <input class="form-control" type="file" name="docFile" (change)="handleDocumentFileSelected($event)" />
                      <div class="form-text" *ngIf="docForm.fileName">Selezionato: {{ docForm.fileName }}</div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Nome documento</label>
                      <input class="form-control" type="text" name="docName" [(ngModel)]="docForm.name" required />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Note</label>
                      <textarea class="form-control" rows="2" name="docNotes" [(ngModel)]="docForm.notes"></textarea>
                    </div>
                    <div class="alert alert-danger py-2" *ngIf="docsError">{{ docsError }}</div>
                    <div class="d-flex justify-content-end gap-2">
                      <button class="btn btn-outline-secondary" type="button" (click)="closeDocumentModal()">Annulla</button>
                      <button class="btn btn-primary" type="submit" [disabled]="docFormRef.invalid || isLoading">
                        {{ isLoading ? 'Salvataggio...' : 'Carica documento' }}
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-container *ngIf="showConsentModal">
          <div
            class="modal-backdrop fade show"
            style="position: fixed; inset: 0; z-index: 1050;"
            (click)="closeConsentModal()"></div>
          <div
            class="modal d-flex align-items-center justify-content-center"
            role="dialog"
            aria-modal="true"
            aria-labelledby="registerConsentModalTitle"
            style="position: fixed; inset: 0; z-index: 1055;">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="registerConsentModalTitle">Registra consenso</h5>
                  <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeConsentModal()"></button>
                </div>
                <div class="modal-body">
                  <form (ngSubmit)="submitConsent()" #consentFormRef="ngForm">
                    <div class="mb-3">
                      <label class="form-label">Tipo consenso</label>
                      <select class="form-select" name="consentType" [(ngModel)]="consentForm.consentType" required>
                        <option value="GDPR">GDPR</option>
                        <option value="PRIVACY">Privacy</option>
                        <option value="THERAPY">Consenso terapia</option>
                      </select>
                    </div>
                    <div class="form-check mb-3">
                      <input class="form-check-input" type="checkbox" id="consentAcceptedModal" name="consentAccepted" [(ngModel)]="consentForm.accepted" />
                      <label class="form-check-label" for="consentAcceptedModal">Consenso accettato</label>
                    </div>
                    <div class="alert alert-danger py-2" *ngIf="docsError">{{ docsError }}</div>
                    <div class="d-flex justify-content-end gap-2">
                      <button class="btn btn-outline-secondary" type="button" (click)="closeConsentModal()">Annulla</button>
                      <button class="btn btn-outline-primary" type="submit" [disabled]="consentFormRef.invalid || isLoading">
                        {{ isLoading ? 'Salvataggio...' : 'Salva consenso' }}
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

      </ng-container>

      <ng-template #paymentsLayout>
        <ng-container *ngIf="mode === 'payments'; else admissionsLayout">
          <ng-container *ngIf="!isDoctor; else doctorPaymentsHidden">
            <div class="row g-4">
              <div class="col-12">
                <div class="card card-glass">
                  <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                      <h5 class="fw-semibold mb-0">Pagamenti</h5>
                      <button class="btn btn-outline-secondary btn-sm" (click)="loadPayments()" [disabled]="isLoading">
                        Aggiorna
                      </button>
                    </div>
                    <div class="alert alert-success py-2" *ngIf="paymentsSuccess">{{ paymentsSuccess }}</div>
                    <div class="alert alert-danger py-2" *ngIf="paymentsError">{{ paymentsError }}</div>
                    <div class="table-responsive">
                      <table class="table align-middle">
                        <thead>
                          <tr>
                            <th *ngIf="!isPatient">Paziente</th>
                            <th>Prestazione</th>
                            <th>Importo</th>
                            <th>Valuta</th>
                            <th>Ricevuta</th>
                            <th>Stato</th>
                            <th>Data</th>
                            <th>Azioni</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngIf="isPatient && latestConfirmedAdmission">
                            <td>{{ getAdmissionPaymentLabel(latestConfirmedAdmission) }}</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>Pagamento in attesa</td>
                            <td>{{ formatDate(latestConfirmedAdmission.admittedAt) }}</td>
                            <td>
                              <button
                                class="btn btn-outline-primary btn-sm me-2"
                                type="button"
                                aria-label="Registra pagamento"
                                title="Registra pagamento"
                                disabled>
                                üí≥
                              </button>
                              <button
                                class="btn btn-outline-secondary btn-sm me-2"
                                type="button"
                                aria-label="Allega ricevuta"
                                title="Allega ricevuta"
                                disabled>
                                üìé
                              </button>
                            </td>
                          </tr>
                          <tr *ngFor="let payment of payments | slice:getPageSliceStart('payments'):getPageSliceEnd('payments')">
                            <td *ngIf="!isPatient">{{ getPatientLabel(payment.patientId) }}</td>
                            <td>{{ payment.service }}</td>
                            <td>{{ payment.amount }}</td>
                            <td>{{ getCurrencyLabel(payment.currency) }}</td>
                            <td>{{ payment.receiptName ? 'Caricata' : '-' }}</td>
                            <td>{{ getPaymentStatusLabel(payment) }}</td>
                            <td>{{ formatDate(payment.paidAt) }}</td>
                            <td>
                            <button
                              class="btn btn-outline-primary btn-sm me-2"
                              type="button"
                              aria-label="Registra pagamento"
                              title="Registra pagamento"
                              [disabled]="!canMarkPaymentAsPaid(payment)"
                              (click)="markPaymentAsPaid(payment)">
                              üí≥
                            </button>
                            <button
                              class="btn btn-outline-info btn-sm me-2"
                              type="button"
                              aria-label="Domanda alla struttura"
                              title="Domanda alla struttura"
                              (click)="openPaymentQuestionModal(payment)">
                              ‚ùì
                            </button>
                            <input
                              class="d-none"
                              type="file"
                              #receiptInput
                              (change)="onPaymentReceiptSelected($event, payment)" />
                            <button
                              class="btn btn-outline-secondary btn-sm me-2"
                              type="button"
                              aria-label="Allega ricevuta"
                              title="Allega ricevuta"
                              [disabled]="!canAttachPaymentReceipt(payment)"
                              (click)="openPaymentReceiptUpload(payment, receiptInput)">
                              üìé
                            </button>
                          </td>
                        </tr>
                          <tr *ngIf="!payments.length && !(isPatient && latestConfirmedAdmission)">
                            <td [attr.colspan]="isPatient ? 7 : 8" class="text-center text-muted">Nessun pagamento registrato.</td>
                          </tr>
                        </tbody>
                      </table>
                      <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'payments', total: payments.length }"></ng-container>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
          <ng-template #doctorPaymentsHidden>
            <div class="card card-glass">
              <div class="card-body">
                <div class="alert alert-info mb-0">
                  I pagamenti non sono disponibili nell'area medico.
                </div>
              </div>
            </div>
          </ng-template>
        </ng-container>
      </ng-template>

      <ng-container *ngIf="showPaymentQuestionModal">
        <div
          class="modal-backdrop fade show"
          style="position: fixed; inset: 0; z-index: 1050;"
          (click)="closePaymentQuestionModal()"></div>
        <div
          class="modal d-flex align-items-center justify-content-center"
          role="dialog"
          aria-modal="true"
          aria-labelledby="paymentQuestionModalTitle"
          style="position: fixed; inset: 0; z-index: 1055;">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="paymentQuestionModalTitle">Domanda alla struttura</h5>
                <button type="button" class="btn-close" aria-label="Chiudi" (click)="closePaymentQuestionModal()"></button>
              </div>
              <div class="modal-body">
                <form (ngSubmit)="submitPaymentQuestion()" #paymentQuestionRef="ngForm">
                  <div class="mb-3">
                    <label class="form-label">Messaggio</label>
                    <textarea class="form-control" rows="3" name="paymentQuestion" [(ngModel)]="paymentQuestion" required></textarea>
                  </div>
                  <div class="alert alert-danger py-2" *ngIf="paymentsError">{{ paymentsError }}</div>
                  <div class="d-flex justify-content-end gap-2">
                    <button class="btn btn-outline-secondary" type="button" (click)="closePaymentQuestionModal()">Annulla</button>
                    <button class="btn btn-primary" type="submit" [disabled]="paymentQuestionRef.invalid || isLoading">
                      Invia richiesta
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <div
        class="modal d-block"
        role="dialog"
        aria-modal="true"
        aria-labelledby="newBookingModalTitle"
        *ngIf="showBookingModal">
            <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="newBookingModalTitle">Nuova prenotazione</h5>
              <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeBookingModal()"></button>
            </div>
            <div class="modal-body">
              <form (ngSubmit)="submitBooking()" #bookingFormRef="ngForm">
                <div class="mb-3">
                  <label class="form-label">Reparto</label>
                  <select
                    class="form-select"
                    name="bookingDepartment"
                    [(ngModel)]="bookingForm.department"
                    (ngModelChange)="bookingForm.slotId = null"
                    required>
                    <option value="" disabled>Seleziona un reparto</option>
                    <option *ngFor="let department of departments" [value]="department.code">
                      {{ department.name }}
                    </option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Slot disponibili</label>
                  <select class="form-select" name="slotId" [(ngModel)]="bookingForm.slotId" required>
                    <option [ngValue]="null" disabled>Seleziona uno slot</option>
                    <option *ngFor="let slot of availableSlots" [ngValue]="slot.id">
                      {{ getSlotLabel(slot) }}
                    </option>
                  </select>
                  <div class="form-text">La disponibilit√† selezionata include medico, data e ora.</div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Motivo prenotazione</label>
                  <textarea class="form-control" rows="3" name="reason" [(ngModel)]="bookingForm.reason" required></textarea>
                </div>
                <div class="alert alert-danger py-2" *ngIf="schedulingError">{{ schedulingError }}</div>
                <div class="d-flex justify-content-end gap-2">
                  <button class="btn btn-outline-secondary" type="button" (click)="closeBookingModal()">Annulla</button>
                  <button class="btn btn-primary" type="submit" [disabled]="bookingFormRef.invalid || isLoading">
                    {{ isLoading ? 'Salvataggio...' : 'Prenota appuntamento' }}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="modal-backdrop fade show" (click)="closeBookingModal()"></div>
      </div>

      <ng-template #admissionsLayout>
        <ng-container *ngIf="mode === 'admissions'; else notificationsLayout">
          <div class="row g-4">
            <div class="col-12">
              <div class="card card-glass">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="fw-semibold mb-0">{{ isDoctor ? 'Ricoveri pazienti' : 'Ricoveri' }}</h5>
                    <div class="d-flex gap-2">
                      <button
                        *ngIf="isDoctor"
                        class="btn btn-outline-primary btn-sm"
                        type="button"
                        (click)="openAdmissionProposalModal()">
                        Proponi ricovero
                      </button>
                      <button class="btn btn-outline-secondary btn-sm" (click)="loadAdmissions()" [disabled]="isLoading">
                        Aggiorna
                      </button>
                    </div>
                  </div>
                  <div class="mb-3" *ngIf="isDoctor">
                    <p class="text-muted small mb-2">Filtra i ricoveri selezionando un paziente specifico.</p>
                    <label class="form-label">Paziente</label>
                    <select class="form-select" name="admissionPatientFilter" [(ngModel)]="admissionPatientFilterId">
                      <option [ngValue]="null">Tutti i pazienti</option>
                      <option *ngFor="let patient of patients" [ngValue]="patient.id">
                        {{ patient.firstName }} {{ patient.lastName }}
                      </option>
                    </select>
                  </div>
                  <div class="table-responsive mt-2">
                    <table class="table align-middle">
                      <thead>
                        <tr>
                          <th *ngIf="!isPatient">Paziente</th>
                          <th>Reparto</th>
                          <th>Tipo</th>
                          <th>Data ricovero</th>
                          <th>Stato</th>
                          <th>Note</th>
                          <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let admission of filteredAdmissions | slice:getPageSliceStart('admissions'):getPageSliceEnd('admissions')">
                          <td *ngIf="!isPatient">{{ getPatientLabel(admission.patientId) }}</td>
                          <td>{{ getDepartmentLabel(admission.departmentCode) }}</td>
                          <td>{{ getAdmissionTypeLabel(admission.admissionType) }}</td>
                          <td>{{ formatDate(admission.admittedAt) }}</td>
                          <td>{{ getAdmissionStatusLabel(admission.status) }}</td>
                          <td>{{ admission.notes || '-' }}</td>
                          <td>
                            <ng-container *ngIf="isPatient; else admissionDoctorActions">
                              <button
                                class="btn btn-outline-primary btn-sm me-2"
                                type="button"
                                aria-label="Ripianifica ricovero"
                                title="Ripianifica ricovero"
                                (click)="openAdmissionRescheduleModal(admission)"
                                [disabled]="!isAdmissionReschedulable(admission)">
                                üîÑ
                              </button>
                            </ng-container>
                            <ng-template #admissionDoctorActions>
                              <button
                                class="btn btn-outline-secondary btn-sm"
                                type="button"
                                aria-label="Leggi commento paziente"
                                title="Leggi commento paziente"
                                (click)="openAdmissionNoteModal(admission)"
                                [disabled]="!admission.notes">
                                üí¨
                              </button>
                            </ng-template>
                          </td>
                        </tr>
                        <tr *ngIf="!filteredAdmissions.length">
                          <td [attr.colspan]="isPatient ? 6 : 7" class="text-center text-muted">Nessun ricovero registrato.</td>
                        </tr>
                      </tbody>
                    </table>
                    <div class="mt-3">
                      <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'admissions', total: filteredAdmissions.length }"></ng-container>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <ng-container *ngIf="showAdmissionRescheduleModal">
            <div
              class="modal-backdrop fade show"
              style="position: fixed; inset: 0; z-index: 1050;"
              (click)="closeAdmissionRescheduleModal()"></div>
            <div
              class="modal d-flex align-items-center justify-content-center"
              role="dialog"
              aria-modal="true"
              aria-labelledby="admissionRescheduleModalTitle"
              style="position: fixed; inset: 0; z-index: 1055;">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="admissionRescheduleModalTitle">Ripianifica ricovero</h5>
                    <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeAdmissionRescheduleModal()"></button>
                  </div>
                  <div class="modal-body">
                    <form (ngSubmit)="submitAdmissionReschedule()" #rescheduleFormRef="ngForm">
                      <div class="mb-3">
                        <label class="form-label">Nuova data ricovero</label>
                        <input class="form-control" type="date" name="rescheduleDate" [(ngModel)]="rescheduleForm.date" required />
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Motivazione</label>
                        <textarea class="form-control" rows="3" name="rescheduleReason" [(ngModel)]="rescheduleForm.reason" required></textarea>
                      </div>
                      <div class="alert alert-danger py-2" *ngIf="rescheduleError">{{ rescheduleError }}</div>
                      <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-outline-secondary" type="button" (click)="closeAdmissionRescheduleModal()">Annulla</button>
                        <button class="btn btn-primary" type="submit" [disabled]="rescheduleFormRef.invalid || isLoading">
                          Invia richiesta
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <ng-container *ngIf="showAdmissionNoteModal">
            <div
              class="modal-backdrop fade show"
              style="position: fixed; inset: 0; z-index: 1050;"
              (click)="closeAdmissionNoteModal()"></div>
            <div
              class="modal d-flex align-items-center justify-content-center"
              role="dialog"
              aria-modal="true"
              aria-labelledby="admissionNoteModalTitle"
              style="position: fixed; inset: 0; z-index: 1055;">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="admissionNoteModalTitle">Commento paziente</h5>
                    <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeAdmissionNoteModal()"></button>
                  </div>
                  <div class="modal-body">
                    <p class="mb-0">{{ admissionNoteTarget?.notes || 'Nessun commento disponibile.' }}</p>
                  </div>
                  <div class="modal-footer">
                    <button class="btn btn-outline-secondary" type="button" (click)="closeAdmissionNoteModal()">Chiudi</button>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <ng-container *ngIf="showAdmissionProposalModal">
            <div
              class="modal-backdrop fade show"
              style="position: fixed; inset: 0; z-index: 1050;"
              (click)="closeAdmissionProposalModal()"></div>
            <div
              class="modal d-flex align-items-center justify-content-center"
              role="dialog"
              aria-modal="true"
              aria-labelledby="admissionProposalModalTitle"
              style="position: fixed; inset: 0; z-index: 1055;">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="admissionProposalModalTitle">Proponi ricovero</h5>
                    <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeAdmissionProposalModal()"></button>
                  </div>
                  <div class="modal-body">
                    <form (ngSubmit)="submitAdmissionProposal()" #admissionProposalRef="ngForm">
                      <div class="mb-3">
                        <label class="form-label">Visita gi√† effettuata</label>
                        <select
                          class="form-select"
                          name="admissionProposalAppointmentId"
                          [(ngModel)]="admissionProposalForm.appointmentId"
                          required>
                          <option [ngValue]="null" disabled>Seleziona una visita conclusa</option>
                          <option *ngFor="let appointment of completedDoctorAppointments" [ngValue]="appointment.id">
                            {{ getPatientLabel(appointment.patientId) }} ‚Ä¢ {{ getAppointmentDateTimeLabel(appointment) }}
                          </option>
                        </select>
                        <div class="form-text" *ngIf="!completedDoctorAppointments.length">
                          Nessuna visita conclusa disponibile.
                        </div>
                      </div>

                      <div class="border rounded p-3 mb-3 bg-light-subtle" *ngIf="admissionProposalAppointment as appointment">
                        <div class="fw-semibold mb-2">Dettagli visita</div>
                        <div class="small text-muted">
                          <div>Paziente: <span class="text-body">{{ getPatientLabel(appointment.patientId) }}</span></div>
                          <div>Data e ora: <span class="text-body">{{ getAppointmentDateTimeLabel(appointment) }}</span></div>
                          <div>Motivo visita: <span class="text-body">{{ appointment.reason }}</span></div>
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Data proposta ricovero</label>
                        <input
                          class="form-control"
                          type="date"
                          name="admissionProposalDate"
                          [(ngModel)]="admissionProposalForm.date"
                          required />
                      </div>
                      <div class="mb-3 mt-3">
                        <label class="form-label">Motivazione proposta</label>
                        <textarea
                          class="form-control"
                          rows="3"
                          name="admissionProposalReason"
                          [(ngModel)]="admissionProposalForm.reason"
                          required></textarea>
                      </div>
                      <div class="alert alert-danger py-2" *ngIf="admissionProposalError">{{ admissionProposalError }}</div>
                      <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-outline-secondary" (click)="closeAdmissionProposalModal()">Annulla</button>
                        <button class="btn btn-primary" type="submit" [disabled]="admissionProposalRef.invalid">
                          Invia proposta
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <ng-container *ngIf="showAdmissionRejectModal">
            <div
              class="modal-backdrop fade show"
              style="position: fixed; inset: 0; z-index: 1050;"
              (click)="closeAdmissionRejectModal()"></div>
            <div
              class="modal d-flex align-items-center justify-content-center"
              role="dialog"
              aria-modal="true"
              aria-labelledby="admissionRejectModalTitle"
              style="position: fixed; inset: 0; z-index: 1055;">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="admissionRejectModalTitle">Rifiuta ricovero</h5>
                    <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeAdmissionRejectModal()"></button>
                  </div>
                  <div class="modal-body">
                    <form (ngSubmit)="submitAdmissionRejection()" #admissionRejectRef="ngForm">
                      <div class="mb-3">
                        <label class="form-label">Motivazione</label>
                        <textarea class="form-control" rows="3" name="admissionRejectReason" [(ngModel)]="rejectAdmissionReason" required></textarea>
                      </div>
                      <div class="alert alert-danger py-2" *ngIf="rescheduleError">{{ rescheduleError }}</div>
                      <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-outline-secondary" type="button" (click)="closeAdmissionRejectModal()">Annulla</button>
                        <button class="btn btn-danger" type="submit" [disabled]="admissionRejectRef.invalid || isLoading">
                          Rifiuta ricovero
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </ng-container>
      </ng-template>

      <ng-template #notificationsLayout>
        <ng-container *ngIf="mode === 'notifications'; else prescribingLayout">
          <div class="row g-4">
            <ng-container *ngIf="isPatient; else staffNotifications">
              <div class="col-12">
                <div class="card card-glass">
                  <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                      <h5 class="fw-semibold mb-0">Notifiche ricevute</h5>
                      <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary btn-sm" type="button" (click)="openNotificationContactsModal()">
                          Modifica contatti
                        </button>
                        <button class="btn btn-outline-primary btn-sm" type="button" (click)="openNotificationPreferencesModal()">
                          Modifica preferenze
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" (click)="loadNotifications()" [disabled]="isLoading">
                          Aggiorna
                        </button>
                      </div>
                    </div>
                    <div class="alert alert-success py-2 mt-2" *ngIf="notificationsSuccess">{{ notificationsSuccess }}</div>
                    <div class="alert alert-danger py-2 mt-2" *ngIf="notificationsError">{{ notificationsError }}</div>
                <div class="table-responsive mt-2">
                      <table class="table align-middle">
                        <thead>
                          <tr>
                            <th>Canale</th>
                            <th>Oggetto</th>
                            <th>Messaggio</th>
                            <th>Note</th>
                            <th>Data e ora</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let notification of notifications | slice:getPageSliceStart('notifications'):getPageSliceEnd('notifications')">
                            <td>{{ notification.channel }}</td>
                            <td>{{ notification.subject }}</td>
                            <td>{{ notification.message }}</td>
                            <td>{{ notification.notes || '-' }}</td>
                            <td>{{ formatDateTime(notification.sentAt) }}</td>
                          </tr>
                          <tr *ngIf="!notifications.length">
                            <td colspan="5" class="text-center text-muted">Nessuna notifica presente.</td>
                          </tr>
                        </tbody>
                      </table>
                      <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'notifications', total: notifications.length }"></ng-container>
                    </div>
                  </div>
                </div>
              </div>

              <ng-container *ngIf="showNotificationContactsModal">
                <div
                  class="modal-backdrop fade show"
                  style="position: fixed; inset: 0; z-index: 1050;"
                  (click)="closeNotificationContactsModal()"></div>
                <div
                  class="modal d-flex align-items-center justify-content-center"
                  role="dialog"
                  aria-modal="true"
                  aria-labelledby="notificationContactsModalTitle"
                  style="position: fixed; inset: 0; z-index: 1055;">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content shadow-lg border-0">
                      <div class="modal-header border-0 pb-0">
                        <div>
                          <h5 class="modal-title fw-bold" id="notificationContactsModalTitle">
                            <i class="bi bi-person-lines-fill me-2 text-primary"></i>
                            Modifica contatti
                          </h5>
                          <p class="text-muted small mb-0 mt-1">Aggiorna i tuoi recapiti per le notifiche</p>
                        </div>
                        <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeNotificationContactsModal()"></button>
                      </div>
                      <div class="modal-body pt-4">
                        <form (ngSubmit)="saveContactChanges()" #notificationContactsRef="ngForm">
                          <div class="alert alert-info border-0 py-2 mb-4">
                            <div class="d-flex">
                              <i class="bi bi-info-circle me-2 mt-1"></i>
                              <small>L'indirizzo email non √® modificabile perch√© corrisponde allo username utilizzato per accedere al portale. √à possibile modificare solo il numero di telefono.</small>
                            </div>
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-semibold small text-muted">Email</label>
                            <div class="input-group">
                              <span class="input-group-text bg-light border-end-0">
                                <i class="bi bi-envelope text-muted"></i>
                              </span>
                              <input class="form-control border-start-0 bg-light" type="email" name="notificationEmail" [value]="notificationPrefs.email" readonly disabled />
                            </div>
                          </div>
                          <div class="mb-4">
                            <label class="form-label fw-semibold small text-muted">Numero di telefono</label>
                            <div class="input-group">
                              <span class="input-group-text bg-light border-end-0">
                                <i class="bi bi-phone text-muted"></i>
                              </span>
                              <input class="form-control border-start-0" type="tel" name="notificationPhone" [(ngModel)]="notificationPrefs.phone" placeholder="+39 333 1234567" />
                            </div>
                          </div>
                          <div class="alert alert-success border-0 py-2" *ngIf="notificationsSuccess">
                            <i class="bi bi-check-circle me-2"></i>
                            {{ notificationsSuccess }}
                          </div>
                          <div class="alert alert-danger border-0 py-2" *ngIf="notificationsError">
                            <i class="bi bi-exclamation-circle me-2"></i>
                            {{ notificationsError }}
                          </div>
                        </form>
                      </div>
                      <div class="modal-footer border-0 pt-0">
                        <button class="btn btn-outline-secondary" type="button" (click)="closeNotificationContactsModal()">Annulla</button>
                        <button class="btn btn-primary" type="button" (click)="saveContactChanges()" [disabled]="isLoading">
                          <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-1"></span>
                          <i *ngIf="!isLoading" class="bi bi-check-circle me-1"></i>
                          {{ isLoading ? 'Salvataggio...' : 'Salva contatti' }}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>

              <ng-container *ngIf="showNotificationPreferencesModal">
                <div
                  class="modal-backdrop fade show"
                  style="position: fixed; inset: 0; z-index: 1050;"
                  (click)="closeNotificationPreferencesModal()"></div>
                <div
                  class="modal d-flex align-items-center justify-content-center"
                  role="dialog"
                  aria-modal="true"
                  aria-labelledby="notificationPreferencesModalTitle"
                  style="position: fixed; inset: 0; z-index: 1055;">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content shadow-lg border-0">
                      <div class="modal-header border-0 pb-0">
                        <div>
                          <h5 class="modal-title fw-bold" id="notificationPreferencesModalTitle">
                            <i class="bi bi-gear me-2 text-primary"></i>
                            Preferenze notifiche
                          </h5>
                          <p class="text-muted small mb-0 mt-1">Personalizza come ricevere le comunicazioni</p>
                        </div>
                        <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeNotificationPreferencesModal()"></button>
                      </div>
                      <div class="modal-body pt-4">
                        <form (ngSubmit)="saveNotificationPreferences()" #notificationPrefsRef="ngForm">
                          <div class="mb-4">
                            <label class="form-label fw-semibold small text-muted mb-3">
                              <i class="bi bi-broadcast me-1"></i>
                              Canali preferiti
                            </label>
                            <div class="row g-3">
                              <div class="col-6">
                                <div class="card h-100"
                                     [class.border-primary]="notificationPrefs.channels.email"
                                     [class.bg-primary]="notificationPrefs.channels.email"
                                     [class.bg-opacity-10]="notificationPrefs.channels.email"
                                     style="cursor: pointer;"
                                     (click)="notificationPrefs.channels.email = !notificationPrefs.channels.email">
                                  <div class="card-body text-center py-3">
                                    <i class="bi bi-envelope fs-4 mb-2" [class.text-primary]="notificationPrefs.channels.email"></i>
                                    <div class="fw-semibold">Email</div>
                                    <input class="form-check-input visually-hidden" type="checkbox" id="prefChannelEmail" name="prefChannelEmail" [(ngModel)]="notificationPrefs.channels.email" />
                                  </div>
                                </div>
                              </div>
                              <div class="col-6">
                                <div class="card h-100"
                                     [class.border-primary]="notificationPrefs.channels.sms"
                                     [class.bg-primary]="notificationPrefs.channels.sms"
                                     [class.bg-opacity-10]="notificationPrefs.channels.sms"
                                     style="cursor: pointer;"
                                     (click)="notificationPrefs.channels.sms = !notificationPrefs.channels.sms">
                                  <div class="card-body text-center py-3">
                                    <i class="bi bi-phone fs-4 mb-2" [class.text-primary]="notificationPrefs.channels.sms"></i>
                                    <div class="fw-semibold">SMS</div>
                                    <input class="form-check-input visually-hidden" type="checkbox" id="prefChannelSms" name="prefChannelSms" [(ngModel)]="notificationPrefs.channels.sms" />
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          <hr class="my-4">
                          <div class="mb-4">
                            <label class="form-label fw-semibold small text-muted mb-3">
                              <i class="bi bi-bell me-1"></i>
                              Tipologie di notifica
                            </label>
                            <div class="list-group list-group-flush">
                              <label class="list-group-item d-flex align-items-center border-0 px-0 py-2" for="prefTypeAppointments">
                                <input class="form-check-input me-3 flex-shrink-0" type="checkbox" id="prefTypeAppointments" name="prefTypeAppointments" [(ngModel)]="notificationPrefs.types.appointments" />
                                <div>
                                  <div class="fw-semibold">Appuntamenti</div>
                                  <small class="text-muted">Promemoria e conferme visite</small>
                                </div>
                              </label>
                              <label class="list-group-item d-flex align-items-center border-0 px-0 py-2" for="prefTypeDocuments">
                                <input class="form-check-input me-3 flex-shrink-0" type="checkbox" id="prefTypeDocuments" name="prefTypeDocuments" [(ngModel)]="notificationPrefs.types.documents" />
                                <div>
                                  <div class="fw-semibold">Referti e documenti</div>
                                  <small class="text-muted">Nuovi referti disponibili</small>
                                </div>
                              </label>
                              <label class="list-group-item d-flex align-items-center border-0 px-0 py-2" for="prefTypePayments">
                                <input class="form-check-input me-3 flex-shrink-0" type="checkbox" id="prefTypePayments" name="prefTypePayments" [(ngModel)]="notificationPrefs.types.payments" />
                                <div>
                                  <div class="fw-semibold">Pagamenti</div>
                                  <small class="text-muted">Scadenze e conferme pagamento</small>
                                </div>
                              </label>
                              <label class="list-group-item d-flex align-items-center border-0 px-0 py-2" for="prefTypeAdmissions">
                                <input class="form-check-input me-3 flex-shrink-0" type="checkbox" id="prefTypeAdmissions" name="prefTypeAdmissions" [(ngModel)]="notificationPrefs.types.admissions" />
                                <div>
                                  <div class="fw-semibold">Ricoveri</div>
                                  <small class="text-muted">Aggiornamenti sui ricoveri</small>
                                </div>
                              </label>
                              <label class="list-group-item d-flex align-items-center border-0 px-0 py-2" for="prefTypePrescriptions">
                                <input class="form-check-input me-3 flex-shrink-0" type="checkbox" id="prefTypePrescriptions" name="prefTypePrescriptions" [(ngModel)]="notificationPrefs.types.prescriptions" />
                                <div>
                                  <div class="fw-semibold">Prescrizioni</div>
                                  <small class="text-muted">Nuove prescrizioni mediche</small>
                                </div>
                              </label>
                            </div>
                          </div>
                          <div class="alert alert-success border-0 py-2" *ngIf="notificationsSuccess">
                            <i class="bi bi-check-circle me-2"></i>
                            {{ notificationsSuccess }}
                          </div>
                          <div class="alert alert-danger border-0 py-2" *ngIf="notificationsError">
                            <i class="bi bi-exclamation-circle me-2"></i>
                            {{ notificationsError }}
                          </div>
                        </form>
                      </div>
                      <div class="modal-footer border-0 pt-0">
                        <button class="btn btn-outline-secondary" type="button" (click)="closeNotificationPreferencesModal()">Annulla</button>
                        <button class="btn btn-primary" type="button" (click)="saveNotificationPreferences()" [disabled]="notificationPrefsRef.invalid || isLoading">
                          <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-1"></span>
                          <i *ngIf="!isLoading" class="bi bi-check-circle me-1"></i>
                          {{ isLoading ? 'Salvataggio...' : 'Salva preferenze' }}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>
            </ng-container>

            <ng-template #staffNotifications>
              <ng-container *ngIf="isAdmin; else doctorNotifications">
                <div class="col-12">
                  <div class="card card-glass mb-4">
                    <div class="card-body">
                      <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="fw-semibold mb-0">Notifiche inviate</h5>
                        <div class="d-flex flex-wrap gap-2">
                          <button class="btn btn-outline-secondary btn-sm" (click)="loadNotifications()" [disabled]="isLoading">
                            Aggiorna
                          </button>
                          <button class="btn btn-outline-primary btn-sm" type="button" (click)="openAdminNotificationModal()">
                            Invia notifica
                          </button>
                        </div>
                      </div>
                      <div class="table-responsive">
                        <table class="table align-middle">
                          <thead>
                            <tr>
                              <th>ID</th>
                              <th>Destinatario</th>
                              <th>Canale</th>
                              <th>Oggetto</th>
                              <th>Messaggio</th>
                              <th>Note</th>
                              <th>Stato</th>
                              <th>Data e ora</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let notification of notifications | slice:getPageSliceStart('notifications'):getPageSliceEnd('notifications')">
                              <td>{{ notification.id }}</td>
                              <td>{{ notification.recipient }}</td>
                              <td>{{ notification.channel }}</td>
                              <td>{{ notification.subject }}</td>
                              <td>{{ notification.message }}</td>
                              <td>{{ notification.notes || '-' }}</td>
                              <td>{{ getNotificationStatusLabel(notification.status) }}</td>
                              <td>{{ formatDateTime(notification.sentAt) }}</td>
                            </tr>
                            <tr *ngIf="!notifications.length">
                              <td colspan="8" class="text-center text-muted">Nessuna notifica presente.</td>
                            </tr>
                          </tbody>
                        </table>
                        <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'notificationsStaff', total: notifications.length }"></ng-container>
                      </div>
                    </div>
                  </div>

                  <!-- Card Statistiche Mensili -->
                  <div class="card card-glass mb-4">
                    <div class="card-body">
                      <h5 class="fw-semibold mb-3">Statistiche pagamenti - Ultimo mese</h5>
                      <div class="row g-3">
                        <div class="col-md-3">
                          <div class="border rounded p-3 text-center" style="background: rgba(25, 135, 84, 0.1);">
                            <div class="fs-2 fw-bold text-success">{{ paymentStats.percentWithin7Days }}%</div>
                            <div class="small text-muted">Pagati entro 7 giorni</div>
                          </div>
                        </div>
                        <div class="col-md-3">
                          <div class="border rounded p-3 text-center" style="background: rgba(255, 193, 7, 0.1);">
                            <div class="fs-2 fw-bold text-warning">{{ paymentStats.percentWithReminder }}%</div>
                            <div class="small text-muted">Con sollecito</div>
                          </div>
                        </div>
                        <div class="col-md-3">
                          <div class="border rounded p-3 text-center" style="background: rgba(220, 53, 69, 0.1);">
                            <div class="fs-2 fw-bold text-danger">{{ paymentStats.percentPending }}%</div>
                            <div class="small text-muted">Ancora in sospeso</div>
                          </div>
                        </div>
                        <div class="col-md-3">
                          <div class="border rounded p-3 text-center" style="background: rgba(13, 110, 253, 0.1);">
                            <div class="fs-2 fw-bold text-primary">{{ filteredPayments.length }}</div>
                            <div class="small text-muted">Pagamenti filtrati</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Card Pagamenti con Filtri -->
                  <div class="card card-glass">
                    <div class="card-body">
                      <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="fw-semibold mb-0">Pagamenti</h5>
                        <div class="d-flex flex-wrap gap-2">
                          <button class="btn btn-outline-secondary btn-sm" (click)="loadPayments()" [disabled]="isLoading">
                            Aggiorna
                          </button>
                          <button class="btn btn-outline-primary btn-sm" type="button" (click)="openAdminPaymentModal()">
                            Registra pagamento
                          </button>
                        </div>
                      </div>

                      <!-- Filtri -->
                      <div class="row g-3 mb-3">
                        <div class="col-md-4">
                          <label class="form-label small">Stato pagamento</label>
                          <select class="form-select form-select-sm" [(ngModel)]="paymentStatusFilter" name="paymentStatusFilter">
                            <option value="ALL">Tutti gli stati</option>
                            <option value="CREATED">In attesa</option>
                            <option value="CAPTURED">Confermato</option>
                            <option value="FAILED">Non riuscito</option>
                            <option value="CANCELLED">Annullato</option>
                            <option value="REFUNDED">Rimborsato</option>
                          </select>
                        </div>
                        <div class="col-md-4">
                          <label class="form-label small">Giorni dalla visita</label>
                          <select class="form-select form-select-sm" [(ngModel)]="paymentDaysFilter" name="paymentDaysFilter">
                            <option [ngValue]="null">Tutti</option>
                            <option [ngValue]="7">Oltre 7 giorni</option>
                            <option [ngValue]="14">Oltre 14 giorni</option>
                            <option [ngValue]="30">Oltre 30 giorni</option>
                          </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                          <button
                            class="btn btn-warning btn-sm w-100"
                            type="button"
                            (click)="openBulkReminderModal()"
                            [disabled]="selectedPaymentIds.size === 0">
                            Invia solleciti ({{ selectedPaymentIds.size }} selezionati)
                          </button>
                        </div>
                      </div>

                      <div class="alert alert-success py-2" *ngIf="paymentsSuccess">{{ paymentsSuccess }}</div>
                      <div class="alert alert-danger py-2" *ngIf="paymentsError">{{ paymentsError }}</div>

                      <div class="table-responsive">
                        <table class="table align-middle table-hover">
                          <thead>
                            <tr>
                              <th style="width: 40px;">
                                <input
                                  type="checkbox"
                                  class="form-check-input"
                                  [checked]="selectedPaymentIds.size > 0 && selectedPaymentIds.size === (filteredPayments | slice:0:filteredPayments.length).length"
                                  (change)="toggleAllPaymentsSelection()" />
                              </th>
                              <th>ID</th>
                              <th>Paziente</th>
                              <th>Prestazione</th>
                              <th>Importo</th>
                              <th>Data visita</th>
                              <th>Giorni</th>
                              <th>Solleciti</th>
                              <th>Stato</th>
                              <th>Azioni</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let payment of filteredPayments | slice:getPageSliceStart('adminPayments'):getPageSliceEnd('adminPayments')"
                                [class.table-warning]="payment.status === 'CREATED' && getPaymentDaysOverdue(payment) > 14"
                                [class.table-danger]="payment.status === 'FAILED'">
                              <td>
                                <input
                                  type="checkbox"
                                  class="form-check-input"
                                  [checked]="isPaymentSelected(payment.id)"
                                  (change)="togglePaymentSelection(payment.id)"
                                  [disabled]="payment.status !== 'CREATED'" />
                              </td>
                              <td>{{ payment.id }}</td>
                              <td>
                                <div>{{ payment.patientName || getPatientLabel(payment.patientId) }}</div>
                                <small class="text-muted" *ngIf="payment.patientEmail">{{ payment.patientEmail }}</small>
                              </td>
                              <td>{{ payment.service }}</td>
                              <td>
                                <strong>{{ payment.amount | number:'1.2-2' }} {{ payment.currency }}</strong>
                              </td>
                              <td>{{ formatDate(payment.appointmentDate) || '-' }}</td>
                              <td>
                                <span *ngIf="payment.appointmentDate"
                                      [class.text-warning]="getPaymentDaysOverdue(payment) > 7 && getPaymentDaysOverdue(payment) <= 14"
                                      [class.text-danger]="getPaymentDaysOverdue(payment) > 14"
                                      [class.fw-bold]="getPaymentDaysOverdue(payment) > 14">
                                  {{ getPaymentDaysOverdue(payment) }}
                                </span>
                                <span *ngIf="!payment.appointmentDate">-</span>
                              </td>
                              <td>
                                <span class="badge"
                                      [class.bg-secondary]="getNotificationAttemptsCount(payment) === 0"
                                      [class.bg-info]="getNotificationAttemptsCount(payment) > 0">
                                  {{ getNotificationAttemptsCount(payment) }}
                                </span>
                                <small class="d-block text-muted" *ngIf="getNotificationAttemptsCount(payment) > 0">
                                  Ultimo: {{ getLastNotificationDate(payment) }}
                                </small>
                              </td>
                              <td>
                                <span class="badge"
                                      [class.bg-warning]="payment.status === 'CREATED'"
                                      [class.bg-success]="payment.status === 'CAPTURED'"
                                      [class.bg-secondary]="payment.status === 'CANCELLED' || payment.status === 'REFUNDED'"
                                      [class.bg-danger]="payment.status === 'FAILED'">
                                  {{ getPaymentStatusLabel(payment) }}
                                </span>
                                <small class="d-block text-danger" *ngIf="payment.status === 'FAILED'">
                                  Pagamento non riuscito
                                </small>
                              </td>
                              <td>
                                <div class="d-flex gap-1">
                                  <button
                                    class="btn btn-outline-success btn-sm"
                                    type="button"
                                    title="Conferma pagamento ricevuto"
                                    [disabled]="payment.status === 'CAPTURED'"
                                    (click)="confirmAdminPayment(payment)">
                                    <i class="bi bi-check-circle"></i>
                                  </button>
                                  <button
                                    class="btn btn-outline-warning btn-sm"
                                    type="button"
                                    title="Invia sollecito al paziente"
                                    [disabled]="payment.status === 'CONFIRMED'"
                                    (click)="sendSingleReminder(payment)">
                                    <i class="bi bi-bell"></i>
                                  </button>
                                  <button
                                    class="btn btn-outline-danger btn-sm"
                                    type="button"
                                    title="Elimina pagamento"
                                    (click)="deleteAdminPayment(payment)">
                                    <i class="bi bi-trash"></i>
                                  </button>
                                </div>
                              </td>
                            </tr>
                            <tr *ngIf="!filteredPayments.length">
                              <td colspan="10" class="text-center text-muted">Nessun pagamento trovato con i filtri selezionati.</td>
                            </tr>
                          </tbody>
                        </table>
                        <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'adminPayments', total: filteredPayments.length }"></ng-container>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Modal Invio Solleciti Massivi -->
                <ng-container *ngIf="showBulkReminderModal">
                  <div
                    class="modal-backdrop fade show"
                    style="position: fixed; inset: 0; z-index: 1050;"
                    (click)="closeBulkReminderModal()"></div>
                  <div
                    class="modal d-flex align-items-center justify-content-center"
                    role="dialog"
                    aria-modal="true"
                    aria-labelledby="bulkReminderModalTitle"
                    style="position: fixed; inset: 0; z-index: 1055;">
                    <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="bulkReminderModalTitle">Invio solleciti massivo</h5>
                          <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeBulkReminderModal()"></button>
                        </div>
                        <div class="modal-body">
                          <div class="alert alert-info py-2">
                            Stai per inviare un sollecito email a <strong>{{ selectedPaymentIds.size }}</strong> pazienti con pagamenti in sospeso.
                          </div>
                          <p>Ogni paziente ricever√† un'email personalizzata con:</p>
                          <ul>
                            <li>Importo dovuto</li>
                            <li>Data della visita</li>
                            <li>Link per completare il pagamento online</li>
                          </ul>
                          <div class="d-flex justify-content-end gap-2 mt-4">
                            <button class="btn btn-outline-secondary" type="button" (click)="closeBulkReminderModal()">Annulla</button>
                            <button class="btn btn-warning" type="button" (click)="sendBulkReminders()">
                              Invia solleciti
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>

                <!-- Modal Sollecito Alternativo (per FAILED) -->
                <ng-container *ngIf="showAlternativePaymentModal">
                  <div
                    class="modal-backdrop fade show"
                    style="position: fixed; inset: 0; z-index: 1050;"
                    (click)="closeAlternativePaymentModal()"></div>
                  <div
                    class="modal d-flex align-items-center justify-content-center"
                    role="dialog"
                    aria-modal="true"
                    aria-labelledby="alternativePaymentModalTitle"
                    style="position: fixed; inset: 0; z-index: 1055;">
                    <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="alternativePaymentModalTitle">Sollecito con metodo alternativo</h5>
                          <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeAlternativePaymentModal()"></button>
                        </div>
                        <div class="modal-body">
                          <div class="alert alert-warning py-2" *ngIf="alternativePaymentTarget">
                            Il pagamento di <strong>{{ alternativePaymentTarget.amount | number:'1.2-2' }} {{ alternativePaymentTarget.currency }}</strong>
                            per <strong>{{ alternativePaymentTarget.patientName }}</strong> √® fallito.
                            <br><small>Motivo: {{ alternativePaymentTarget.failureReason }}</small>
                          </div>
                          <div class="mb-3">
                            <label class="form-label">Metodo di pagamento alternativo</label>
                            <select class="form-select" [(ngModel)]="alternativePaymentForm.method" name="alternativeMethod">
                              <option value="BONIFICO">Bonifico bancario</option>
                              <option value="SEDE">Pagamento in sede</option>
                            </select>
                          </div>
                          <div class="mb-3">
                            <label class="form-label">Note aggiuntive (opzionale)</label>
                            <textarea class="form-control" rows="2" [(ngModel)]="alternativePaymentForm.notes" name="alternativeNotes"
                                      placeholder="Es. Orari sportello, IBAN, riferimenti..."></textarea>
                          </div>
                          <div class="d-flex justify-content-end gap-2 mt-4">
                            <button class="btn btn-outline-secondary" type="button" (click)="closeAlternativePaymentModal()">Annulla</button>
                            <button class="btn btn-warning" type="button" (click)="sendAlternativePaymentNotification()">
                              Invia sollecito
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>

                <ng-container *ngIf="showAdminNotificationModal">
                  <div
                    class="modal-backdrop fade show"
                    style="position: fixed; inset: 0; z-index: 1050;"
                    (click)="closeAdminNotificationModal()"></div>
                  <div
                    class="modal d-flex align-items-center justify-content-center"
                    role="dialog"
                    aria-modal="true"
                    aria-labelledby="adminNotificationModalTitle"
                    style="position: fixed; inset: 0; z-index: 1055;">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                      <div class="modal-content shadow-lg border-0">
                        <div class="modal-header border-0 pb-0">
                          <div>
                            <h5 class="modal-title fw-bold" id="adminNotificationModalTitle">
                              <i class="bi bi-send me-2 text-primary"></i>
                              Invia notifica
                            </h5>
                            <p class="text-muted small mb-0 mt-1">Invia una comunicazione personalizzata</p>
                          </div>
                          <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeAdminNotificationModal()"></button>
                        </div>
                        <div class="modal-body pt-4">
                          <form (ngSubmit)="submitNotification()" #notificationFormRef="ngForm">
                            <div class="row g-3 mb-3">
                              <div class="col-md-8">
                                <label class="form-label fw-semibold small text-muted">Destinatario</label>
                                <div class="input-group">
                                  <span class="input-group-text bg-light border-end-0">
                                    <i class="bi bi-person text-muted"></i>
                                  </span>
                                  <input class="form-control border-start-0" type="email" name="notificationRecipient" [(ngModel)]="notificationForm.recipient" placeholder="email@esempio.com" required />
                                </div>
                              </div>
                              <div class="col-md-4">
                                <label class="form-label fw-semibold small text-muted">Canale</label>
                                <select class="form-select" name="notificationChannel" [(ngModel)]="notificationForm.channel" required>
                                  <option value="EMAIL">üìß Email</option>
                                  <option value="SMS">üì± SMS</option>
                                  <option value="APP">üì≤ App</option>
                                </select>
                              </div>
                            </div>
                            <div class="mb-3">
                              <label class="form-label fw-semibold small text-muted">Oggetto</label>
                              <input class="form-control" type="text" name="notificationSubject" [(ngModel)]="notificationForm.subject" placeholder="Oggetto della comunicazione" required />
                            </div>
                            <div class="mb-3">
                              <label class="form-label fw-semibold small text-muted">Messaggio</label>
                              <textarea class="form-control" rows="4" name="notificationMessage" [(ngModel)]="notificationForm.message" placeholder="Scrivi il contenuto del messaggio..." required></textarea>
                            </div>
                            <div class="mb-4">
                              <label class="form-label fw-semibold small text-muted">
                                Note interne
                                <span class="fw-normal text-muted">(opzionale)</span>
                              </label>
                              <textarea class="form-control" rows="2" name="notificationNotes" [(ngModel)]="notificationForm.notes" placeholder="Note visibili solo agli operatori..."></textarea>
                            </div>
                            <div class="alert alert-danger border-0 py-2" *ngIf="notificationsError">
                              <i class="bi bi-exclamation-circle me-2"></i>
                              {{ notificationsError }}
                            </div>
                          </form>
                        </div>
                        <div class="modal-footer border-0 pt-0">
                          <button class="btn btn-outline-secondary" type="button" (click)="closeAdminNotificationModal()">Annulla</button>
                          <button class="btn btn-primary" type="button" (click)="submitNotification()" [disabled]="notificationFormRef.invalid || isLoading">
                            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-1"></span>
                            <i *ngIf="!isLoading" class="bi bi-send me-1"></i>
                            {{ isLoading ? 'Invio in corso...' : 'Invia notifica' }}
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>

                <ng-container *ngIf="showAdminPaymentModal">
                  <div
                    class="modal-backdrop fade show"
                    style="position: fixed; inset: 0; z-index: 1050;"
                    (click)="closeAdminPaymentModal()"></div>
                  <div
                    class="modal d-flex align-items-center justify-content-center"
                    role="dialog"
                    aria-modal="true"
                    aria-labelledby="adminPaymentModalTitle"
                    style="position: fixed; inset: 0; z-index: 1055;">
                    <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content shadow-lg border-0">
                        <div class="modal-header border-0 pb-0">
                          <div>
                            <h5 class="modal-title fw-bold" id="adminPaymentModalTitle">
                              <i class="bi bi-credit-card me-2 text-primary"></i>
                              Registra pagamento
                            </h5>
                            <p class="text-muted small mb-0 mt-1">Registra un pagamento ricevuto per un paziente</p>
                          </div>
                          <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeAdminPaymentModal()"></button>
                        </div>
                        <div class="modal-body pt-4">
                          <form (ngSubmit)="submitPayment()" #adminPaymentFormRef="ngForm">
                            <div class="mb-3">
                              <label class="form-label fw-semibold small text-muted">Pagamento</label>
                              <select class="form-select" name="adminPaymentId" [(ngModel)]="paymentForm.paymentId" required>
                                <option [ngValue]="null" disabled>Seleziona un pagamento</option>
                                <option *ngFor="let payment of payments" [ngValue]="payment.id">
                                  #{{ payment.id }} ¬∑ {{ getPatientLabel(payment.patientId) }} ¬∑ {{ payment.service }}
                                </option>
                              </select>
                            </div>
                            <div class="mb-3">
                              <label class="form-label fw-semibold small text-muted">Ricevuta</label>
                              <input class="form-control" type="text" name="adminPaymentReceipt" [(ngModel)]="paymentForm.receiptName" placeholder="es. RIC-2025-001" required />
                            </div>
                            <div class="mb-4">
                              <label class="form-label fw-semibold small text-muted">Importo (‚Ç¨)</label>
                              <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                  <i class="bi bi-currency-euro text-muted"></i>
                                </span>
                                <input class="form-control border-start-0" type="number" name="adminPaymentAmount" [(ngModel)]="paymentForm.amount" min="1" step="0.01" placeholder="0.00" required />
                              </div>
                            </div>
                            <div class="alert alert-danger border-0 py-2" *ngIf="paymentsError">
                              <i class="bi bi-exclamation-circle me-2"></i>
                              {{ paymentsError }}
                            </div>
                          </form>
                        </div>
                        <div class="modal-footer border-0 pt-0">
                          <button class="btn btn-outline-secondary" type="button" (click)="closeAdminPaymentModal()">
                            Annulla
                          </button>
                          <button class="btn btn-primary" type="button" (click)="submitPayment()" [disabled]="adminPaymentFormRef.invalid || isLoading">
                            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-1"></span>
                            <i *ngIf="!isLoading" class="bi bi-check-circle me-1"></i>
                            {{ isLoading ? 'Salvataggio...' : 'Registra pagamento' }}
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>
              </ng-container>

              <ng-template #doctorNotifications>
                <div class="col-lg-8">
                  <div class="card card-glass">
                    <div class="card-body">
                      <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="fw-semibold mb-0">Notifiche inviate</h5>
                        <button class="btn btn-outline-secondary btn-sm" (click)="loadNotifications()" [disabled]="isLoading">
                          Aggiorna
                        </button>
                      </div>
                      <div class="table-responsive">
                        <table class="table align-middle">
                          <thead>
                            <tr>
                              <th>ID</th>
                              <th>Destinatario</th>
                              <th>Canale</th>
                              <th>Oggetto</th>
                              <th>Messaggio</th>
                              <th>Note</th>
                              <th>Stato</th>
                              <th>Data e ora</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let notification of notifications | slice:getPageSliceStart('notifications'):getPageSliceEnd('notifications')">
                              <td>{{ notification.id }}</td>
                              <td>{{ notification.recipient }}</td>
                              <td>{{ notification.channel }}</td>
                              <td>{{ notification.subject }}</td>
                              <td>{{ notification.message }}</td>
                              <td>{{ notification.notes || '-' }}</td>
                              <td>{{ getNotificationStatusLabel(notification.status) }}</td>
                              <td>{{ formatDateTime(notification.sentAt) }}</td>
                            </tr>
                            <tr *ngIf="!notifications.length">
                              <td colspan="8" class="text-center text-muted">Nessuna notifica presente.</td>
                            </tr>
                          </tbody>
                        </table>
                        <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'notificationsStaff', total: notifications.length }"></ng-container>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-lg-4">
                  <div class="card card-glass">
                    <div class="card-body">
                      <h5 class="fw-semibold mb-3">Invia notifica</h5>
                      <form (ngSubmit)="submitNotification()" #notificationFormRef="ngForm">
                        <div class="mb-3">
                          <label class="form-label">Destinatario</label>
                          <input class="form-control" type="email" name="notificationRecipient" [(ngModel)]="notificationForm.recipient" required />
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Canale</label>
                          <select class="form-select" name="notificationChannel" [(ngModel)]="notificationForm.channel" required>
                            <option value="EMAIL">Email</option>
                            <option value="SMS">SMS</option>
                            <option value="APP">App</option>
                          </select>
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Oggetto</label>
                          <input class="form-control" type="text" name="notificationSubject" [(ngModel)]="notificationForm.subject" required />
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Messaggio</label>
                          <textarea class="form-control" rows="4" name="notificationMessage" [(ngModel)]="notificationForm.message" required></textarea>
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Note</label>
                          <textarea class="form-control" rows="2" name="notificationNotes" [(ngModel)]="notificationForm.notes"></textarea>
                        </div>
                        <div class="alert alert-danger py-2" *ngIf="notificationsError">{{ notificationsError }}</div>
                        <button class="btn btn-primary w-100" type="submit" [disabled]="notificationFormRef.invalid || isLoading">
                          {{ isLoading ? 'Invio...' : 'Invia notifica' }}
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </ng-template>
            </ng-template>
          </div>
        </ng-container>
      </ng-template>

      <ng-template #prescribingLayout>
        <ng-container *ngIf="mode === 'prescribing'; else televisitLayout">
          <div class="row g-4">
            <div class="col-lg-12" *ngIf="isPatient; else prescribingStaff">
              <div class="card card-glass">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="fw-semibold mb-0">Prescrizioni attive</h5>
                    <button class="btn btn-outline-secondary btn-sm" (click)="loadPrescriptions()" [disabled]="isLoading">
                      Aggiorna
                    </button>
                  </div>
                  <div class="table-responsive">
                    <table class="table align-middle">
                      <thead>
                        <tr>
                          <th>Medico</th>
                          <th>Farmaco</th>
                          <th>Posologia</th>
                          <th>Durata</th>
                          <th>Note</th>
                          <th>Stato</th>
                          <th>Azioni</th>
                        </tr>
                      </thead>
                      <tbody>
                        <ng-container *ngFor="let prescription of visiblePrescriptions | slice:getPageSliceStart('prescriptions'):getPageSliceEnd('prescriptions')">
                          <tr>
                            <td>{{ getDoctorLabel(prescription.doctorId) }}</td>
                            <td>{{ prescription.drug }}</td>
                            <td>{{ prescription.dosage }}</td>
                            <td>{{ prescription.durationDays }} giorni</td>
                            <td>{{ prescription.notes || '-' }}</td>
                            <td>{{ getPrescriptionStatusLabel(prescription.status) }}</td>
                            <td>
                              <button
                                class="btn btn-outline-success btn-sm me-2"
                                type="button"
                                aria-label="Conferma presa visione"
                                (click)="confirmPrescription(prescription)"
                                [disabled]="prescription.status === 'CONFIRMED'">
                                ‚úÖ
                              </button>
                              <button
                                class="btn btn-outline-danger btn-sm me-2"
                                type="button"
                                aria-label="Rifiuta prescrizione"
                                (click)="openPrescriptionRejectModal(prescription)"
                                [disabled]="prescription.status === 'REJECTED'">
                                ‚ùå
                              </button>
                              <button
                                class="btn btn-outline-secondary btn-sm"
                                type="button"
                                aria-label="Chiedi spiegazioni"
                                (click)="openPrescriptionQuestionModal(prescription)">
                                ‚ùì
                              </button>
                            </td>
                          </tr>
                        </ng-container>
                        <tr *ngIf="!visiblePrescriptions.length">
                          <td colspan="7" class="text-center text-muted">Nessuna prescrizione disponibile.</td>
                        </tr>
                      </tbody>
                    </table>
                    <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'prescriptions', total: visiblePrescriptions.length }"></ng-container>
                  </div>
                </div>
              </div>
            </div>

      <ng-template #prescribingStaff>
        <div class="col-12">
                <div class="card card-glass">
                  <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                      <h5 class="fw-semibold mb-0">Prescrizioni attive</h5>
                      <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-secondary btn-sm" (click)="loadPrescriptions()" [disabled]="isLoading">
                          Aggiorna
                        </button>
                        <button class="btn btn-outline-primary btn-sm" type="button" (click)="openPrescriptionModal()">
                          Nuova prescrizione
                        </button>
                      </div>
                    </div>
                    <div class="row g-3 align-items-end mb-3">
                      <div class="col-lg-4">
                        <p class="text-muted small mb-2">Filtra le prescrizioni selezionando un paziente specifico.</p>
                        <label class="form-label">Paziente</label>
                        <select class="form-select" name="prescriptionPatientFilter" [(ngModel)]="prescriptionPatientFilterId">
                          <option [ngValue]="null">Tutti i pazienti</option>
                          <option *ngFor="let patient of patients" [ngValue]="patient.id">
                            {{ patient.firstName }} {{ patient.lastName }}
                          </option>
                        </select>
                      </div>
                    </div>
                    <div class="table-responsive">
                      <table class="table align-middle">
                        <thead>
                          <tr>
                            <th>Paziente</th>
                            <th>Farmaco</th>
                            <th>Posologia</th>
                            <th>Durata</th>
                            <th>Note</th>
                            <th>Stato</th>
                            <th>Azioni</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let prescription of filteredPrescriptions | slice:getPageSliceStart('prescriptions'):getPageSliceEnd('prescriptions')">
                            <td>{{ getPatientLabel(prescription.patientId) }}</td>
                            <td>{{ prescription.drug }}</td>
                            <td>{{ prescription.dosage }}</td>
                            <td>{{ prescription.durationDays }} giorni</td>
                            <td>{{ prescription.notes || '-' }}</td>
                            <td>{{ getPrescriptionDoctorStatusLabel(prescription.status) }}</td>
                            <td>
                              <button
                                class="btn btn-outline-secondary btn-sm me-2"
                                type="button"
                                aria-label="Modifica prescrizione"
                                title="Modifica prescrizione"
                                (click)="openPrescriptionModal(prescription)">
                                ‚úèÔ∏è
                              </button>
                              <button
                                class="btn btn-outline-danger btn-sm me-2"
                                type="button"
                                aria-label="Elimina prescrizione"
                                title="Elimina prescrizione"
                                (click)="openDeletePrescriptionConfirm(prescription)">
                                üóëÔ∏è
                              </button>
                              <button
                                class="btn btn-outline-secondary btn-sm me-2"
                                type="button"
                                aria-label="Visualizza domanda"
                                title="Visualizza domanda"
                                (click)="openPrescriptionMessageModal(prescription)">
                                üí¨
                              </button>
                              <button
                                class="btn btn-outline-primary btn-sm"
                                type="button"
                                aria-label="Reinvia prescrizione"
                                title="Reinvia prescrizione"
                                (click)="resendPrescription(prescription)">
                                üîÅ
                              </button>
                            </td>
                          </tr>
                          <tr *ngIf="!filteredPrescriptions.length">
                            <td colspan="7" class="text-center text-muted">Nessuna prescrizione disponibile.</td>
                          </tr>
                        </tbody>
                      </table>
                    <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'prescriptionsStaff', total: filteredPrescriptions.length }"></ng-container>
                    </div>
                  </div>
                </div>
        </div>
      </ng-template>
    </div>
  </ng-container>
</ng-template>

<ng-container *ngIf="showPrescriptionModal">
  <div
    class="modal-backdrop fade show"
    style="position: fixed; inset: 0; z-index: 1050;"
    (click)="closePrescriptionModal()"></div>
  <div
    class="modal d-flex align-items-center justify-content-center"
    role="dialog"
    aria-modal="true"
    aria-labelledby="prescriptionModalTitle"
    style="position: fixed; inset: 0; z-index: 1055;">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="prescriptionModalTitle">
            {{ editingPrescriptionId ? 'Modifica prescrizione' : 'Nuova prescrizione' }}
          </h5>
          <button type="button" class="btn-close" aria-label="Chiudi" (click)="closePrescriptionModal()"></button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="submitPrescription()" #prescriptionFormRef="ngForm">
            <div class="mb-3">
              <label class="form-label">Paziente</label>
              <select class="form-select" name="prescriptionPatientId" [(ngModel)]="prescriptionForm.patientId" required>
                <option [ngValue]="null" disabled>Seleziona un paziente</option>
                <option *ngFor="let patient of patients" [ngValue]="patient.id">
                  {{ patient.firstName }} {{ patient.lastName }}
                </option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Farmaco</label>
              <input class="form-control" type="text" name="prescriptionDrug" [(ngModel)]="prescriptionForm.drug" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Posologia</label>
              <input class="form-control" type="text" name="prescriptionDosage" [(ngModel)]="prescriptionForm.dosage" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Durata terapia (giorni)</label>
              <input class="form-control" type="number" name="prescriptionDuration" [(ngModel)]="prescriptionForm.durationDays" min="1" required />
            </div>
            <div class="alert alert-danger py-2" *ngIf="prescribingError">{{ prescribingError }}</div>
            <div class="d-flex justify-content-end gap-2">
              <button class="btn btn-outline-secondary" type="button" (click)="closePrescriptionModal()">Annulla</button>
              <button class="btn btn-primary" type="submit" [disabled]="prescriptionFormRef.invalid || isLoading">
                {{ editingPrescriptionId ? 'Salva modifiche' : 'Registra prescrizione' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<ng-container *ngIf="showPrescriptionMessageModal">
  <div
    class="modal-backdrop fade show"
    style="position: fixed; inset: 0; z-index: 1050;"
    (click)="closePrescriptionMessageModal()"></div>
  <div
    class="modal d-flex align-items-center justify-content-center"
    role="dialog"
    aria-modal="true"
    aria-labelledby="prescriptionMessageModalTitle"
    style="position: fixed; inset: 0; z-index: 1055;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="prescriptionMessageModalTitle">Domanda del paziente</h5>
          <button type="button" class="btn-close" aria-label="Chiudi" (click)="closePrescriptionMessageModal()"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">{{ prescriptionMessageText }}</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" (click)="closePrescriptionMessageModal()">Chiudi</button>
        </div>
      </div>
    </div>
  </div>
</ng-container>

        <ng-container *ngIf="showPrescriptionQuestionModal">
          <div
            class="modal-backdrop fade show"
            style="position: fixed; inset: 0; z-index: 1050;"
            (click)="closePrescriptionQuestionModal()"></div>
        <div
          class="modal d-flex align-items-center justify-content-center"
          role="dialog"
          aria-modal="true"
          aria-labelledby="prescriptionQuestionModalTitle"
          style="position: fixed; inset: 0; z-index: 1055;">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="prescriptionQuestionModalTitle">Domanda al medico</h5>
                <button type="button" class="btn-close" aria-label="Chiudi" (click)="closePrescriptionQuestionModal()"></button>
              </div>
              <div class="modal-body">
                <form (ngSubmit)="submitPrescriptionQuestion()" #prescriptionQuestionRef="ngForm">
                  <div class="mb-3">
                    <label class="form-label">Messaggio</label>
                    <textarea class="form-control" rows="3" name="prescriptionQuestion" [(ngModel)]="prescriptionQuestion" required></textarea>
                  </div>
                  <div class="alert alert-danger py-2" *ngIf="prescribingError">{{ prescribingError }}</div>
                  <div class="d-flex justify-content-end gap-2">
                    <button class="btn btn-outline-secondary" type="button" (click)="closePrescriptionQuestionModal()">Annulla</button>
                    <button class="btn btn-primary" type="submit" [disabled]="prescriptionQuestionRef.invalid || isLoading">
                      Invia domanda
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-template #televisitLayout>
        <ng-container *ngIf="mode === 'televisit'; else adminDirectoryLayout">
          <div class="row g-4">
            <div class="col-12">
              <div class="card card-glass">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="fw-semibold mb-0">Sessioni di televisita</h5>
                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-primary btn-sm" type="button" (click)="openTelevisitModal()">
                        Nuova televisita
                      </button>
                      <button class="btn btn-outline-secondary btn-sm" (click)="loadTelevisits()" [disabled]="isLoading">
                        Aggiorna
                      </button>
                    </div>
                  </div>
                  <div class="mb-3" *ngIf="isDoctor">
                    <p class="text-muted small mb-2">Filtra le televisite selezionando un paziente specifico.</p>
                    <label class="form-label">Paziente</label>
                    <select class="form-select" name="televisitPatientFilter" [(ngModel)]="televisitPatientFilterId">
                      <option [ngValue]="null">Tutti i pazienti</option>
                      <option *ngFor="let patient of patients" [ngValue]="patient.id">
                        {{ patient.firstName }} {{ patient.lastName }}
                      </option>
                    </select>
                  </div>
                  <div class="table-responsive mt-2">
                    <table class="table align-middle">
                      <thead>
                        <tr>
                          <th>Reparto</th>
                          <th *ngIf="isDoctor">Paziente</th>
                          <th>Data e ora</th>
                          <th>Medico</th>
                          <th>Provider</th>
                          <th>Stato sessione</th>
                          <th *ngIf="!isDoctor">Link stanza</th>
                          <th>Azione</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let televisit of filteredTelevisits | slice:getPageSliceStart('televisits'):getPageSliceEnd('televisits')">
                          <td>{{ getDepartmentLabel(televisit.department) }}</td>
                          <td *ngIf="isDoctor">{{ getTelevisitPatientLabel(televisit) }}</td>
                          <td>{{ getTelevisitDateTimeLabel(televisit) }}</td>
                          <td>{{ televisit.doctorSubject }}</td>
                          <td>{{ televisit.provider }}</td>
                          <td>{{ getTelevisitStatusLabel(televisit.status) }}</td>
                          <td *ngIf="!isDoctor"><code class="small">{{ televisit.roomName }}</code></td>
                          <td>
                            <div class="d-flex flex-wrap gap-2">
                              <button
                                class="btn btn-outline-primary btn-sm"
                                type="button"
                                aria-label="Partecipa alla call"
                                title="Partecipa alla call"
                                (click)="joinTelevisit(televisit)">
                                üìû
                              </button>
                              <button
                                class="btn btn-outline-secondary btn-sm"
                                type="button"
                                aria-label="Ripianifica"
                                title="Ripianifica"
                                [disabled]="!canRescheduleTelevisit(televisit)"
                                (click)="openTelevisitRescheduleModal(televisit)">
                                üìÖ
                              </button>
                              <button
                                class="btn btn-outline-danger btn-sm"
                                type="button"
                                aria-label="Elimina"
                                title="Elimina"
                                (click)="openTelevisitDeleteModal(televisit)">
                                üóëÔ∏è
                              </button>
                            </div>
                          </td>
                        </tr>
                        <tr *ngIf="!filteredTelevisits.length">
                          <td [attr.colspan]="7" class="text-center text-muted">Nessuna sessione presente.</td>
                        </tr>
                      </tbody>
                    </table>
                    <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'televisits', total: filteredTelevisits.length }"></ng-container>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

      </ng-template>

      <ng-container *ngIf="showTelevisitModal">
        <div
          class="modal-backdrop fade show"
          style="position: fixed; inset: 0; z-index: 1050;"
          (click)="closeTelevisitModal()"></div>
        <div
          class="modal d-flex align-items-center justify-content-center"
          role="dialog"
          aria-modal="true"
          aria-labelledby="televisitModalTitle"
          style="position: fixed; inset: 0; z-index: 1055;">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="televisitModalTitle">Nuova televisita</h5>
                <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeTelevisitModal()"></button>
              </div>
              <div class="modal-body">
                <form (ngSubmit)="submitTelevisit()" #televisitFormRef="ngForm">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Paziente</label>
                      <select class="form-select" name="televisitPatient" [(ngModel)]="televisitForm.patientSubject" required>
                        <option value="" disabled>Seleziona paziente</option>
                        <option *ngFor="let patient of patients" [value]="patient.firstName + ' ' + patient.lastName">
                          {{ patient.firstName }} {{ patient.lastName }}
                        </option>
                      </select>
                    </div>
                    <div class="col-md-6 mb-3" *ngIf="isDoctor">
                      <label class="form-label">Medico</label>
                      <input class="form-control" type="text" [value]="currentDoctorName" readonly />
                    </div>
                    <div class="col-md-6 mb-3" *ngIf="!isDoctor">
                      <label class="form-label">Medico</label>
                      <select class="form-select" name="televisitDoctor" [(ngModel)]="televisitForm.doctorSubject" required>
                        <option value="" disabled>Seleziona medico</option>
                        <option *ngFor="let doctor of doctors" [value]="doctor.firstName + ' ' + doctor.lastName">
                          {{ doctor.firstName }} {{ doctor.lastName }}
                        </option>
                      </select>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Reparto</label>
                      <select class="form-select" name="televisitDepartment" [(ngModel)]="televisitForm.department" required>
                        <option value="" disabled>Seleziona reparto</option>
                        <option *ngFor="let dept of departments" [value]="dept.code">{{ dept.name }}</option>
                      </select>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Data e ora programmata</label>
                      <input class="form-control" type="datetime-local" name="televisitScheduledAt" [(ngModel)]="televisitForm.scheduledAt" required />
                    </div>
                  </div>
                  <div class="alert alert-danger py-2" *ngIf="televisitError">{{ televisitError }}</div>
                  <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-outline-secondary" (click)="closeTelevisitModal()">Annulla</button>
                    <button class="btn btn-primary" type="submit" [disabled]="televisitFormRef.invalid || isLoading">
                      {{ isLoading ? 'Avvio...' : 'Avvia televisita' }}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="showTelevisitDeleteModal && selectedTelevisit">
        <div
          class="modal-backdrop fade show"
          style="position: fixed; inset: 0; z-index: 1050;"
          (click)="closeTelevisitDeleteModal()"></div>
        <div
          class="modal d-flex align-items-center justify-content-center"
          role="dialog"
          aria-modal="true"
          aria-labelledby="televisitDeleteModalTitle"
          style="position: fixed; inset: 0; z-index: 1055;">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="televisitDeleteModalTitle">Elimina televisita</h5>
                <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeTelevisitDeleteModal()"></button>
              </div>
              <div class="modal-body">
                <p class="text-muted mb-3">
                  Stai eliminando la sessione con {{ selectedTelevisit.patientSubject }} ({{ selectedTelevisit.doctorSubject }}).
                </p>
                <form (ngSubmit)="submitTelevisitDelete()" #televisitDeleteRef="ngForm">
                  <div class="mb-3">
                    <label class="form-label">Motivazione</label>
                    <textarea
                      class="form-control"
                      rows="3"
                      name="televisitDeleteReason"
                      [(ngModel)]="televisitDeleteReason"
                      required></textarea>
                  </div>
                  <div class="alert alert-danger py-2" *ngIf="televisitError">{{ televisitError }}</div>
                  <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-outline-secondary" (click)="closeTelevisitDeleteModal()">Annulla</button>
                    <button class="btn btn-danger" type="submit" [disabled]="televisitDeleteRef.invalid">Elimina</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="showTelevisitRescheduleModal && selectedTelevisit">
        <div
          class="modal-backdrop fade show"
          style="position: fixed; inset: 0; z-index: 1050;"
          (click)="closeTelevisitRescheduleModal()"></div>
        <div
          class="modal d-flex align-items-center justify-content-center"
          role="dialog"
          aria-modal="true"
          aria-labelledby="televisitRescheduleModalTitle"
          style="position: fixed; inset: 0; z-index: 1055;">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="televisitRescheduleModalTitle">Ripianifica televisita</h5>
                <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeTelevisitRescheduleModal()"></button>
              </div>
              <div class="modal-body">
                <p class="text-muted mb-3">
                  Ripianifica la sessione con {{ selectedTelevisit.patientSubject }} ({{ selectedTelevisit.doctorSubject }}).
                </p>
                <form (ngSubmit)="submitTelevisitReschedule()" #televisitRescheduleRef="ngForm">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Nuova data</label>
                      <input
                        class="form-control"
                        type="date"
                        name="televisitRescheduleDate"
                        [(ngModel)]="televisitRescheduleDate"
                        required />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Nuova ora</label>
                      <input
                        class="form-control"
                        type="time"
                        name="televisitRescheduleTime"
                        [(ngModel)]="televisitRescheduleTime"
                        required />
                    </div>
                  </div>
                  <div class="alert alert-danger py-2 mt-3" *ngIf="televisitError">{{ televisitError }}</div>
                  <div class="d-flex justify-content-end gap-2 mt-3">
                    <button type="button" class="btn btn-outline-secondary" (click)="closeTelevisitRescheduleModal()">Annulla</button>
                    <button class="btn btn-primary" type="submit" [disabled]="televisitRescheduleRef.invalid">Salva</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="showPrescriptionRejectModal">
        <div
          class="modal-backdrop fade show"
          style="position: fixed; inset: 0; z-index: 1050;"
          (click)="closePrescriptionRejectModal()"></div>
        <div
          class="modal d-flex align-items-center justify-content-center"
          role="dialog"
          aria-modal="true"
          aria-labelledby="prescriptionRejectModalTitle"
          style="position: fixed; inset: 0; z-index: 1055;">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="prescriptionRejectModalTitle">Rifiuta prescrizione</h5>
                <button type="button" class="btn-close" aria-label="Chiudi" (click)="closePrescriptionRejectModal()"></button>
              </div>
              <div class="modal-body">
                <form (ngSubmit)="submitPrescriptionRejection()" #prescriptionRejectRef="ngForm">
                  <div class="mb-3">
                    <label class="form-label">Motivazione</label>
                    <textarea class="form-control" rows="3" name="prescriptionRejectReason" [(ngModel)]="rejectPrescriptionReason" required></textarea>
                  </div>
                  <div class="alert alert-danger py-2" *ngIf="prescribingError">{{ prescribingError }}</div>
                  <div class="d-flex justify-content-end gap-2">
                    <button class="btn btn-outline-secondary" type="button" (click)="closePrescriptionRejectModal()">Annulla</button>
                    <button class="btn btn-danger" type="submit" [disabled]="prescriptionRejectRef.invalid || isLoading">
                      Rifiuta prescrizione
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-template #adminDirectoryLayout>
        <ng-container *ngIf="mode === 'admin-directory'; else adminAuditLayout">
          <div class="row g-4">
            <div class="col-12">
              <div class="alert alert-danger py-2" *ngIf="directoryError">{{ directoryError }}</div>
              <div class="card card-glass mb-4">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="fw-semibold mb-0">Medici</h5>
                    <div class="d-flex flex-wrap gap-2">
                      <button class="btn btn-outline-secondary btn-sm" (click)="loadDirectory()" [disabled]="isLoading">
                        Aggiorna
                      </button>
                      <button class="btn btn-outline-primary btn-sm" type="button" (click)="openDoctorModal()">
                        Registra medico
                      </button>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table align-middle">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Nome</th>
                          <th>Cognome</th>
                          <th>Struttura</th>
                          <th>Reparto</th>
                          <th>Email</th>
                          <th>Telefono</th>
                          <th>Azioni</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let doctor of doctors | slice:getPageSliceStart('doctors'):getPageSliceEnd('doctors')">
                          <td>{{ doctor.id }}</td>
                          <td>{{ doctor.firstName }}</td>
                          <td>{{ doctor.lastName }}</td>
                          <td>{{ getFacilityLabel(doctor.facilityCode || '-') }}</td>
                          <td>{{ getDepartmentLabel(doctor.departmentCode || '-') }}</td>
                          <td>{{ doctor.email || '-' }}</td>
                          <td>{{ doctor.phone || '-' }}</td>
                          <td>
                            <div class="d-flex gap-2">
                              <button
                                class="btn btn-outline-primary btn-sm"
                                type="button"
                                aria-label="Modifica contatti medico"
                                title="Modifica contatti"
                                (click)="openEditDoctorModal(doctor)">
                                ‚úèÔ∏è
                              </button>
                              <button
                                class="btn btn-outline-danger btn-sm"
                                type="button"
                                aria-label="Disabilita accesso medico"
                                title="Disabilita accesso"
                                (click)="disableDoctorAccess(doctor)">
                                üö´
                              </button>
                            </div>
                          </td>
                        </tr>
                        <tr *ngIf="!doctors.length">
                          <td colspan="8" class="text-center text-muted">Nessun medico registrato.</td>
                        </tr>
                      </tbody>
                    </table>
                    <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'doctors', total: doctors.length }"></ng-container>
                  </div>
                </div>
              </div>

              <div class="card card-glass mb-4">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="fw-semibold mb-0">Pazienti</h5>
                    <div class="d-flex flex-wrap gap-2">
                      <button class="btn btn-outline-secondary btn-sm" (click)="loadDirectory()" [disabled]="isLoading">
                        Aggiorna
                      </button>
                      <button class="btn btn-outline-primary btn-sm" type="button" (click)="openPatientModal()">
                        Registra paziente
                      </button>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table align-middle">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Nome</th>
                          <th>Cognome</th>
                          <th>Email</th>
                          <th>Telefono</th>
                          <th>Azioni</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let patient of patients | slice:getPageSliceStart('patients'):getPageSliceEnd('patients')">
                          <td>{{ patient.id }}</td>
                          <td>{{ patient.firstName }}</td>
                          <td>{{ patient.lastName }}</td>
                          <td>{{ patient.email }}</td>
                          <td>{{ patient.phone || '-' }}</td>
                          <td>
                            <div class="d-flex gap-2">
                              <button
                                class="btn btn-outline-primary btn-sm"
                                type="button"
                                aria-label="Modifica contatti paziente"
                                title="Modifica contatti"
                                (click)="openEditPatientModal(patient)">
                                ‚úèÔ∏è
                              </button>
                              <button
                                class="btn btn-outline-danger btn-sm"
                                type="button"
                                aria-label="Disabilita accesso paziente"
                                title="Disabilita accesso"
                                (click)="disablePatientAccess(patient)">
                                üö´
                              </button>
                            </div>
                          </td>
                        </tr>
                        <tr *ngIf="!patients.length">
                          <td colspan="6" class="text-center text-muted">Nessun paziente registrato.</td>
                        </tr>
                      </tbody>
                    </table>
                    <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'patients', total: patients.length }"></ng-container>
                  </div>
                </div>
              </div>

              <!-- Sezione Strutture -->
              <div class="card card-glass mb-4">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="fw-semibold mb-0">Strutture</h5>
                    <div class="d-flex flex-wrap gap-2">
                      <button class="btn btn-outline-secondary btn-sm" (click)="loadDirectory()" [disabled]="isLoading">
                        Aggiorna
                      </button>
                      <button class="btn btn-outline-primary btn-sm" type="button" (click)="openFacilityModal()">
                        Nuova struttura
                      </button>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table align-middle">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Codice</th>
                          <th>Nome</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let facility of facilities | slice:getPageSliceStart('facilities'):getPageSliceEnd('facilities')">
                          <td>{{ facility.id }}</td>
                          <td>{{ facility.code }}</td>
                          <td>{{ facility.name }}</td>
                        </tr>
                        <tr *ngIf="!facilities.length">
                          <td colspan="3" class="text-center text-muted">Nessuna struttura registrata.</td>
                        </tr>
                      </tbody>
                    </table>
                    <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'facilities', total: facilities.length }"></ng-container>
                  </div>
                </div>
              </div>

              <!-- Sezione Reparti -->
              <div class="card card-glass">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="fw-semibold mb-0">Reparti</h5>
                    <div class="d-flex flex-wrap gap-2">
                      <button class="btn btn-outline-secondary btn-sm" (click)="loadDirectory()" [disabled]="isLoading">
                        Aggiorna
                      </button>
                      <button class="btn btn-outline-primary btn-sm" type="button" (click)="openDepartmentModal()">
                        Nuovo reparto
                      </button>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table align-middle">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Codice</th>
                          <th>Nome</th>
                          <th>Struttura</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let department of departments | slice:getPageSliceStart('departments'):getPageSliceEnd('departments')">
                          <td>{{ department.id }}</td>
                          <td>{{ department.code }}</td>
                          <td>{{ department.name }}</td>
                          <td>{{ getFacilityLabel(department.facilityCode || '-') }}</td>
                        </tr>
                        <tr *ngIf="!departments.length">
                          <td colspan="4" class="text-center text-muted">Nessun reparto registrato.</td>
                        </tr>
                      </tbody>
                    </table>
                    <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'departments', total: departments.length }"></ng-container>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal Nuova Struttura -->
          <ng-container *ngIf="showFacilityModal">
            <div
              class="modal-backdrop fade show"
              style="position: fixed; inset: 0; z-index: 1050;"
              (click)="closeFacilityModal()"></div>
            <div
              class="modal d-flex align-items-center justify-content-center"
              role="dialog"
              aria-modal="true"
              aria-labelledby="adminFacilityModalTitle"
              style="position: fixed; inset: 0; z-index: 1055;">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="adminFacilityModalTitle">Nuova struttura</h5>
                    <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeFacilityModal()"></button>
                  </div>
                  <div class="modal-body">
                    <form (ngSubmit)="submitFacility()" #facilityFormRef="ngForm">
                      <div class="row g-3">
                        <div class="col-12">
                          <label class="form-label">Codice</label>
                          <input class="form-control" type="text" name="facilityCode" [(ngModel)]="facilityForm.code" required placeholder="es. HOSP_CENTRAL" />
                        </div>
                        <div class="col-12">
                          <label class="form-label">Nome</label>
                          <input class="form-control" type="text" name="facilityName" [(ngModel)]="facilityForm.name" required placeholder="es. Ospedale Centrale" />
                        </div>
                      </div>
                      <div class="alert alert-danger py-2 mt-3" *ngIf="directoryError">{{ directoryError }}</div>
                      <div class="d-flex justify-content-end gap-2 mt-3">
                        <button class="btn btn-outline-secondary" type="button" (click)="closeFacilityModal()">Annulla</button>
                        <button class="btn btn-primary" type="submit" [disabled]="facilityFormRef.invalid || isLoading">
                          {{ isLoading ? 'Salvataggio...' : 'Crea struttura' }}
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <!-- Modal Nuovo Reparto -->
          <ng-container *ngIf="showDepartmentModal">
            <div
              class="modal-backdrop fade show"
              style="position: fixed; inset: 0; z-index: 1050;"
              (click)="closeDepartmentModal()"></div>
            <div
              class="modal d-flex align-items-center justify-content-center"
              role="dialog"
              aria-modal="true"
              aria-labelledby="adminDepartmentModalTitle"
              style="position: fixed; inset: 0; z-index: 1055;">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="adminDepartmentModalTitle">Nuovo reparto</h5>
                    <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeDepartmentModal()"></button>
                  </div>
                  <div class="modal-body">
                    <form (ngSubmit)="submitDepartment()" #departmentFormRef="ngForm">
                      <div class="row g-3">
                        <div class="col-12">
                          <label class="form-label">Codice</label>
                          <input class="form-control" type="text" name="departmentCode" [(ngModel)]="departmentForm.code" required placeholder="es. CARD" />
                        </div>
                        <div class="col-12">
                          <label class="form-label">Nome</label>
                          <input class="form-control" type="text" name="departmentName" [(ngModel)]="departmentForm.name" required placeholder="es. Cardiologia" />
                        </div>
                        <div class="col-12">
                          <label class="form-label">Struttura</label>
                          <select class="form-select" name="departmentFacility" [(ngModel)]="departmentForm.facilityCode" required>
                            <option value="" disabled>Seleziona una struttura</option>
                            <option *ngFor="let facility of facilities" [value]="facility.code">
                              {{ facility.name }}
                            </option>
                          </select>
                        </div>
                      </div>
                      <div class="alert alert-danger py-2 mt-3" *ngIf="directoryError">{{ directoryError }}</div>
                      <div class="d-flex justify-content-end gap-2 mt-3">
                        <button class="btn btn-outline-secondary" type="button" (click)="closeDepartmentModal()">Annulla</button>
                        <button class="btn btn-primary" type="submit" [disabled]="departmentFormRef.invalid || isLoading">
                          {{ isLoading ? 'Salvataggio...' : 'Crea reparto' }}
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <ng-container *ngIf="showDoctorModal">
            <div
              class="modal-backdrop fade show"
              style="position: fixed; inset: 0; z-index: 1050;"
              (click)="closeDoctorModal()"></div>
            <div
              class="modal d-flex align-items-center justify-content-center"
              role="dialog"
              aria-modal="true"
              aria-labelledby="adminDoctorModalTitle"
              style="position: fixed; inset: 0; z-index: 1055;">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="adminDoctorModalTitle">Registra medico</h5>
                    <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeDoctorModal()"></button>
                  </div>
                  <div class="modal-body">
                    <form (ngSubmit)="submitDoctor()" #doctorFormRef="ngForm">
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label">Nome</label>
                          <input class="form-control" type="text" name="doctorFirstName" [(ngModel)]="doctorForm.firstName" required />
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Cognome</label>
                          <input class="form-control" type="text" name="doctorLastName" [(ngModel)]="doctorForm.lastName" required />
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Email</label>
                          <input class="form-control" type="email" name="doctorEmail" [(ngModel)]="doctorForm.email" required />
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Telefono</label>
                          <input class="form-control" type="tel" name="doctorPhone" [(ngModel)]="doctorForm.phone" />
                        </div>
                        <div class="col-12">
                          <label class="form-label">Reparto</label>
                          <select class="form-select" name="doctorDepartment" [(ngModel)]="doctorForm.departmentCode" required>
                            <option value="" disabled>Seleziona un reparto</option>
                            <option *ngFor="let department of departments" [value]="department.code">
                              {{ department.name }} ({{ getFacilityLabel(department.facilityCode || '') }})
                            </option>
                          </select>
                        </div>
                      </div>
                      <div class="alert alert-danger py-2 mt-3" *ngIf="directoryError">{{ directoryError }}</div>
                      <div class="d-flex justify-content-end gap-2 mt-3">
                        <button class="btn btn-outline-secondary" type="button" (click)="closeDoctorModal()">Annulla</button>
                        <button class="btn btn-primary" type="submit" [disabled]="doctorFormRef.invalid || isLoading">
                          {{ isLoading ? 'Salvataggio...' : 'Registra medico' }}
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <ng-container *ngIf="showPatientModal">
            <div
              class="modal-backdrop fade show"
              style="position: fixed; inset: 0; z-index: 1050;"
              (click)="closePatientModal()"></div>
            <div
              class="modal d-flex align-items-center justify-content-center"
              role="dialog"
              aria-modal="true"
              aria-labelledby="adminPatientModalTitle"
              style="position: fixed; inset: 0; z-index: 1055;">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="adminPatientModalTitle">Registra paziente</h5>
                    <button type="button" class="btn-close" aria-label="Chiudi" (click)="closePatientModal()"></button>
                  </div>
                  <div class="modal-body">
                    <form (ngSubmit)="submitPatient()" #patientFormRef="ngForm">
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label">Nome</label>
                          <input class="form-control" type="text" name="patientFirstName" [(ngModel)]="patientForm.firstName" required />
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Cognome</label>
                          <input class="form-control" type="text" name="patientLastName" [(ngModel)]="patientForm.lastName" required />
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Email</label>
                          <input class="form-control" type="email" name="patientEmail" [(ngModel)]="patientForm.email" required />
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Telefono (opzionale)</label>
                          <input class="form-control" type="tel" name="patientPhone" [(ngModel)]="patientForm.phone" />
                        </div>
                      </div>
                      <div class="alert alert-danger py-2" *ngIf="directoryError">{{ directoryError }}</div>
                      <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-outline-secondary" type="button" (click)="closePatientModal()">Annulla</button>
                        <button class="btn btn-primary" type="submit" [disabled]="patientFormRef.invalid || isLoading">
                          {{ isLoading ? 'Salvataggio...' : 'Registra paziente' }}
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <ng-container *ngIf="showEditDoctorModal">
            <div
              class="modal-backdrop fade show"
              style="position: fixed; inset: 0; z-index: 1050;"
              (click)="closeEditDoctorModal()"></div>
            <div
              class="modal d-flex align-items-center justify-content-center"
              role="dialog"
              aria-modal="true"
              aria-labelledby="adminEditDoctorModalTitle"
              style="position: fixed; inset: 0; z-index: 1055;">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="adminEditDoctorModalTitle">Modifica contatti medico</h5>
                    <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeEditDoctorModal()"></button>
                  </div>
                  <div class="modal-body">
                    <p class="text-muted mb-3" *ngIf="editDoctorTarget">
                      {{ editDoctorTarget.firstName }} {{ editDoctorTarget.lastName }}
                    </p>
                    <form (ngSubmit)="submitEditDoctor()" #editDoctorFormRef="ngForm">
                      <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input
                          class="form-control"
                          type="email"
                          name="editDoctorEmail"
                          [(ngModel)]="editDoctorForm.email" />
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Telefono</label>
                        <input
                          class="form-control"
                          type="tel"
                          name="editDoctorPhone"
                          [(ngModel)]="editDoctorForm.phone" />
                      </div>
                      <div class="alert alert-danger py-2" *ngIf="directoryError">{{ directoryError }}</div>
                      <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-outline-secondary" type="button" (click)="closeEditDoctorModal()">Annulla</button>
                        <button class="btn btn-primary" type="submit" [disabled]="isLoading">
                          {{ isLoading ? 'Salvataggio...' : 'Salva contatti' }}
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <ng-container *ngIf="showEditPatientModal">
            <div
              class="modal-backdrop fade show"
              style="position: fixed; inset: 0; z-index: 1050;"
              (click)="closeEditPatientModal()"></div>
            <div
              class="modal d-flex align-items-center justify-content-center"
              role="dialog"
              aria-modal="true"
              aria-labelledby="adminEditPatientModalTitle"
              style="position: fixed; inset: 0; z-index: 1055;">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="adminEditPatientModalTitle">Modifica contatti paziente</h5>
                    <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeEditPatientModal()"></button>
                  </div>
                  <div class="modal-body">
                    <p class="text-muted mb-3" *ngIf="editPatientTarget">
                      {{ editPatientTarget.firstName }} {{ editPatientTarget.lastName }}
                    </p>
                    <form (ngSubmit)="submitEditPatient()" #editPatientFormRef="ngForm">
                      <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input
                          class="form-control"
                          type="email"
                          name="editPatientEmail"
                          [(ngModel)]="editPatientForm.email" />
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Telefono</label>
                        <input
                          class="form-control"
                          type="tel"
                          name="editPatientPhone"
                          [(ngModel)]="editPatientForm.phone" />
                      </div>
                      <div class="alert alert-danger py-2" *ngIf="directoryError">{{ directoryError }}</div>
                      <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-outline-secondary" type="button" (click)="closeEditPatientModal()">Annulla</button>
                        <button class="btn btn-primary" type="submit" [disabled]="isLoading">
                          {{ isLoading ? 'Salvataggio...' : 'Salva contatti' }}
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </ng-container>
      </ng-template>

      <ng-template #adminAuditLayout>
        <ng-container *ngIf="mode === 'admin-audit'; else adminTelevisitLayout">
          <div class="row g-4">
            <!-- Pannello Ricerca -->
            <div class="col-12">
              <div class="card card-glass">
                <div class="card-body">
                  <h5 class="fw-semibold mb-3">Ricerca Audit Trail</h5>
                  <div class="row g-3">
                    <div class="col-md-2">
                      <label class="form-label">Tipo soggetto</label>
                      <select class="form-select" [(ngModel)]="auditSearchCriteria.subjectType" [disabled]="isLoading">
                        <option value="PATIENT">Paziente</option>
                        <option value="DOCTOR">Medico</option>
                        <option value="ADMIN">Amministratore</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">{{ auditSubjectLabel }}</label>
                      <input type="text" class="form-control" [placeholder]="auditSubjectPlaceholder" [(ngModel)]="auditSearchCriteria.subjectIdentifier" [disabled]="isLoading" [style.text-transform]="auditSearchCriteria.subjectType === 'PATIENT' ? 'uppercase' : 'none'" />
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Data inizio</label>
                      <input type="date" class="form-control" [(ngModel)]="auditSearchCriteria.dateFrom" [disabled]="isLoading" />
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Data fine</label>
                      <input type="date" class="form-control" [(ngModel)]="auditSearchCriteria.dateTo" [disabled]="isLoading" />
                    </div>
                    <div class="col-md-3 d-flex align-items-end gap-2">
                      <button class="btn btn-primary" (click)="searchAuditEvents()" [disabled]="isLoading || !auditSearchCriteria.subjectIdentifier">
                        {{ isLoading ? 'Ricerca...' : 'Cerca' }}
                      </button>
                      <button class="btn btn-outline-primary" (click)="loadAllAuditEvents()" [disabled]="isLoading" title="Mostra tutti gli eventi">
                        Mostra tutti
                      </button>
                      <button class="btn btn-outline-secondary" (click)="clearAuditSearch()" [disabled]="isLoading" title="Reset">
                        Reset
                      </button>
                    </div>
                  </div>
                  <div class="alert alert-danger py-2 mt-3" *ngIf="auditError">{{ auditError }}</div>
                </div>
              </div>
            </div>

            <!-- Risultati Ricerca -->
            <ng-container *ngIf="auditSearchPerformed">
              <!-- Info Soggetto e Riepilogo -->
              <div class="col-md-4">
                <div class="card card-glass h-100">
                  <div class="card-body">
                    <h6 class="fw-semibold mb-3">{{ auditSubjectFound ? auditSubjectFoundTitle : 'Tutti gli Eventi' }}</h6>
                    <ng-container *ngIf="auditSubjectFound && auditSubjectFound.id !== 'ALL'">
                      <div class="mb-2"><strong>ID:</strong> {{ auditSubjectFound.id }}</div>
                      <div class="mb-2"><strong>Nome:</strong> {{ auditSubjectFound.name }}</div>
                      <div class="mb-2" *ngIf="auditSubjectFound.role"><strong>Ruolo:</strong> {{ auditSubjectFound.role }}</div>
                      <div class="mb-3"><strong>{{ auditSubjectFound.identifierLabel }}:</strong> {{ auditSubjectFound.identifier }}</div>
                    </ng-container>
                    <ng-container *ngIf="!auditSubjectFound || auditSubjectFound.id === 'ALL'">
                      <p class="text-muted mb-3">Visualizzazione di tutti gli eventi di audit del sistema senza filtro per soggetto.</p>
                    </ng-container>
                    <hr />
                    <h6 class="fw-semibold mb-3">Riepilogo Periodo</h6>
                    <div *ngIf="auditReportSummary">
                      <div class="d-flex justify-content-between mb-1"><span>Totale eventi:</span><strong>{{ auditReportSummary.totalEvents }}</strong></div>
                      <div class="d-flex justify-content-between mb-1"><span>Accessi documenti:</span><strong>{{ auditReportSummary.documentAccesses }}</strong></div>
                      <div class="d-flex justify-content-between mb-1"><span>Modifiche consensi:</span><strong>{{ auditReportSummary.consentChanges }}</strong></div>
                      <div class="d-flex justify-content-between mb-1"><span>Visualizzazioni prescrizioni:</span><strong>{{ auditReportSummary.prescriptionViews }}</strong></div>
                      <div class="d-flex justify-content-between mb-1"><span>Accessi negati:</span><strong class="text-danger">{{ auditReportSummary.deniedAccesses }}</strong></div>
                      <div class="d-flex justify-content-between mb-1"><span>Attori unici:</span><strong>{{ auditReportSummary.uniqueActors }}</strong></div>
                    </div>
                    <hr />
                    <button class="btn btn-success w-100" (click)="exportAuditReport()" [disabled]="auditExporting || !auditReportSummary">
                      {{ auditExporting ? 'Generazione report...' : 'Esporta Report' }}
                    </button>
                  </div>
                </div>
              </div>

              <!-- Consensi Attivi -->
              <div class="col-md-4">
                <div class="card card-glass h-100">
                  <div class="card-body">
                    <h6 class="fw-semibold mb-3">Consensi Attivi</h6>
                    <div *ngIf="auditConsents.length === 0" class="text-muted">Nessun consenso attivo trovato.</div>
                    <div *ngFor="let consent of auditConsents" class="border-bottom pb-2 mb-2">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <strong>{{ consent.doctorName }}</strong>
                          <div class="small text-muted">Ambito: {{ consent.scope }}</div>
                          <div class="small text-muted">Concesso: {{ formatAuditDateShort(consent.grantedAt) }}</div>
                        </div>
                        <span class="badge" [ngClass]="consent.status === 'ACTIVE' ? 'bg-success' : 'bg-secondary'">{{ consent.status }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Filtri -->
              <div class="col-md-4">
                <div class="card card-glass h-100">
                  <div class="card-body">
                    <h6 class="fw-semibold mb-3">Filtri Avanzati</h6>
                    <div class="mb-3">
                      <label class="form-label small fw-semibold">Tipo Evento</label>
                      <div class="d-flex flex-wrap gap-1">
                        <button *ngFor="let opt of auditEventTypeOptions" class="btn btn-sm" [ngClass]="isEventTypeSelected(opt.value) ? 'btn-primary' : 'btn-outline-secondary'" (click)="toggleEventTypeFilter(opt.value)">{{ opt.label }}</button>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label small fw-semibold">Tipo Attore</label>
                      <div class="d-flex flex-wrap gap-1">
                        <button *ngFor="let opt of auditActorTypeOptions" class="btn btn-sm" [ngClass]="isActorTypeSelected(opt.value) ? 'btn-primary' : 'btn-outline-secondary'" (click)="toggleActorTypeFilter(opt.value)">{{ opt.label }}</button>
                      </div>
                    </div>
                    <div>
                      <label class="form-label small fw-semibold">Esito</label>
                      <div class="d-flex flex-wrap gap-1">
                        <button *ngFor="let opt of auditOutcomeOptions" class="btn btn-sm" [ngClass]="isOutcomeSelected(opt.value) ? 'btn-primary' : 'btn-outline-secondary'" (click)="toggleOutcomeFilter(opt.value)">{{ opt.label }}</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Tabella Eventi -->
              <div class="col-12">
                <div class="card card-glass">
                  <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                      <h6 class="fw-semibold mb-0">Eventi Audit ({{ auditFilteredEvents.length }})</h6>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle">
                        <thead>
                          <tr>
                            <th style="width: 160px;">Timestamp</th>
                            <th style="width: 140px;">Tipo Evento</th>
                            <th>Azione</th>
                            <th style="width: 180px;">Attore</th>
                            <th style="width: 100px;">Esito</th>
                            <th style="width: 100px;">Consenso</th>
                            <th style="width: 60px;"></th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let event of auditFilteredEvents | slice:getPageSliceStart('auditFiltered'):getPageSliceEnd('auditFiltered')" style="cursor: pointer;" (click)="selectAuditEvent(event)">
                            <td class="small">{{ formatAuditDate(event.occurredAt) }}</td>
                            <td><span class="badge" [ngClass]="getEventTypeBadgeClass(event.eventType)">{{ getEventTypeLabel(event.eventType) }}</span></td>
                            <td class="small">{{ event.action }}</td>
                            <td class="small"><strong>{{ event.actorName }}</strong><div class="text-muted" *ngIf="event.actorRole">{{ event.actorRole }}</div></td>
                            <td><span class="badge" [ngClass]="getOutcomeBadgeClass(event.outcome)">{{ getOutcomeLabel(event.outcome) }}</span></td>
                            <td><span class="badge bg-success" *ngIf="event.consentValidAtAccess">Valido</span><span class="badge bg-secondary" *ngIf="!event.consentValidAtAccess && event.actorType === 'DOCTOR'">N/A</span></td>
                            <td><button class="btn btn-sm btn-outline-primary">Dettagli</button></td>
                          </tr>
                          <tr *ngIf="!auditFilteredEvents.length">
                            <td colspan="7" class="text-center text-muted py-4">Nessun evento corrispondente ai criteri di ricerca.</td>
                          </tr>
                        </tbody>
                      </table>
                      <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'auditFiltered', total: auditFilteredEvents.length }"></ng-container>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>

            <!-- Stato iniziale -->
            <ng-container *ngIf="!auditSearchPerformed && !auditError">
              <div class="col-12">
                <div class="card card-glass">
                  <div class="card-body text-center py-5">
                    <div class="mb-3" style="font-size: 3rem;">&#128270;</div>
                    <h5>Ricerca Audit Trail</h5>
                    <p class="text-muted mb-0">Seleziona il tipo di soggetto, inserisci l'identificativo e l'intervallo temporale per visualizzare gli eventi di audit.</p>
                    <div class="text-muted small mt-3">
                      <strong>Codici demo:</strong><br/>
                      Paziente: <strong>SPSGPP65M15H501X</strong> (Sig. Esposito)<br/>
                      Medico: <strong>marco.bianchi&#64;sanitech.it</strong> (Dr. Marco Bianchi)<br/>
                      Amministratore: <strong>admin.rossi</strong> (Mario Rossi)
                    </div>
                    <button class="btn btn-outline-info mt-3" (click)="loadAllAuditEvents()" [disabled]="isLoading">
                      <i class="bi bi-list-ul me-2"></i>Mostra tutti gli eventi
                    </button>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>

          <!-- Modal Dettaglio Evento -->
          <ng-container *ngIf="auditSelectedEvent">
            <div class="modal-backdrop fade show" style="position: fixed; inset: 0; z-index: 1050;" (click)="closeAuditEventDetail()"></div>
            <div class="modal d-flex align-items-center justify-content-center" role="dialog" aria-modal="true" style="position: fixed; inset: 0; z-index: 1055;">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Dettaglio Evento Audit</h5>
                    <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeAuditEventDetail()"></button>
                  </div>
                  <div class="modal-body">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label small fw-semibold">ID Evento</label>
                        <div>{{ auditSelectedEvent.id }}</div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-semibold">Timestamp</label>
                        <div>{{ formatAuditDate(auditSelectedEvent.occurredAt) }}</div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-semibold">Tipo Evento</label>
                        <div><span class="badge" [ngClass]="getEventTypeBadgeClass(auditSelectedEvent.eventType)">{{ getEventTypeLabel(auditSelectedEvent.eventType) }}</span></div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-semibold">Esito</label>
                        <div><span class="badge" [ngClass]="getOutcomeBadgeClass(auditSelectedEvent.outcome)">{{ getOutcomeLabel(auditSelectedEvent.outcome) }}</span></div>
                      </div>
                      <div class="col-12">
                        <label class="form-label small fw-semibold">Azione</label>
                        <div>{{ auditSelectedEvent.action }}</div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-semibold">Attore</label>
                        <div><strong>{{ auditSelectedEvent.actorName }}</strong> ({{ getActorTypeLabel(auditSelectedEvent.actorType) }})</div>
                        <div class="small text-muted" *ngIf="auditSelectedEvent.actorRole">{{ auditSelectedEvent.actorRole }}</div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-semibold">Servizio</label>
                        <div>{{ auditSelectedEvent.serviceName }}</div>
                      </div>
                      <div class="col-md-6" *ngIf="auditSelectedEvent.resourceName">
                        <label class="form-label small fw-semibold">Risorsa</label>
                        <div>{{ auditSelectedEvent.resourceName }}</div>
                      </div>
                      <div class="col-md-6" *ngIf="auditSelectedEvent.consentScope">
                        <label class="form-label small fw-semibold">Ambito Consenso</label>
                        <div>{{ auditSelectedEvent.consentScope }}</div>
                      </div>
                      <div class="col-md-6" *ngIf="auditSelectedEvent.ipAddress">
                        <label class="form-label small fw-semibold">Indirizzo IP</label>
                        <div>{{ auditSelectedEvent.ipAddress }}</div>
                      </div>
                      <div class="col-md-6" *ngIf="auditSelectedEvent.consentValidAtAccess !== undefined">
                        <label class="form-label small fw-semibold">Consenso al momento dell'accesso</label>
                        <div><span class="badge" [ngClass]="auditSelectedEvent.consentValidAtAccess ? 'bg-success' : 'bg-danger'">{{ auditSelectedEvent.consentValidAtAccess ? 'Valido' : 'Non valido' }}</span></div>
                      </div>
                      <div class="col-12">
                        <label class="form-label small fw-semibold">Hash Integrit√†</label>
                        <div class="small text-muted font-monospace" style="word-break: break-all;">{{ auditSelectedEvent.integrityHash }}</div>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button class="btn btn-secondary" (click)="closeAuditEventDetail()">Chiudi</button>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </ng-container>
      </ng-template>

      <!-- LAYOUT ADMIN TELEVISITE -->
      <ng-template #adminTelevisitLayout>
        <ng-container *ngIf="mode === 'admin-televisit'; else adminAdmissionsLayout">
          <div class="row g-4">
            <!-- Statistiche rapide -->
            <div class="col-12">
              <div class="row g-3">
                <div class="col-md-3">
                  <div class="card card-glass text-center p-3">
                    <div class="fs-2 fw-bold text-primary">{{ televisits.length }}</div>
                    <div class="small text-muted">Televisite attive</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card card-glass text-center p-3">
                    <div class="fs-2 fw-bold text-success">{{ televisiteProgrammateOggi }}</div>
                    <div class="small text-muted">Programmate oggi</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card card-glass text-center p-3">
                    <div class="fs-2 fw-bold text-info">{{ televisiteConcluse }}</div>
                    <div class="small text-muted">Concluse</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card card-glass text-center p-3">
                    <div class="fs-2 fw-bold text-warning">{{ televisiteInAttesaPaziente }}</div>
                    <div class="small text-muted">In attesa paziente</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tabella sessioni televisita -->
            <div class="col-12">
              <div class="card card-glass">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="fw-semibold mb-0">Sessioni di televisita attive</h5>
                    <div class="d-flex flex-wrap gap-2">
                      <button class="btn btn-outline-secondary btn-sm" (click)="loadAdminTelevisit()" [disabled]="isLoading">
                        Aggiorna
                      </button>
                      <button class="btn btn-outline-primary btn-sm" type="button" (click)="openAdminTelevisitModal()">
                        Nuova sessione
                      </button>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table align-middle table-hover">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Paziente</th>
                          <th>Medico</th>
                          <th>Data e ora</th>
                          <th>Provider</th>
                          <th>Stato</th>
                          <th>Link</th>
                          <th>Azioni</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let televisit of televisits | slice:getPageSliceStart('adminTelevisits'):getPageSliceEnd('adminTelevisits')"
                            [class.table-success]="televisit.status === 'ENDED'"
                            [class.table-info]="televisit.status === 'CREATED'">
                          <td>{{ televisit.id }}</td>
                          <td>{{ getTelevisitPatientLabel(televisit) }}</td>
                          <td>{{ televisit.doctorSubject }}</td>
                          <td>{{ getTelevisitDateTimeLabel(televisit) }}</td>
                          <td><span class="badge bg-secondary">{{ televisit.provider }}</span></td>
                          <td>
                            <span class="badge"
                                  [class.bg-info]="televisit.status === 'CREATED'"
                                  [class.bg-success]="televisit.status === 'ENDED'"
                                  [class.bg-warning]="televisit.status === 'ACTIVE'"
                                  [class.bg-secondary]="televisit.status === 'CANCELED'">
                              {{ getTelevisitStatusLabel(televisit.status) }}
                            </span>
                          </td>
                          <td>
                            <code class="small">{{ televisit.roomName }}</code>
                          </td>
                          <td>
                            <div class="d-flex flex-wrap gap-1">
                              <button class="btn btn-outline-primary btn-sm" type="button" title="Copia link">
                                üìã
                              </button>
                              <button class="btn btn-outline-success btn-sm" type="button" title="Avvia"
                                      [disabled]="televisit.status !== 'CREATED'">
                                ‚ñ∂Ô∏è
                              </button>
                            </div>
                          </td>
                        </tr>
                        <tr *ngIf="!televisits.length">
                          <td colspan="8" class="text-center text-muted">Nessuna sessione di televisita programmata.</td>
                        </tr>
                      </tbody>
                    </table>
                    <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'adminTelevisits', total: televisits.length }"></ng-container>
                  </div>
                </div>
              </div>
            </div>

          </div>

          <!-- Modal Avvia Televisita -->
          <ng-container *ngIf="showAdminTelevisitModal">
            <div
              class="modal-backdrop fade show"
              style="position: fixed; inset: 0; z-index: 1050;"
              (click)="closeAdminTelevisitModal()"></div>
            <div
              class="modal d-flex align-items-center justify-content-center"
              role="dialog"
              aria-modal="true"
              aria-labelledby="adminTelevisitModalTitle"
              style="position: fixed; inset: 0; z-index: 1055;">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="adminTelevisitModalTitle">Converti in televisita</h5>
                    <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeAdminTelevisitModal()"></button>
                  </div>
                  <div class="modal-body">
                    <form (ngSubmit)="submitTelevisit()" #adminTelevisitFormRef="ngForm">
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label class="form-label">Paziente</label>
                          <select class="form-select" name="adminTelevisitPatient" [(ngModel)]="televisitForm.patientSubject" required>
                            <option value="" disabled>Seleziona paziente</option>
                            <option *ngFor="let patient of patients" [value]="patient.firstName + ' ' + patient.lastName">
                              {{ patient.firstName }} {{ patient.lastName }}
                            </option>
                          </select>
                        </div>
                        <div class="col-md-6 mb-3">
                          <label class="form-label">Medico</label>
                          <select class="form-select" name="adminTelevisitDoctor" [(ngModel)]="televisitForm.doctorSubject" required>
                            <option value="" disabled>Seleziona medico</option>
                            <option *ngFor="let doctor of doctors" [value]="doctor.firstName + ' ' + doctor.lastName">
                              {{ doctor.firstName }} {{ doctor.lastName }}
                            </option>
                          </select>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label class="form-label">Reparto</label>
                          <select class="form-select" name="adminTelevisitDepartment" [(ngModel)]="televisitForm.department" required>
                            <option value="" disabled>Seleziona reparto</option>
                            <option *ngFor="let dept of departments" [value]="dept.code">{{ dept.name }}</option>
                          </select>
                        </div>
                        <div class="col-md-6 mb-3">
                          <label class="form-label">Data e ora programmata</label>
                          <input class="form-control" type="datetime-local" name="adminTelevisitScheduledAt" [(ngModel)]="televisitForm.scheduledAt" required />
                        </div>
                      </div>
                      <div class="alert alert-info py-2">
                        <small>Il paziente ricever√† automaticamente una notifica email con il link per collegarsi.</small>
                      </div>
                      <div class="alert alert-danger py-2" *ngIf="televisitError">{{ televisitError }}</div>
                      <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-outline-secondary" type="button" (click)="closeAdminTelevisitModal()">Annulla</button>
                        <button class="btn btn-primary" type="submit" [disabled]="adminTelevisitFormRef.invalid || isLoading">
                          {{ isLoading ? 'Creazione...' : 'Crea televisita' }}
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </ng-container>
      </ng-template>

      <!-- LAYOUT ADMIN RICOVERI -->
      <ng-template #adminAdmissionsLayout>
        <ng-container *ngIf="mode === 'admin-admissions'; else apiLayout">
          <div class="row g-4">
            <!-- Statistiche ricoveri -->
            <div class="col-12">
              <div class="row g-3">
                <div class="col-md-3">
                  <div class="card card-glass text-center p-3">
                    <div class="fs-2 fw-bold text-primary">{{ ricoveriAttivi }}</div>
                    <div class="small text-muted">Ricoveri attivi</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card card-glass text-center p-3">
                    <div class="fs-2 fw-bold text-warning">{{ ricoveriPneumologia }}</div>
                    <div class="small text-muted">Pneumologia</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card card-glass text-center p-3">
                    <div class="fs-2 fw-bold text-success">{{ ricoveriConfermati }}</div>
                    <div class="small text-muted">Confermati</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card card-glass text-center p-3">
                    <div class="fs-2 fw-bold text-secondary">{{ dimessiQuestoMese }}</div>
                    <div class="small text-muted">Dimessi questo mese</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tabella ricoveri con focus su Pneumologia -->
            <div class="col-12">
              <div class="card card-glass">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                      <h5 class="fw-semibold mb-1">Ricoveri attivi</h5>
                      <small class="text-muted">Gestione posti letto e medici referenti</small>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                      <button class="btn btn-outline-secondary btn-sm" (click)="loadAdminAdmissions()" [disabled]="isLoading">
                        Aggiorna
                      </button>
                      <button class="btn btn-outline-primary btn-sm" type="button" (click)="openAdminAdmissionModal()">
                        Nuovo ricovero
                      </button>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table align-middle table-hover">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Paziente</th>
                          <th>Reparto</th>
                          <th>Tipo</th>
                          <th>Medico referente</th>
                          <th>Data ammissione</th>
                          <th>Stato</th>
                          <th>Note</th>
                          <th>Azioni</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let admission of admissions | slice:getPageSliceStart('adminAdmissions'):getPageSliceEnd('adminAdmissions')"
                            [class.table-warning]="admission.departmentCode === 'PNEUMO' && admission.status === 'ACTIVE'"
                            [class.table-secondary]="admission.status === 'DISCHARGED'"
                            [class.table-danger]="admission.status === 'CANCELLED'">
                          <td>{{ admission.id }}</td>
                          <td>
                            <strong>{{ getPatientLabel(admission.patientId) }}</strong>
                          </td>
                          <td>
                            <span class="badge"
                                  [class.bg-warning]="admission.departmentCode === 'PNEUMO'"
                                  [class.bg-danger]="admission.departmentCode === 'CARD'"
                                  [class.bg-info]="admission.departmentCode === 'NEURO'"
                                  [class.bg-secondary]="!['PNEUMO','CARD','NEURO'].includes(admission.departmentCode)"
                                  [class.text-dark]="admission.departmentCode === 'PNEUMO'">
                              {{ getDepartmentLabel(admission.departmentCode) }}
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-light text-dark">{{ getAdmissionTypeLabel(admission.admissionType) }}</span>
                          </td>
                          <td>
                            {{ getDoctorLabel(admission.attendingDoctorId) }}
                          </td>
                          <td>{{ formatDate(admission.admittedAt) }}</td>
                          <td>
                            <span class="badge"
                                  [class.bg-primary]="admission.status === 'ACTIVE'"
                                  [class.bg-secondary]="admission.status === 'DISCHARGED'"
                                  [class.bg-danger]="admission.status === 'CANCELLED'">
                              {{ getAdmissionStatusLabel(admission.status) }}
                            </span>
                          </td>
                          <td>
                            <small class="text-muted" *ngIf="admission.notes">{{ admission.notes }}</small>
                            <span *ngIf="!admission.notes">-</span>
                          </td>
                          <td>
                            <div class="d-flex flex-wrap gap-1">
                              <button
                                class="btn btn-outline-primary btn-sm"
                                type="button"
                                title="Modifica referente"
                                [disabled]="admission.status !== 'ACTIVE'">
                                üë®‚Äç‚öïÔ∏è
                              </button>
                              <button
                                class="btn btn-outline-success btn-sm"
                                type="button"
                                title="Dimetti"
                                [disabled]="admission.status !== 'ACTIVE'">
                                ‚úì
                              </button>
                              <button
                                class="btn btn-outline-secondary btn-sm"
                                type="button"
                                title="Note"
                                (click)="openAdmissionNoteModal(admission)">
                                üìù
                              </button>
                            </div>
                          </td>
                        </tr>
                        <tr *ngIf="!admissions.length">
                          <td colspan="9" class="text-center text-muted">Nessun ricovero registrato.</td>
                        </tr>
                      </tbody>
                    </table>
                    <ng-container *ngTemplateOutlet="paginationFooter; context: { key: 'adminAdmissions', total: admissions.length }"></ng-container>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal Nuovo Ricovero -->
          <ng-container *ngIf="showAdminAdmissionModal">
            <div
              class="modal-backdrop fade show"
              style="position: fixed; inset: 0; z-index: 1050;"
              (click)="closeAdminAdmissionModal()"></div>
            <div
              class="modal d-flex align-items-center justify-content-center"
              role="dialog"
              aria-modal="true"
              aria-labelledby="adminAdmissionModalTitle"
              style="position: fixed; inset: 0; z-index: 1055;">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="adminAdmissionModalTitle">Registra nuovo ricovero</h5>
                    <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeAdminAdmissionModal()"></button>
                  </div>
                  <div class="modal-body">
                    <form (ngSubmit)="submitAdmission()" #adminAdmissionFormRef="ngForm">
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label class="form-label">Paziente</label>
                          <select class="form-select" name="adminAdmissionPatientId" [(ngModel)]="admissionForm.patientId" required>
                            <option [ngValue]="null" disabled>Seleziona paziente</option>
                            <option *ngFor="let patient of patients" [ngValue]="patient.id">
                              {{ patient.firstName }} {{ patient.lastName }}
                            </option>
                          </select>
                        </div>
                        <div class="col-md-6 mb-3">
                          <label class="form-label">Reparto</label>
                          <select class="form-select" name="adminAdmissionDepartment" [(ngModel)]="admissionForm.departmentCode" required>
                            <option value="" disabled>Seleziona reparto</option>
                            <option *ngFor="let dept of departments" [value]="dept.code">{{ dept.name }}</option>
                          </select>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label class="form-label">Tipo ricovero</label>
                          <select class="form-select" name="adminAdmissionType" [(ngModel)]="admissionForm.admissionType" required>
                            <option value="INPATIENT">Ricovero ordinario</option>
                            <option value="DAY_HOSPITAL">Day Hospital</option>
                            <option value="OBSERVATION">Osservazione</option>
                          </select>
                        </div>
                        <div class="col-md-6 mb-3">
                          <label class="form-label">Medico referente</label>
                          <select class="form-select" name="adminAdmissionDoctor" [(ngModel)]="admissionForm.attendingDoctorId">
                            <option [ngValue]="null">Nessuno (assegnazione automatica)</option>
                            <option *ngFor="let doctor of doctors" [ngValue]="doctor.id">
                              {{ doctor.firstName }} {{ doctor.lastName }}
                            </option>
                          </select>
                        </div>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Note</label>
                        <textarea class="form-control" rows="2" name="adminAdmissionNotes" [(ngModel)]="admissionForm.notes" placeholder="Note opzionali sul ricovero..."></textarea>
                      </div>
                      <div class="alert alert-danger py-2" *ngIf="paymentsError">{{ paymentsError }}</div>
                      <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-outline-secondary" type="button" (click)="closeAdminAdmissionModal()">Annulla</button>
                        <button class="btn btn-primary" type="submit" [disabled]="adminAdmissionFormRef.invalid || isLoading">
                          {{ isLoading ? 'Salvataggio...' : 'Registra ricovero' }}
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <!-- Modal Rifiuta Ricovero -->
          <ng-container *ngIf="showAdmissionRejectModal">
            <div
              class="modal-backdrop fade show"
              style="position: fixed; inset: 0; z-index: 1050;"
              (click)="closeAdmissionRejectModal()"></div>
            <div
              class="modal d-flex align-items-center justify-content-center"
              role="dialog"
              aria-modal="true"
              aria-labelledby="adminAdmissionRejectModalTitle"
              style="position: fixed; inset: 0; z-index: 1055;">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="adminAdmissionRejectModalTitle">Rifiuta proposta di ricovero</h5>
                    <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeAdmissionRejectModal()"></button>
                  </div>
                  <div class="modal-body">
                    <form (ngSubmit)="submitAdmissionRejection()" #adminAdmissionRejectRef="ngForm">
                      <div class="mb-3">
                        <label class="form-label">Motivazione</label>
                        <textarea class="form-control" rows="3" name="adminAdmissionRejectReason" [(ngModel)]="rejectAdmissionReason" required></textarea>
                      </div>
                      <div class="alert alert-danger py-2" *ngIf="rescheduleError">{{ rescheduleError }}</div>
                      <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-outline-secondary" type="button" (click)="closeAdmissionRejectModal()">Annulla</button>
                        <button class="btn btn-danger" type="submit" [disabled]="adminAdmissionRejectRef.invalid || isLoading">
                          Rifiuta proposta
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </ng-container>
      </ng-template>

    <ng-template #apiLayout>
      <div class="row g-4">
        <div class="col-lg-4">
          <div class="card card-glass h-100">
            <div class="card-body">
              <h5 class="fw-semibold">Servizi disponibili</h5>
              <div class="list-group">
                <button
                  class="list-group-item list-group-item-action"
                  *ngFor="let endpoint of endpoints"
                  [class.active]="endpoint === selectedEndpoint"
                  (click)="selectEndpoint(endpoint)">
                  <strong>{{ endpoint.method }}</strong>
                  <span class="d-block small text-muted">{{ endpoint.label }}</span>
                  <span class="small text-muted">{{ endpoint.path }}</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-8">
          <div class="card card-glass mb-4">
            <div class="card-body">
              <h5 class="fw-semibold">Richiesta</h5>
              <div class="mb-3">
                <label class="form-label">Payload JSON (opzionale)</label>
                <textarea class="form-control" rows="6" [(ngModel)]="payload"></textarea>
              </div>
              <button class="btn btn-primary" (click)="execute()" [disabled]="isLoading">
                {{ isLoading ? 'Invio...' : 'Esegui chiamata' }}
              </button>
            </div>
          </div>

          <div class="card card-glass">
            <div class="card-body">
              <h5 class="fw-semibold">Risposta</h5>
              <pre class="bg-light p-3 rounded" style="min-height: 200px;">{{ responseBody || 'Nessuna risposta ancora.' }}</pre>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
    </ng-template>
  </div>

  <ng-container *ngIf="showDeleteConfirmModal">
    <div
      class="modal-backdrop fade show"
      style="position: fixed; inset: 0; z-index: 1050;"
      (click)="closeDeleteConfirmModal()"></div>
    <div
      class="modal d-flex align-items-center justify-content-center"
      role="dialog"
      aria-modal="true"
      aria-labelledby="deleteConfirmModalTitle"
      style="position: fixed; inset: 0; z-index: 1055;">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteConfirmModalTitle">Conferma eliminazione</h5>
            <button type="button" class="btn-close" aria-label="Chiudi" (click)="closeDeleteConfirmModal()"></button>
          </div>
          <div class="modal-body">
            <p class="mb-0">{{ deleteConfirmMessage }}</p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" type="button" (click)="closeDeleteConfirmModal()">Annulla</button>
            <button class="btn btn-danger" type="button" (click)="confirmDelete()">Conferma</button>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</section>
