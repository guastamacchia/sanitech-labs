<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
      <div class="d-flex align-items-center gap-2 mb-2">
        <a routerLink="/portal/doctor" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-arrow-left me-1"></i>
          Torna Indietro
        </a>
        <nav aria-label="breadcrumb" class="mb-0">
          <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a routerLink="/portal/doctor">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Documenti clinici</li>
          </ol>
        </nav>
      </div>
      <h2 class="mb-1 fw-bold">Documenti clinici dei pazienti</h2>
      <p class="text-muted mb-0">Consulta la documentazione clinica dei pazienti che hanno concesso il consenso</p>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card card-glass h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
              <i class="bi bi-person-check text-success fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ patientsWithConsent }}</h3>
              <small class="text-muted">Pazienti con consenso attivo</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card card-glass h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
              <i class="bi bi-file-earmark-medical text-primary fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ totalDocumentsAccessed }}</h3>
              <small class="text-muted">Documenti consultati (mese)</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card card-glass h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-warning bg-opacity-10 p-3 me-3">
              <i class="bi bi-shield-exclamation text-warning fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ accessDeniedCount }}</h3>
              <small class="text-muted">Accessi negati (mese)</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Info Box -->
  <div class="alert alert-info border-0 mb-4" role="alert">
    <div class="d-flex">
      <i class="bi bi-shield-lock fs-5 me-3 mt-1"></i>
      <div>
        <h6 class="alert-heading mb-1">Accesso regolato dal consenso</h6>
        <p class="mb-0 small">
          Puoi consultare i documenti clinici solo dei pazienti che hanno concesso esplicitamente il consenso per l'ambito "Documenti clinici".
          Ogni accesso viene registrato nel sistema di audit per garantire la tracciabilita' e la compliance normativa.
        </p>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Colonna sinistra: Ricerca pazienti -->
    <div class="col-lg-5">
      <div class="card card-glass border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-bottom">
          <h5 class="mb-0 fw-semibold">
            <i class="bi bi-search me-2"></i>
            Ricerca paziente
          </h5>
        </div>
        <div class="card-body">
          <!-- Search Form -->
          <div class="mb-4">
            <label class="form-label fw-semibold small text-muted">Cerca per nome, cognome o email</label>
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="bi bi-person-search text-muted"></i>
              </span>
              <input
                type="text"
                class="form-control"
                placeholder="Es. Mario Rossi, mario.rossi@email.it..."
                [(ngModel)]="searchQuery"
                (keyup.enter)="searchPatients()"
                [disabled]="isSearching">
              <button
                class="btn btn-primary"
                type="button"
                (click)="searchPatients()"
                [disabled]="isSearching || !searchQuery.trim()">
                <span *ngIf="isSearching" class="spinner-border spinner-border-sm me-1"></span>
                {{ isSearching ? 'Ricerca...' : 'Cerca' }}
              </button>
            </div>
            <div class="d-flex justify-content-end mt-2" *ngIf="searchQuery">
              <button class="btn btn-link btn-sm text-muted p-0" (click)="clearSearch()">
                <i class="bi bi-x-circle me-1"></i>Pulisci ricerca
              </button>
            </div>
          </div>

          <!-- Search Results -->
          <div *ngIf="hasSearched">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0 text-muted">
                <i class="bi bi-list-ul me-1"></i>
                Risultati
                <span class="badge bg-secondary ms-1">{{ searchResults.length }}</span>
              </h6>
            </div>

            <!-- Lista pazienti -->
            <div class="list-group list-group-flush" *ngIf="searchResults.length > 0">
              <button
                *ngFor="let patient of searchResults"
                type="button"
                class="list-group-item list-group-item-action py-3"
                [class.active]="selectedPatient?.id === patient.id"
                (click)="selectPatient(patient)">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-primary bg-opacity-10 p-2 me-3">
                      <i class="bi bi-person" [class.text-primary]="selectedPatient?.id !== patient.id" [class.text-white]="selectedPatient?.id === patient.id"></i>
                    </div>
                    <div>
                      <div class="fw-semibold">{{ getPatientFullName(patient) }}</div>
                      <small class="text-muted">{{ patient.email }}</small>
                    </div>
                  </div>
                  <span class="badge" [ngClass]="getConsentBadge(patient).class">
                    {{ getConsentBadge(patient).label }}
                  </span>
                </div>
              </button>
            </div>

            <!-- Nessun risultato -->
            <div class="text-center py-5" *ngIf="searchResults.length === 0 && !isSearching">
              <i class="bi bi-inbox fs-1 text-muted d-block mb-3"></i>
              <p class="text-muted mb-0">Nessun paziente trovato con i criteri di ricerca specificati.</p>
            </div>
          </div>

          <!-- Placeholder iniziale -->
          <div class="text-center py-5" *ngIf="!hasSearched">
            <i class="bi bi-person-search fs-1 text-muted d-block mb-3"></i>
            <p class="text-muted mb-2">Cerca un paziente nell'anagrafica</p>
            <small class="text-muted">Inserisci nome, cognome o email e premi "Cerca"</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Colonna destra: Documenti del paziente selezionato -->
    <div class="col-lg-7">
      <!-- Stato iniziale: nessun paziente selezionato -->
      <div class="card card-glass border-0 shadow-sm h-100" *ngIf="!selectedPatient">
        <div class="card-body d-flex flex-column align-items-center justify-content-center py-5">
          <i class="bi bi-folder2-open fs-1 text-muted mb-3"></i>
          <h5 class="text-muted">Seleziona un paziente</h5>
          <p class="text-muted text-center mb-0">
            Cerca e seleziona un paziente dalla lista a sinistra<br>per visualizzare i suoi documenti clinici.
          </p>
        </div>
      </div>

      <!-- Paziente selezionato -->
      <div *ngIf="selectedPatient">
        <!-- Header paziente -->
        <div class="card card-glass border-0 shadow-sm mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div class="d-flex align-items-center">
                <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
                  <i class="bi bi-person fs-4 text-primary"></i>
                </div>
                <div>
                  <h5 class="mb-1 fw-bold">{{ getPatientFullName(selectedPatient) }}</h5>
                  <div class="text-muted small">
                    <span class="me-3"><i class="bi bi-envelope me-1"></i>{{ selectedPatient.email }}</span>
                    <span *ngIf="selectedPatient.phone"><i class="bi bi-telephone me-1"></i>{{ selectedPatient.phone }}</span>
                  </div>
                  <div class="text-muted small mt-1" *ngIf="selectedPatient.departments && selectedPatient.departments.length > 0">
                    <i class="bi bi-hospital me-1"></i>{{ getPatientDepartments(selectedPatient) }}
                  </div>
                </div>
              </div>
              <button class="btn btn-outline-secondary btn-sm" (click)="deselectPatient()">
                <i class="bi bi-x-lg me-1"></i>Chiudi
              </button>
            </div>
          </div>
        </div>

        <!-- Loading -->
        <div class="card card-glass border-0 shadow-sm" *ngIf="isLoadingDocuments">
          <div class="card-body py-5 text-center">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">Verifica consenso in corso...</span>
            </div>
            <p class="text-muted mb-0">Verifica consenso e caricamento documenti...</p>
          </div>
        </div>

        <!-- ACCESSO NEGATO - Errore 403 -->
        <div class="card border-danger shadow-sm" *ngIf="!isLoadingDocuments && accessDenied">
          <div class="card-header bg-danger text-white">
            <div class="d-flex align-items-center">
              <i class="bi bi-shield-x fs-4 me-2"></i>
              <div>
                <h5 class="mb-0 fw-bold">Accesso negato</h5>
                <small class="opacity-75">Errore {{ accessDeniedError?.status }}</small>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="alert alert-danger border-0 mb-4">
              <div class="d-flex">
                <i class="bi bi-exclamation-octagon fs-4 me-3 mt-1"></i>
                <div>
                  <h6 class="alert-heading mb-2">Non e' possibile accedere ai documenti di questo paziente</h6>
                  <p class="mb-0">
                    {{ accessDeniedError?.detail }}
                  </p>
                </div>
              </div>
            </div>

            <div class="bg-light rounded p-4 mb-4">
              <h6 class="fw-semibold mb-3">
                <i class="bi bi-info-circle me-2"></i>
                Perche' l'accesso e' stato negato?
              </h6>
              <p class="mb-3 small">
                Il sistema di gestione dei consensi ha verificato che non esiste un consenso valido
                per la consultazione dei documenti clinici di questo paziente. Questo puo' accadere perche':
              </p>
              <ul class="small mb-0">
                <li>Il paziente non ha mai concesso il consenso per i documenti clinici</li>
                <li>Il consenso precedentemente concesso e' stato revocato</li>
                <li>Il consenso e' scaduto</li>
              </ul>
            </div>

            <div class="bg-light rounded p-4">
              <h6 class="fw-semibold mb-3">
                <i class="bi bi-lightbulb me-2"></i>
                Come procedere?
              </h6>
              <p class="small mb-0">
                Se necessario consultare i documenti clinici di questo paziente, e' possibile richiedere
                al paziente di concedere il consenso attraverso il suo portale personale, nella sezione
                "Gestione consensi ai medici". Una volta concesso il consenso, l'accesso sara' immediatamente disponibile.
              </p>
            </div>
          </div>
          <div class="card-footer bg-transparent border-top-0">
            <div class="d-flex justify-content-between align-items-center text-muted small">
              <span>
                <i class="bi bi-clock-history me-1"></i>
                Tentativo registrato nel log di audit
              </span>
              <span>
                <i class="bi bi-link-45deg me-1"></i>
                {{ accessDeniedError?.instance }}
              </span>
            </div>
          </div>
        </div>

        <!-- ACCESSO CONSENTITO - Documenti -->
        <div class="card card-glass border-0 shadow-sm" *ngIf="!isLoadingDocuments && !accessDenied">
          <div class="card-header bg-transparent border-bottom">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0 fw-semibold">
                <i class="bi bi-file-earmark-medical me-2"></i>
                Documenti clinici
                <span class="badge bg-success ms-2">{{ documentsTotalElements }}</span>
              </h5>
              <span class="badge bg-success">
                <i class="bi bi-check-circle me-1"></i>
                Consenso verificato
              </span>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive" *ngIf="patientDocuments.length > 0">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="ps-4">Documento</th>
                    <th>Tipo</th>
                    <th>Reparto</th>
                    <th>Data</th>
                    <th>Dimensione</th>
                    <th class="text-end pe-4">Azioni</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let doc of paginatedDocuments">
                    <td class="ps-4">
                      <div class="d-flex align-items-center">
                        <div class="rounded bg-light p-2 me-3">
                          <i [class]="getDocumentTypeIcon(doc.documentType) + ' text-primary'"></i>
                        </div>
                        <div>
                          <div class="fw-semibold">{{ doc.fileName }}</div>
                          <small class="text-muted" *ngIf="doc.description">{{ doc.description }}</small>
                        </div>
                      </div>
                    </td>
                    <td>
                      <span class="badge" [ngClass]="getDocumentTypeBadgeClass(doc.documentType)">
                        {{ getDocumentTypeLabel(doc.documentType) }}
                      </span>
                    </td>
                    <td>
                      <small>{{ doc.departmentCode }}</small>
                    </td>
                    <td>
                      <small>{{ formatDateTime(doc.createdAt) }}</small>
                    </td>
                    <td>
                      <small class="text-muted">{{ formatFileSize(doc.sizeBytes) }}</small>
                    </td>
                    <td class="text-end pe-4">
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" (click)="viewDocument(doc)" title="Visualizza">
                          <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-secondary" (click)="downloadDocument(doc)" title="Scarica">
                          <i class="bi bi-download"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Nessun documento -->
            <div class="text-center py-5" *ngIf="patientDocuments.length === 0">
              <i class="bi bi-folder2 fs-1 text-muted d-block mb-3"></i>
              <p class="text-muted mb-0">Nessun documento clinico presente per questo paziente.</p>
            </div>
          </div>

          <!-- Pagination -->
          <div class="card-footer bg-transparent border-top" *ngIf="totalPages > 1">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">
                Pagina {{ currentPage }} di {{ totalPages }} ({{ documentsTotalElements }} documenti)
              </small>
              <nav>
                <ul class="pagination pagination-sm mb-0">
                  <li class="page-item" [class.disabled]="currentPage === 1">
                    <button class="page-link" (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1">
                      <i class="bi bi-chevron-left"></i>
                    </button>
                  </li>
                  <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index" [class.active]="currentPage === i + 1">
                    <button class="page-link" (click)="changePage(i + 1)">{{ i + 1 }}</button>
                  </li>
                  <li class="page-item" [class.disabled]="currentPage === totalPages">
                    <button class="page-link" (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages">
                      <i class="bi bi-chevron-right"></i>
                    </button>
                  </li>
                </ul>
              </nav>
            </div>
          </div>

          <!-- Audit notice -->
          <div class="card-footer bg-light border-top-0">
            <small class="text-muted">
              <i class="bi bi-shield-check me-1"></i>
              L'accesso a questi documenti e' stato registrato nel sistema di audit.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
