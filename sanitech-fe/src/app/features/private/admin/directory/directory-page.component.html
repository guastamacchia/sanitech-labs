<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2">
          <li class="breadcrumb-item"><a routerLink="/portal/admin">Area riservata admin</a></li>
          <li class="breadcrumb-item active" aria-current="page">Directory</li>
        </ol>
      </nav>
      <h2 class="mb-1 fw-bold">Directory & Anagrafiche</h2>
      <p class="text-muted mb-0">Gestione strutture, reparti, medici e pazienti</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" (click)="goBack()">
        <i class="bi bi-arrow-left me-1"></i>
        Torna indietro
      </button>
      <button class="btn btn-outline-secondary" (click)="loadAllData()" [disabled]="isLoading">
        <i class="bi bi-arrow-clockwise me-1" [class.spin]="isLoading"></i>
        Aggiorna
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card card-glass h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
              <i class="bi bi-building text-primary fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ totalFacilities }}</h3>
              <small class="text-muted">Strutture</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-glass h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-info bg-opacity-10 p-3 me-3">
              <i class="bi bi-hospital text-info fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ totalDepartments }}</h3>
              <small class="text-muted">Reparti</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-glass h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
              <i class="bi bi-person-badge text-success fs-4"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ activeDoctors }}/{{ totalDoctors }}</h3>
              <small class="text-muted">Medici attivi</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-glass h-100 border-0 shadow-sm" [class.border-warning]="pendingDoctors > 0" [class.border-2]="pendingDoctors > 0">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="rounded-circle p-3 me-3" [ngClass]="pendingDoctors > 0 ? 'bg-warning bg-opacity-10' : 'bg-secondary bg-opacity-10'">
              <i class="bi bi-hourglass-split fs-4" [ngClass]="pendingDoctors > 0 ? 'text-warning' : 'text-secondary'"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ pendingDoctors }}</h3>
              <small class="text-muted">In attesa attivazione</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs Card -->
  <div class="card card-glass border-0 shadow-sm">
    <div class="card-header bg-transparent border-bottom">
      <ul class="nav nav-tabs card-header-tabs">
        <li class="nav-item">
          <button class="nav-link" [class.active]="activeTab === 'facilities'" (click)="setTab('facilities')">
            <i class="bi bi-building me-1"></i>
            Strutture
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" [class.active]="activeTab === 'departments'" (click)="setTab('departments')">
            <i class="bi bi-hospital me-1"></i>
            Reparti
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link position-relative" [class.active]="activeTab === 'doctors'" (click)="setTab('doctors')">
            <i class="bi bi-person-badge me-1"></i>
            Medici
            <span *ngIf="pendingDoctors > 0" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark" style="font-size: 0.65rem;">
              {{ pendingDoctors }}
            </span>
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link position-relative" [class.active]="activeTab === 'patients'" (click)="setTab('patients')">
            <i class="bi bi-people me-1"></i>
            Pazienti
            <span *ngIf="pendingPatients > 0" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark" style="font-size: 0.65rem;">
              {{ pendingPatients }}
            </span>
          </button>
        </li>
      </ul>
    </div>

    <div class="card-body">
      <!-- Search and Actions Bar -->
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
        <div class="input-group" style="max-width: 320px;">
          <span class="input-group-text bg-white">
            <i class="bi bi-search text-muted"></i>
          </span>
          <input type="text" class="form-control" placeholder="Cerca..." [(ngModel)]="searchQuery">
        </div>

        <div class="d-flex gap-2">
          <button *ngIf="activeTab === 'facilities'" class="btn btn-primary" (click)="openFacilityModal()">
            <i class="bi bi-plus-circle me-1"></i>
            Nuova Struttura
          </button>
          <button *ngIf="activeTab === 'departments'" class="btn btn-primary" (click)="openDepartmentModal()">
            <i class="bi bi-plus-circle me-1"></i>
            Nuovo Reparto
          </button>
          <button *ngIf="activeTab === 'doctors'" class="btn btn-primary" (click)="openDoctorModal()">
            <i class="bi bi-plus-circle me-1"></i>
            Nuovo Medico
          </button>
        </div>
      </div>

      <!-- Facilities Tab -->
      <div *ngIf="activeTab === 'facilities'">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="ps-4">Codice</th>
                <th>Nome Struttura</th>
                <th>Indirizzo</th>
                <th>Telefono</th>
                <th>Reparti</th>
                <th class="text-end pe-4">Azioni</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let facility of filteredFacilities">
                <td class="ps-4">
                  <code class="bg-light px-2 py-1 rounded">{{ facility.code }}</code>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-primary bg-opacity-10 p-2 me-3">
                      <i class="bi bi-building text-primary"></i>
                    </div>
                    <span class="fw-semibold">{{ facility.name }}</span>
                  </div>
                </td>
                <td class="text-muted">{{ facility.address || '-' }}</td>
                <td>{{ facility.phone || '-' }}</td>
                <td>
                  <span class="badge bg-primary rounded-pill">
                    {{ getDepartmentCountForFacility(facility.code) }}
                  </span>
                </td>
                <td class="text-end pe-4">
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" title="Modifica" (click)="openFacilityModal(facility)">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger" title="Elimina" (click)="deleteFacility(facility)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <tr *ngIf="filteredFacilities.length === 0">
                <td colspan="6" class="text-center py-5">
                  <div class="text-muted">
                    <i class="bi bi-building fs-1 d-block mb-3"></i>
                    <p class="mb-0">Nessuna struttura trovata.</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Departments Tab -->
      <div *ngIf="activeTab === 'departments'">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="ps-4">Codice</th>
                <th>Nome Reparto</th>
                <th>Struttura</th>
                <th>Medici</th>
                <th class="text-end pe-4">Azioni</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let dept of filteredDepartments">
                <td class="ps-4">
                  <code class="bg-light px-2 py-1 rounded">{{ dept.code }}</code>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-info bg-opacity-10 p-2 me-3">
                      <i class="bi bi-hospital text-info"></i>
                    </div>
                    <span class="fw-semibold">{{ dept.name }}</span>
                  </div>
                </td>
                <td>{{ dept.facilityName }}</td>
                <td>
                  <span class="badge bg-primary rounded-pill">{{ dept.doctorCount || 0 }}</span>
                </td>
                <td class="text-end pe-4">
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" title="Modifica" (click)="openDepartmentModal(dept)">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger" title="Elimina" (click)="deleteDepartment(dept)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <tr *ngIf="filteredDepartments.length === 0">
                <td colspan="5" class="text-center py-5">
                  <div class="text-muted">
                    <i class="bi bi-hospital fs-1 d-block mb-3"></i>
                    <p class="mb-0">Nessun reparto trovato.</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Doctors Tab -->
      <div *ngIf="activeTab === 'doctors'">
        <!-- Alert for pending doctors -->
        <div class="alert alert-warning border-0 mb-4" *ngIf="pendingDoctors > 0">
          <div class="d-flex">
            <i class="bi bi-exclamation-triangle fs-5 me-3 mt-1"></i>
            <div>
              <h6 class="alert-heading mb-1">{{ pendingDoctors }} medici in attesa di attivazione</h6>
              <p class="mb-0 small">Questi medici hanno ricevuto le credenziali via email ma non hanno ancora completato il primo accesso. Puoi reinviare l'email di attivazione o attivare manualmente l'account.</p>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="ps-4">Medico</th>
                <th>Contatti</th>
                <th>Reparto</th>
                <th>Struttura</th>
                <th>Stato</th>
                <th>Authority</th>
                <th class="text-end pe-4">Azioni</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let doctor of filteredDoctors" [class.table-warning]="doctor.status === 'PENDING'">
                <td class="ps-4">
                  <div class="d-flex align-items-center">
                    <div class="rounded-circle p-2 me-3"
                         [ngClass]="{
                           'bg-success bg-opacity-10': doctor.status === 'ACTIVE',
                           'bg-warning bg-opacity-10': doctor.status === 'PENDING',
                           'bg-secondary bg-opacity-10': doctor.status === 'DISABLED'
                         }">
                      <i class="bi bi-person-badge"
                         [ngClass]="{
                           'text-success': doctor.status === 'ACTIVE',
                           'text-warning': doctor.status === 'PENDING',
                           'text-secondary': doctor.status === 'DISABLED'
                         }"></i>
                    </div>
                    <div>
                      <div class="fw-semibold">Dr. {{ doctor.firstName }} {{ doctor.lastName }}</div>
                      <small class="text-muted" *ngIf="doctor.createdAt">Registrato: {{ doctor.createdAt }}</small>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="small">{{ doctor.email }}</div>
                  <div class="small text-muted">{{ doctor.phone || '-' }}</div>
                </td>
                <td>
                  <span class="badge bg-light text-dark">{{ doctor.departmentName }}</span>
                </td>
                <td class="small text-muted">{{ doctor.facilityName }}</td>
                <td>
                  <span class="badge" [ngClass]="getStatusBadgeClass(doctor.status)">
                    {{ getStatusLabel(doctor.status) }}
                  </span>
                  <div class="small text-muted mt-1" style="max-width: 180px;">
                    {{ getStatusDescription(doctor.status) }}
                  </div>
                </td>
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <code *ngFor="let auth of doctor.authorities" class="small bg-light px-1 rounded">{{ auth }}</code>
                  </div>
                </td>
                <td class="text-end pe-4">
                  <div class="btn-group btn-group-sm" *ngIf="doctor.status === 'PENDING'">
                    <button class="btn btn-warning" title="Reinvia email attivazione" (click)="resendActivationEmail(doctor)">
                      <i class="bi bi-envelope"></i>
                    </button>
                    <button class="btn btn-success" title="Attiva manualmente" (click)="activateDoctor(doctor)">
                      <i class="bi bi-check-circle"></i>
                    </button>
                    <button class="btn btn-outline-secondary" title="Modifica" (click)="openDoctorModal(doctor)">
                      <i class="bi bi-pencil"></i>
                    </button>
                  </div>
                  <div class="btn-group btn-group-sm" *ngIf="doctor.status === 'ACTIVE'">
                    <button class="btn btn-outline-secondary" title="Modifica" (click)="openDoctorModal(doctor)">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-primary" title="Trasferisci reparto" (click)="openTransferModal(doctor)">
                      <i class="bi bi-arrow-left-right"></i>
                    </button>
                    <button class="btn btn-outline-danger" title="Disabilita accesso" (click)="disableDoctor(doctor)">
                      <i class="bi bi-x-circle"></i>
                    </button>
                  </div>
                  <div class="btn-group btn-group-sm" *ngIf="doctor.status === 'DISABLED'">
                    <button class="btn btn-outline-success" title="Riattiva accesso" (click)="activateDoctor(doctor)">
                      <i class="bi bi-check-circle"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <tr *ngIf="filteredDoctors.length === 0">
                <td colspan="7" class="text-center py-5">
                  <div class="text-muted">
                    <i class="bi bi-person-badge fs-1 d-block mb-3"></i>
                    <p class="mb-0">Nessun medico trovato.</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Patients Tab -->
      <div *ngIf="activeTab === 'patients'">
        <!-- Info box -->
        <div class="alert alert-info border-0 mb-4">
          <div class="d-flex">
            <i class="bi bi-info-circle fs-5 me-3 mt-1"></i>
            <div>
              <h6 class="alert-heading mb-1">I pazienti si registrano autonomamente</h6>
              <p class="mb-0 small">I pazienti effettuano la registrazione dalla home page del portale pubblico. Da qui puoi visualizzare le loro anagrafiche, reinviare email di attivazione o disabilitare l'accesso se necessario.</p>
            </div>
          </div>
        </div>

        <!-- Alert for pending patients -->
        <div class="alert alert-warning border-0 mb-4" *ngIf="pendingPatients > 0">
          <div class="d-flex">
            <i class="bi bi-exclamation-triangle fs-5 me-3 mt-1"></i>
            <div>
              <h6 class="alert-heading mb-1">{{ pendingPatients }} pazienti in attesa di attivazione</h6>
              <p class="mb-0 small">Questi pazienti si sono registrati ma non hanno ancora confermato l'email o completato il primo accesso.</p>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="ps-4">Paziente</th>
                <th>Contatti</th>
                <th>Codice Fiscale</th>
                <th>Registrato il</th>
                <th>Stato</th>
                <th class="text-end pe-4">Azioni</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let patient of filteredPatients" [class.table-warning]="patient.status === 'PENDING'">
                <td class="ps-4">
                  <div class="d-flex align-items-center">
                    <div class="rounded-circle p-2 me-3"
                         [ngClass]="{
                           'bg-info bg-opacity-10': patient.status === 'ACTIVE',
                           'bg-warning bg-opacity-10': patient.status === 'PENDING',
                           'bg-secondary bg-opacity-10': patient.status === 'DISABLED'
                         }">
                      <i class="bi bi-person"
                         [ngClass]="{
                           'text-info': patient.status === 'ACTIVE',
                           'text-warning': patient.status === 'PENDING',
                           'text-secondary': patient.status === 'DISABLED'
                         }"></i>
                    </div>
                    <div>
                      <div class="fw-semibold">{{ patient.firstName }} {{ patient.lastName }}</div>
                      <small class="text-muted" *ngIf="patient.birthDate">Nato il {{ patient.birthDate }}</small>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="small">{{ patient.email }}</div>
                  <div class="small text-muted">{{ patient.phone || '-' }}</div>
                </td>
                <td>
                  <code class="small bg-light px-1 rounded">{{ patient.fiscalCode }}</code>
                </td>
                <td class="small text-muted">{{ patient.registeredAt }}</td>
                <td>
                  <span class="badge" [ngClass]="getStatusBadgeClass(patient.status)">
                    {{ getStatusLabel(patient.status) }}
                  </span>
                  <div class="small text-muted mt-1" style="max-width: 180px;">
                    {{ getPatientStatusDescription(patient.status) }}
                  </div>
                </td>
                <td class="text-end pe-4">
                  <div class="btn-group btn-group-sm" *ngIf="patient.status === 'PENDING'">
                    <button class="btn btn-warning" title="Reinvia email attivazione" (click)="resendPatientActivationEmail(patient)">
                      <i class="bi bi-envelope"></i>
                    </button>
                    <button class="btn btn-success" title="Attiva manualmente" (click)="activatePatient(patient)">
                      <i class="bi bi-check-circle"></i>
                    </button>
                    <button class="btn btn-outline-info" title="Dettagli" (click)="openPatientDetail(patient)">
                      <i class="bi bi-eye"></i>
                    </button>
                  </div>
                  <div class="btn-group btn-group-sm" *ngIf="patient.status === 'ACTIVE'">
                    <button class="btn btn-outline-info" title="Dettagli" (click)="openPatientDetail(patient)">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-outline-danger" title="Disabilita accesso" (click)="disablePatient(patient)">
                      <i class="bi bi-x-circle"></i>
                    </button>
                  </div>
                  <div class="btn-group btn-group-sm" *ngIf="patient.status === 'DISABLED'">
                    <button class="btn btn-outline-success" title="Riattiva accesso" (click)="activatePatient(patient)">
                      <i class="bi bi-check-circle"></i>
                    </button>
                    <button class="btn btn-outline-info" title="Dettagli" (click)="openPatientDetail(patient)">
                      <i class="bi bi-eye"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <tr *ngIf="filteredPatients.length === 0">
                <td colspan="6" class="text-center py-5">
                  <div class="text-muted">
                    <i class="bi bi-people fs-1 d-block mb-3"></i>
                    <p class="mb-0">Nessun paziente trovato.</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Facility Modal -->
<ng-container *ngIf="showFacilityModal">
  <div
    class="modal-backdrop fade show"
    style="position: fixed; inset: 0; z-index: 1050;"
    (click)="closeFacilityModal()"></div>
  <div
    class="modal d-flex align-items-center justify-content-center"
    role="dialog"
    aria-modal="true"
    style="position: fixed; inset: 0; z-index: 1055;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <div>
            <h5 class="modal-title fw-bold">
              <i class="bi bi-building me-2 text-primary"></i>
              {{ editMode ? 'Modifica Struttura' : 'Nuova Struttura' }}
            </h5>
          </div>
          <button type="button" class="btn-close" (click)="closeFacilityModal()"></button>
        </div>
        <div class="modal-body pt-4">
          <div class="mb-3">
            <label class="form-label fw-semibold">Codice Struttura <span class="text-danger">*</span></label>
            <input type="text" class="form-control" [(ngModel)]="facilityForm.code" placeholder="es. POLI_SUD" [readonly]="editMode">
            <div class="form-text">Codice univoco identificativo della struttura</div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Nome <span class="text-danger">*</span></label>
            <input type="text" class="form-control" [(ngModel)]="facilityForm.name" placeholder="es. Poliambulatorio Sud">
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Indirizzo</label>
            <input type="text" class="form-control" [(ngModel)]="facilityForm.address" placeholder="es. Via Milano 100, Roma">
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Telefono</label>
            <input type="tel" class="form-control" [(ngModel)]="facilityForm.phone" placeholder="es. +39 06 1234567">
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-outline-secondary" (click)="closeFacilityModal()">Annulla</button>
          <button type="button" class="btn btn-primary" (click)="saveFacility()" [disabled]="!facilityForm.code || !facilityForm.name">
            {{ editMode ? 'Salva modifiche' : 'Crea Struttura' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!-- Department Modal -->
<ng-container *ngIf="showDepartmentModal">
  <div
    class="modal-backdrop fade show"
    style="position: fixed; inset: 0; z-index: 1050;"
    (click)="closeDepartmentModal()"></div>
  <div
    class="modal d-flex align-items-center justify-content-center"
    role="dialog"
    aria-modal="true"
    style="position: fixed; inset: 0; z-index: 1055;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <div>
            <h5 class="modal-title fw-bold">
              <i class="bi bi-hospital me-2 text-info"></i>
              {{ editMode ? 'Modifica Reparto' : 'Nuovo Reparto' }}
            </h5>
          </div>
          <button type="button" class="btn-close" (click)="closeDepartmentModal()"></button>
        </div>
        <div class="modal-body pt-4">
          <div class="mb-3">
            <label class="form-label fw-semibold">Codice Reparto <span class="text-danger">*</span></label>
            <input type="text" class="form-control" [(ngModel)]="departmentForm.code" placeholder="es. PHYSIO" [readonly]="editMode">
            <div class="form-text">Codice univoco usato per le policy di accesso (es. DEPT_PHYSIO)</div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Nome <span class="text-danger">*</span></label>
            <input type="text" class="form-control" [(ngModel)]="departmentForm.name" placeholder="es. Fisioterapia e Riabilitazione">
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Struttura <span class="text-danger">*</span></label>
            <select class="form-select" [(ngModel)]="departmentForm.facilityCode">
              <option *ngFor="let f of facilities" [value]="f.code">{{ f.name }}</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Posti letto disponibili</label>
            <input type="number" class="form-control" [(ngModel)]="departmentForm.capacity" placeholder="es. 20" min="0">
            <div class="form-text">Numero di posti letto del reparto (opzionale)</div>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-outline-secondary" (click)="closeDepartmentModal()">Annulla</button>
          <button type="button" class="btn btn-primary" (click)="saveDepartment()" [disabled]="!departmentForm.code || !departmentForm.name">
            {{ editMode ? 'Salva modifiche' : 'Crea Reparto' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!-- Doctor Modal -->
<ng-container *ngIf="showDoctorModal">
  <div
    class="modal-backdrop fade show"
    style="position: fixed; inset: 0; z-index: 1050;"
    (click)="closeDoctorModal()"></div>
  <div
    class="modal d-flex align-items-center justify-content-center"
    role="dialog"
    aria-modal="true"
    style="position: fixed; inset: 0; z-index: 1055;">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <div>
            <h5 class="modal-title fw-bold">
              <i class="bi bi-person-badge me-2 text-success"></i>
              {{ editMode ? 'Modifica Medico' : 'Registra Nuovo Medico' }}
            </h5>
            <p class="text-muted small mb-0 mt-1" *ngIf="!editMode">Il medico ricevera' le credenziali via email</p>
          </div>
          <button type="button" class="btn-close" (click)="closeDoctorModal()"></button>
        </div>
        <div class="modal-body pt-4">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Nome <span class="text-danger">*</span></label>
              <input type="text" class="form-control" [(ngModel)]="doctorForm.firstName" placeholder="es. Giuseppe">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Cognome <span class="text-danger">*</span></label>
              <input type="text" class="form-control" [(ngModel)]="doctorForm.lastName" placeholder="es. Verdi">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Email istituzionale <span class="text-danger">*</span></label>
              <input type="email" class="form-control" [(ngModel)]="doctorForm.email" placeholder="es. giuseppe.verdi@sanitech.it">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Telefono</label>
              <input type="tel" class="form-control" [(ngModel)]="doctorForm.phone" placeholder="+39 02 1234567">
            </div>
            <div class="col-12">
              <label class="form-label fw-semibold">Reparto <span class="text-danger">*</span></label>
              <select class="form-select" [(ngModel)]="doctorForm.departmentCode">
                <option *ngFor="let d of departments" [value]="d.code">{{ d.name }} ({{ d.facilityName }})</option>
              </select>
              <div class="form-text">Il medico verra' automaticamente associato alla struttura del reparto selezionato.</div>
            </div>
          </div>

          <div class="alert alert-info border-0 mt-4 mb-0" *ngIf="!editMode">
            <div class="d-flex">
              <i class="bi bi-info-circle me-2 mt-1"></i>
              <div>
                <strong>Cosa succede al salvataggio:</strong>
                <ol class="mb-0 mt-2 ps-3 small">
                  <li>Il sistema genera automaticamente le credenziali Keycloak</li>
                  <li>Il medico riceve un'email con link per impostare la password</li>
                  <li>Lo stato sara' <span class="badge bg-warning text-dark">In attesa attivazione</span> fino al primo accesso</li>
                  <li>Authority assegnate: <code>ROLE_DOCTOR</code> + <code>DEPT_{{ doctorForm.departmentCode || 'XXX' }}</code></li>
                </ol>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-outline-secondary" (click)="closeDoctorModal()">Annulla</button>
          <button type="button" class="btn btn-primary" (click)="saveDoctor()"
                  [disabled]="!doctorForm.firstName || !doctorForm.lastName || !doctorForm.email || !doctorForm.departmentCode">
            {{ editMode ? 'Salva modifiche' : 'Registra Medico' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!-- Transfer Modal -->
<ng-container *ngIf="showTransferModal">
  <div
    class="modal-backdrop fade show"
    style="position: fixed; inset: 0; z-index: 1050;"
    (click)="closeTransferModal()"></div>
  <div
    class="modal d-flex align-items-center justify-content-center"
    role="dialog"
    aria-modal="true"
    style="position: fixed; inset: 0; z-index: 1055;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <div>
            <h5 class="modal-title fw-bold">
              <i class="bi bi-arrow-left-right me-2 text-primary"></i>
              Trasferisci Medico
            </h5>
          </div>
          <button type="button" class="btn-close" (click)="closeTransferModal()"></button>
        </div>
        <div class="modal-body pt-4">
          <p>Stai per trasferire <strong>{{ transferForm.doctorName }}</strong> a un nuovo reparto.</p>

          <div class="mb-4">
            <label class="form-label fw-semibold">Nuovo Reparto <span class="text-danger">*</span></label>
            <select class="form-select" [(ngModel)]="transferForm.newDepartmentCode">
              <option *ngFor="let d of departments" [value]="d.code">{{ d.name }} ({{ d.facilityName }})</option>
            </select>
          </div>

          <div class="alert alert-warning border-0 mb-0">
            <div class="d-flex">
              <i class="bi bi-exclamation-triangle me-2 mt-1"></i>
              <div>
                <strong>Il trasferimento comportera':</strong>
                <ul class="mb-0 mt-2 small">
                  <li>Revoca dell'authority del reparto corrente</li>
                  <li>Assegnazione dell'authority del nuovo reparto</li>
                  <li>Perdita della visibilita' sui pazienti del vecchio reparto (salvo consensi espliciti gia' concessi)</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-outline-secondary" (click)="closeTransferModal()">Annulla</button>
          <button type="button" class="btn btn-primary" (click)="transferDoctor()">
            Conferma Trasferimento
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!-- Confirm Modal -->
<ng-container *ngIf="showConfirmModal">
  <div
    class="modal-backdrop fade show"
    style="position: fixed; inset: 0; z-index: 1050;"
    (click)="closeConfirmModal()"></div>
  <div
    class="modal d-flex align-items-center justify-content-center"
    role="dialog"
    aria-modal="true"
    style="position: fixed; inset: 0; z-index: 1055;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold text-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            {{ confirmAction.title }}
          </h5>
          <button type="button" class="btn-close" (click)="closeConfirmModal()"></button>
        </div>
        <div class="modal-body">
          <p>{{ confirmAction.message }}</p>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-outline-secondary" (click)="closeConfirmModal()">Annulla</button>
          <button type="button" class="btn btn-danger" (click)="confirmAction.onConfirm()">Conferma</button>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!-- Patient Detail Modal -->
<ng-container *ngIf="showPatientDetailModal && selectedPatient">
  <div
    class="modal-backdrop fade show"
    style="position: fixed; inset: 0; z-index: 1050;"
    (click)="closePatientDetailModal()"></div>
  <div
    class="modal d-flex align-items-center justify-content-center"
    role="dialog"
    aria-modal="true"
    style="position: fixed; inset: 0; z-index: 1055;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <div>
            <h5 class="modal-title fw-bold">
              <i class="bi bi-person me-2 text-info"></i>
              Dettagli Paziente
            </h5>
          </div>
          <button type="button" class="btn-close" (click)="closePatientDetailModal()"></button>
        </div>
        <div class="modal-body pt-4">
          <div class="d-flex align-items-center gap-3 mb-4">
            <div class="rounded-circle p-3"
                 [ngClass]="{
                   'bg-info bg-opacity-10': selectedPatient.status === 'ACTIVE',
                   'bg-warning bg-opacity-10': selectedPatient.status === 'PENDING',
                   'bg-secondary bg-opacity-10': selectedPatient.status === 'DISABLED'
                 }">
              <i class="bi bi-person fs-4"
                 [ngClass]="{
                   'text-info': selectedPatient.status === 'ACTIVE',
                   'text-warning': selectedPatient.status === 'PENDING',
                   'text-secondary': selectedPatient.status === 'DISABLED'
                 }"></i>
            </div>
            <div>
              <h5 class="mb-1 fw-semibold">{{ selectedPatient.firstName }} {{ selectedPatient.lastName }}</h5>
              <span class="badge" [ngClass]="getStatusBadgeClass(selectedPatient.status)">
                {{ getStatusLabel(selectedPatient.status) }}
              </span>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-sm-4"><small class="text-muted">Email</small></div>
            <div class="col-sm-8">{{ selectedPatient.email }}</div>

            <div class="col-sm-4"><small class="text-muted">Telefono</small></div>
            <div class="col-sm-8">{{ selectedPatient.phone || '-' }}</div>

            <div class="col-sm-4"><small class="text-muted">Codice Fiscale</small></div>
            <div class="col-sm-8"><code>{{ selectedPatient.fiscalCode }}</code></div>

            <div class="col-sm-4"><small class="text-muted">Data di nascita</small></div>
            <div class="col-sm-8">{{ selectedPatient.birthDate || '-' }}</div>

            <div class="col-sm-4"><small class="text-muted">Indirizzo</small></div>
            <div class="col-sm-8">{{ selectedPatient.address || '-' }}</div>

            <div class="col-sm-4"><small class="text-muted">Registrato il</small></div>
            <div class="col-sm-8">{{ selectedPatient.registeredAt }}</div>

            <div class="col-sm-4" *ngIf="selectedPatient.activatedAt"><small class="text-muted">Attivato il</small></div>
            <div class="col-sm-8" *ngIf="selectedPatient.activatedAt">{{ selectedPatient.activatedAt }}</div>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-primary" (click)="closePatientDetailModal()">Chiudi</button>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!-- Toast Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div *ngFor="let toast of toasts" class="toast show" role="alert">
    <div class="toast-header" [ngClass]="{
      'bg-success text-white': toast.type === 'success',
      'bg-danger text-white': toast.type === 'error',
      'bg-info text-white': toast.type === 'info'
    }">
      <i class="bi me-2" [ngClass]="{
        'bi-check-circle': toast.type === 'success',
        'bi-exclamation-circle': toast.type === 'error',
        'bi-info-circle': toast.type === 'info'
      }"></i>
      <strong class="me-auto">
        {{ toast.type === 'success' ? 'Successo' : toast.type === 'error' ? 'Errore' : 'Info' }}
      </strong>
    </div>
    <div class="toast-body">
      {{ toast.message }}
    </div>
  </div>
</div>
