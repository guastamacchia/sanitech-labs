<section class="py-4">
  <div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
      <div>
        <p class="section-title mb-1">Amministrazione</p>
        <h2 class="fw-bold mb-2">Directory & Anagrafiche</h2>
        <p class="text-muted mb-0">Gestione strutture, reparti, medici e pazienti.</p>
      </div>
      <button class="btn btn-outline-primary btn-sm" type="button" (click)="goBack()">
        Torna al pannello admin
      </button>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="d-flex align-items-center gap-3">
            <div class="avatar-circle" style="background: #6f42c1;">
              <span class="fs-5">S</span>
            </div>
            <div>
              <div class="text-muted small">Strutture</div>
              <div class="fw-bold fs-4">{{ totalFacilities }}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="d-flex align-items-center gap-3">
            <div class="avatar-circle bg-primary">
              <span class="fs-5">R</span>
            </div>
            <div>
              <div class="text-muted small">Reparti</div>
              <div class="fw-bold fs-4">{{ totalDepartments }}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="d-flex align-items-center gap-3">
            <div class="avatar-circle bg-success">
              <span class="fs-5">{{ activeDoctors }}</span>
            </div>
            <div>
              <div class="text-muted small">Medici attivi</div>
              <div class="fw-bold fs-4">{{ activeDoctors }}/{{ totalDoctors }}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card" [class.border-warning]="pendingDoctors > 0" [style.borderWidth]="pendingDoctors > 0 ? '2px' : '0'">
          <div class="d-flex align-items-center gap-3">
            <div class="avatar-circle bg-warning text-dark">
              <span class="fs-5">{{ pendingDoctors }}</span>
            </div>
            <div>
              <div class="text-muted small">In attesa attivazione</div>
              <div class="fw-bold fs-4">{{ pendingDoctors }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="card card-glass">
      <div class="card-header bg-transparent border-bottom">
        <ul class="nav nav-tabs card-header-tabs">
          <li class="nav-item">
            <button class="nav-link" [class.active]="activeTab === 'facilities'" (click)="setTab('facilities')">
              Strutture
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" [class.active]="activeTab === 'departments'" (click)="setTab('departments')">
              Reparti
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link position-relative" [class.active]="activeTab === 'doctors'" (click)="setTab('doctors')">
              Medici
              <span *ngIf="pendingDoctors > 0" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark" style="font-size: 0.65rem;">
                {{ pendingDoctors }}
              </span>
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link position-relative" [class.active]="activeTab === 'patients'" (click)="setTab('patients')">
              Pazienti
              <span *ngIf="pendingPatients > 0" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark" style="font-size: 0.65rem;">
                {{ pendingPatients }}
              </span>
            </button>
          </li>
        </ul>
      </div>

      <div class="card-body">
        <!-- Search and Actions Bar -->
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
          <div class="input-group" style="max-width: 320px;">
            <span class="input-group-text bg-white border-end-0">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
              </svg>
            </span>
            <input type="text" class="form-control border-start-0" placeholder="Cerca..." [(ngModel)]="searchQuery">
          </div>

          <div class="d-flex gap-2">
            <!-- Refresh Button -->
            <button class="btn btn-outline-secondary" (click)="loadAllData()" [disabled]="isLoading" title="Aggiorna dati">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" [class.spin]="isLoading">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
              </svg>
            </button>
            <button *ngIf="activeTab === 'facilities'" class="btn btn-primary" (click)="openFacilityModal()">
              + Nuova Struttura
            </button>
            <button *ngIf="activeTab === 'departments'" class="btn btn-primary" (click)="openDepartmentModal()">
              + Nuovo Reparto
            </button>
            <button *ngIf="activeTab === 'doctors'" class="btn btn-primary" (click)="openDoctorModal()">
              + Nuovo Medico
            </button>
          </div>
        </div>

        <!-- Facilities Tab -->
        <div *ngIf="activeTab === 'facilities'">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Codice</th>
                  <th>Nome Struttura</th>
                  <th>Indirizzo</th>
                  <th>Telefono</th>
                  <th>Reparti</th>
                  <th class="text-end">Azioni</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let facility of filteredFacilities">
                  <td>
                    <code class="bg-light px-2 py-1 rounded">{{ facility.code }}</code>
                  </td>
                  <td class="fw-medium">{{ facility.name }}</td>
                  <td class="text-muted">{{ facility.address || '-' }}</td>
                  <td>{{ facility.phone || '-' }}</td>
                  <td>
                    <span class="badge bg-primary rounded-pill">
                      {{ getDepartmentCountForFacility(facility.code) }}
                    </span>
                  </td>
                  <td class="text-end">
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-secondary" title="Modifica" (click)="openFacilityModal(facility)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                        </svg>
                      </button>
                      <button class="btn btn-outline-danger" title="Elimina" (click)="deleteFacility(facility)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                          <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="filteredFacilities.length === 0">
                  <td colspan="6" class="text-center text-muted py-4">Nessuna struttura trovata.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Departments Tab -->
        <div *ngIf="activeTab === 'departments'">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Codice</th>
                  <th>Nome Reparto</th>
                  <th>Struttura</th>
                  <th>Medici</th>
                  <th class="text-end">Azioni</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let dept of filteredDepartments">
                  <td>
                    <code class="bg-light px-2 py-1 rounded">{{ dept.code }}</code>
                  </td>
                  <td class="fw-medium">{{ dept.name }}</td>
                  <td>{{ dept.facilityName }}</td>
                  <td>
                    <span class="badge bg-primary rounded-pill">{{ dept.doctorCount || 0 }}</span>
                  </td>
                  <td class="text-end">
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-secondary" title="Modifica" (click)="openDepartmentModal(dept)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                        </svg>
                      </button>
                      <button class="btn btn-outline-danger" title="Elimina" (click)="deleteDepartment(dept)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                          <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="filteredDepartments.length === 0">
                  <td colspan="5" class="text-center text-muted py-4">Nessun reparto trovato.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Doctors Tab -->
        <div *ngIf="activeTab === 'doctors'">
          <!-- Alert for pending doctors -->
          <div class="alert alert-warning d-flex align-items-start gap-3 mb-4" *ngIf="pendingDoctors > 0">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16" class="flex-shrink-0 mt-1">
              <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
            <div>
              <strong>{{ pendingDoctors }} medici in attesa di attivazione</strong>
              <p class="mb-0 small">Questi medici hanno ricevuto le credenziali via email ma non hanno ancora completato il primo accesso. Puoi reinviare l'email di attivazione o attivare manualmente l'account se necessario.</p>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Medico</th>
                  <th>Contatti</th>
                  <th>Reparto</th>
                  <th>Struttura</th>
                  <th>Stato</th>
                  <th>Authority</th>
                  <th class="text-end">Azioni</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let doctor of filteredDoctors" [class.table-warning]="doctor.status === 'PENDING'">
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <div class="avatar-circle avatar-sm" style="width: 36px; height: 36px; font-size: 0.8rem;"
                           [class.bg-warning]="doctor.status === 'PENDING'"
                           [class.bg-secondary]="doctor.status === 'DISABLED'"
                           [class.text-dark]="doctor.status === 'PENDING'">
                        {{ getInitials(doctor.firstName, doctor.lastName) }}
                      </div>
                      <div>
                        <div class="fw-medium">Dr. {{ doctor.firstName }} {{ doctor.lastName }}</div>
                        <small class="text-muted" *ngIf="doctor.createdAt">Registrato: {{ doctor.createdAt }}</small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="small">{{ doctor.email }}</div>
                    <div class="small text-muted">{{ doctor.phone || '-' }}</div>
                  </td>
                  <td>
                    <span class="badge badge-soft">{{ doctor.departmentName }}</span>
                  </td>
                  <td class="small text-muted">{{ doctor.facilityName }}</td>
                  <td>
                    <div>
                      <span class="badge" [ngClass]="getStatusBadgeClass(doctor.status)">
                        {{ getStatusLabel(doctor.status) }}
                      </span>
                      <div class="small text-muted mt-1" style="max-width: 180px;">
                        {{ getStatusDescription(doctor.status) }}
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex flex-wrap gap-1">
                      <code *ngFor="let auth of doctor.authorities" class="small bg-light px-1 rounded">{{ auth }}</code>
                    </div>
                  </td>
                  <td class="text-end">
                    <div class="btn-group btn-group-sm" *ngIf="doctor.status === 'PENDING'">
                      <button class="btn btn-warning" title="Reinvia email attivazione" (click)="resendActivationEmail(doctor)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555ZM0 4.697v7.104l5.803-3.558L0 4.697ZM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757Zm3.436-.586L16 11.801V4.697l-5.803 3.546Z"/>
                        </svg>
                      </button>
                      <button class="btn btn-success" title="Attiva manualmente" (click)="activateDoctor(doctor)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                        </svg>
                      </button>
                      <button class="btn btn-outline-secondary" title="Modifica" (click)="openDoctorModal(doctor)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                        </svg>
                      </button>
                    </div>
                    <div class="btn-group btn-group-sm" *ngIf="doctor.status === 'ACTIVE'">
                      <button class="btn btn-outline-secondary" title="Modifica" (click)="openDoctorModal(doctor)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                        </svg>
                      </button>
                      <button class="btn btn-outline-primary" title="Trasferisci reparto" (click)="openTransferModal(doctor)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path fill-rule="evenodd" d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-3.147 3.146a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5zm14-7a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5z"/>
                        </svg>
                      </button>
                      <button class="btn btn-outline-danger" title="Disabilita accesso" (click)="disableDoctor(doctor)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                          <path d="M11.354 4.646a.5.5 0 0 0-.708 0L8 7.293 5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0 0-.708z"/>
                        </svg>
                      </button>
                    </div>
                    <div class="btn-group btn-group-sm" *ngIf="doctor.status === 'DISABLED'">
                      <button class="btn btn-outline-success" title="Riattiva accesso" (click)="activateDoctor(doctor)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="filteredDoctors.length === 0">
                  <td colspan="7" class="text-center text-muted py-4">Nessun medico trovato.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Patients Tab -->
        <div *ngIf="activeTab === 'patients'">
          <!-- Info box -->
          <div class="alert alert-info d-flex align-items-start gap-3 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16" class="flex-shrink-0 mt-1">
              <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
            </svg>
            <div>
              <strong>I pazienti si registrano autonomamente</strong>
              <p class="mb-0 small">I pazienti effettuano la registrazione dalla home page del portale pubblico. Da qui puoi visualizzare le loro anagrafiche, reinviare email di attivazione o disabilitare l'accesso se necessario.</p>
            </div>
          </div>

          <!-- Alert for pending patients -->
          <div class="alert alert-warning d-flex align-items-start gap-3 mb-4" *ngIf="pendingPatients > 0">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16" class="flex-shrink-0 mt-1">
              <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
            <div>
              <strong>{{ pendingPatients }} pazienti in attesa di attivazione</strong>
              <p class="mb-0 small">Questi pazienti si sono registrati ma non hanno ancora confermato l'email o completato il primo accesso.</p>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Paziente</th>
                  <th>Contatti</th>
                  <th>Codice Fiscale</th>
                  <th>Registrato il</th>
                  <th>Stato</th>
                  <th class="text-end">Azioni</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let patient of filteredPatients" [class.table-warning]="patient.status === 'PENDING'">
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <div class="avatar-circle avatar-sm" style="width: 36px; height: 36px; font-size: 0.8rem; background: #17a2b8;"
                           [class.bg-warning]="patient.status === 'PENDING'"
                           [class.bg-secondary]="patient.status === 'DISABLED'"
                           [class.text-dark]="patient.status === 'PENDING'">
                        {{ getInitials(patient.firstName, patient.lastName) }}
                      </div>
                      <div>
                        <div class="fw-medium">{{ patient.firstName }} {{ patient.lastName }}</div>
                        <small class="text-muted" *ngIf="patient.birthDate">Nato il {{ patient.birthDate }}</small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="small">{{ patient.email }}</div>
                    <div class="small text-muted">{{ patient.phone || '-' }}</div>
                  </td>
                  <td>
                    <code class="small bg-light px-1 rounded">{{ patient.fiscalCode }}</code>
                  </td>
                  <td class="small text-muted">{{ patient.registeredAt }}</td>
                  <td>
                    <div>
                      <span class="badge" [ngClass]="getStatusBadgeClass(patient.status)">
                        {{ getStatusLabel(patient.status) }}
                      </span>
                      <div class="small text-muted mt-1" style="max-width: 180px;">
                        {{ getPatientStatusDescription(patient.status) }}
                      </div>
                    </div>
                  </td>
                  <td class="text-end">
                    <div class="btn-group btn-group-sm" *ngIf="patient.status === 'PENDING'">
                      <button class="btn btn-warning" title="Reinvia email attivazione" (click)="resendPatientActivationEmail(patient)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555ZM0 4.697v7.104l5.803-3.558L0 4.697ZM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757Zm3.436-.586L16 11.801V4.697l-5.803 3.546Z"/>
                        </svg>
                      </button>
                      <button class="btn btn-success" title="Attiva manualmente" (click)="activatePatient(patient)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                        </svg>
                      </button>
                      <button class="btn btn-outline-info" title="Dettagli" (click)="openPatientDetail(patient)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
                          <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
                        </svg>
                      </button>
                    </div>
                    <div class="btn-group btn-group-sm" *ngIf="patient.status === 'ACTIVE'">
                      <button class="btn btn-outline-info" title="Dettagli" (click)="openPatientDetail(patient)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
                          <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
                        </svg>
                      </button>
                      <button class="btn btn-outline-danger" title="Disabilita accesso" (click)="disablePatient(patient)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                          <path d="M11.354 4.646a.5.5 0 0 0-.708 0L8 7.293 5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0 0-.708z"/>
                        </svg>
                      </button>
                    </div>
                    <div class="btn-group btn-group-sm" *ngIf="patient.status === 'DISABLED'">
                      <button class="btn btn-outline-success" title="Riattiva accesso" (click)="activatePatient(patient)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                        </svg>
                      </button>
                      <button class="btn btn-outline-info" title="Dettagli" (click)="openPatientDetail(patient)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
                          <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="filteredPatients.length === 0">
                  <td colspan="6" class="text-center text-muted py-4">Nessun paziente trovato.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Facility Modal -->
<div class="modal fade" [class.show]="showFacilityModal" [style.display]="showFacilityModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ editMode ? 'Modifica Struttura' : 'Nuova Struttura' }}</h5>
        <button type="button" class="btn-close" (click)="closeFacilityModal()"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Codice Struttura <span class="text-danger">*</span></label>
          <input type="text" class="form-control" [(ngModel)]="facilityForm.code" placeholder="es. POLI_SUD" [readonly]="editMode">
          <div class="form-text">Codice univoco identificativo della struttura</div>
        </div>
        <div class="mb-3">
          <label class="form-label">Nome <span class="text-danger">*</span></label>
          <input type="text" class="form-control" [(ngModel)]="facilityForm.name" placeholder="es. Poliambulatorio Sud">
        </div>
        <div class="mb-3">
          <label class="form-label">Indirizzo</label>
          <input type="text" class="form-control" [(ngModel)]="facilityForm.address" placeholder="es. Via Milano 100, Roma">
        </div>
        <div class="mb-3">
          <label class="form-label">Telefono</label>
          <input type="tel" class="form-control" [(ngModel)]="facilityForm.phone" placeholder="es. +39 06 1234567">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeFacilityModal()">Annulla</button>
        <button type="button" class="btn btn-primary" (click)="saveFacility()" [disabled]="!facilityForm.code || !facilityForm.name">
          {{ editMode ? 'Salva modifiche' : 'Crea Struttura' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="showFacilityModal"></div>

<!-- Department Modal -->
<div class="modal fade" [class.show]="showDepartmentModal" [style.display]="showDepartmentModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ editMode ? 'Modifica Reparto' : 'Nuovo Reparto' }}</h5>
        <button type="button" class="btn-close" (click)="closeDepartmentModal()"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Codice Reparto <span class="text-danger">*</span></label>
          <input type="text" class="form-control" [(ngModel)]="departmentForm.code" placeholder="es. PHYSIO" [readonly]="editMode">
          <div class="form-text">Codice univoco usato per le policy di accesso (es. DEPT_PHYSIO)</div>
        </div>
        <div class="mb-3">
          <label class="form-label">Nome <span class="text-danger">*</span></label>
          <input type="text" class="form-control" [(ngModel)]="departmentForm.name" placeholder="es. Fisioterapia e Riabilitazione">
        </div>
        <div class="mb-3">
          <label class="form-label">Struttura <span class="text-danger">*</span></label>
          <select class="form-select" [(ngModel)]="departmentForm.facilityCode">
            <option *ngFor="let f of facilities" [value]="f.code">{{ f.name }}</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Posti letto disponibili</label>
          <input type="number" class="form-control" [(ngModel)]="departmentForm.capacity" placeholder="es. 20" min="0">
          <div class="form-text">Numero di posti letto del reparto (opzionale)</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDepartmentModal()">Annulla</button>
        <button type="button" class="btn btn-primary" (click)="saveDepartment()" [disabled]="!departmentForm.code || !departmentForm.name">
          {{ editMode ? 'Salva modifiche' : 'Crea Reparto' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="showDepartmentModal"></div>

<!-- Doctor Modal -->
<div class="modal fade" [class.show]="showDoctorModal" [style.display]="showDoctorModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ editMode ? 'Modifica Medico' : 'Registra Nuovo Medico' }}</h5>
        <button type="button" class="btn-close" (click)="closeDoctorModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nome <span class="text-danger">*</span></label>
            <input type="text" class="form-control" [(ngModel)]="doctorForm.firstName" placeholder="es. Giuseppe">
          </div>
          <div class="col-md-6">
            <label class="form-label">Cognome <span class="text-danger">*</span></label>
            <input type="text" class="form-control" [(ngModel)]="doctorForm.lastName" placeholder="es. Verdi">
          </div>
          <div class="col-md-6">
            <label class="form-label">Email istituzionale <span class="text-danger">*</span></label>
            <input type="email" class="form-control" [(ngModel)]="doctorForm.email" placeholder="es. giuseppe.verdi@sanitech.it">
          </div>
          <div class="col-md-6">
            <label class="form-label">Telefono</label>
            <input type="tel" class="form-control" [(ngModel)]="doctorForm.phone" placeholder="+39 02 1234567">
          </div>
          <div class="col-12">
            <label class="form-label">Reparto <span class="text-danger">*</span></label>
            <select class="form-select" [(ngModel)]="doctorForm.departmentCode">
              <option *ngFor="let d of departments" [value]="d.code">{{ d.name }} ({{ d.facilityName }})</option>
            </select>
            <div class="form-text">Il medico verrà automaticamente associato alla struttura del reparto selezionato.</div>
          </div>
        </div>

        <div class="alert alert-info mt-4 mb-0" *ngIf="!editMode">
          <div class="d-flex gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="flex-shrink-0">
              <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
            </svg>
            <div>
              <strong>Cosa succede al salvataggio:</strong>
              <ol class="mb-0 mt-2 ps-3">
                <li>Il sistema genera automaticamente le credenziali Keycloak</li>
                <li>Il medico riceve un'email con link per impostare la password</li>
                <li>Lo stato sarà <span class="badge bg-warning text-dark">In attesa attivazione</span> fino al primo accesso</li>
                <li>Authority assegnate: <code>ROLE_DOCTOR</code> + <code>DEPT_{{ doctorForm.departmentCode || 'XXX' }}</code></li>
              </ol>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDoctorModal()">Annulla</button>
        <button type="button" class="btn btn-primary" (click)="saveDoctor()"
                [disabled]="!doctorForm.firstName || !doctorForm.lastName || !doctorForm.email || !doctorForm.departmentCode">
          {{ editMode ? 'Salva modifiche' : 'Registra Medico' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="showDoctorModal"></div>

<!-- Transfer Modal -->
<div class="modal fade" [class.show]="showTransferModal" [style.display]="showTransferModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Trasferisci Medico</h5>
        <button type="button" class="btn-close" (click)="closeTransferModal()"></button>
      </div>
      <div class="modal-body">
        <p>Stai per trasferire <strong>{{ transferForm.doctorName }}</strong> a un nuovo reparto.</p>

        <div class="mb-3">
          <label class="form-label">Nuovo Reparto <span class="text-danger">*</span></label>
          <select class="form-select" [(ngModel)]="transferForm.newDepartmentCode">
            <option *ngFor="let d of departments" [value]="d.code">{{ d.name }} ({{ d.facilityName }})</option>
          </select>
        </div>

        <div class="alert alert-warning mb-0">
          <div class="d-flex gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="flex-shrink-0">
              <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
            <div>
              <strong>Il trasferimento comporterà:</strong>
              <ul class="mb-0 mt-2">
                <li>Revoca dell'authority del reparto corrente</li>
                <li>Assegnazione dell'authority del nuovo reparto</li>
                <li>Perdita della visibilità sui pazienti del vecchio reparto (salvo consensi espliciti già concessi)</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeTransferModal()">Annulla</button>
        <button type="button" class="btn btn-primary" (click)="transferDoctor()">
          Conferma Trasferimento
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="showTransferModal"></div>

<!-- Confirm Modal -->
<div class="modal fade" [class.show]="showConfirmModal" [style.display]="showConfirmModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ confirmAction.title }}</h5>
        <button type="button" class="btn-close" (click)="closeConfirmModal()"></button>
      </div>
      <div class="modal-body">
        <p>{{ confirmAction.message }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeConfirmModal()">Annulla</button>
        <button type="button" class="btn btn-danger" (click)="confirmAction.onConfirm()">Conferma</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="showConfirmModal"></div>

<!-- Patient Detail Modal -->
<div class="modal fade" [class.show]="showPatientDetailModal" [style.display]="showPatientDetailModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" *ngIf="selectedPatient">
      <div class="modal-header">
        <h5 class="modal-title">Dettagli Paziente</h5>
        <button type="button" class="btn-close" (click)="closePatientDetailModal()"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-center gap-3 mb-4">
          <div class="avatar-circle" style="width: 56px; height: 56px; font-size: 1.2rem; background: #17a2b8;"
               [class.bg-warning]="selectedPatient.status === 'PENDING'"
               [class.bg-secondary]="selectedPatient.status === 'DISABLED'"
               [class.text-dark]="selectedPatient.status === 'PENDING'">
            {{ getInitials(selectedPatient.firstName, selectedPatient.lastName) }}
          </div>
          <div>
            <h5 class="mb-1">{{ selectedPatient.firstName }} {{ selectedPatient.lastName }}</h5>
            <span class="badge" [ngClass]="getStatusBadgeClass(selectedPatient.status)">
              {{ getStatusLabel(selectedPatient.status) }}
            </span>
          </div>
        </div>

        <dl class="row mb-0">
          <dt class="col-sm-4 text-muted">Email</dt>
          <dd class="col-sm-8">{{ selectedPatient.email }}</dd>

          <dt class="col-sm-4 text-muted">Telefono</dt>
          <dd class="col-sm-8">{{ selectedPatient.phone || '-' }}</dd>

          <dt class="col-sm-4 text-muted">Codice Fiscale</dt>
          <dd class="col-sm-8"><code>{{ selectedPatient.fiscalCode }}</code></dd>

          <dt class="col-sm-4 text-muted">Data di nascita</dt>
          <dd class="col-sm-8">{{ selectedPatient.birthDate || '-' }}</dd>

          <dt class="col-sm-4 text-muted">Indirizzo</dt>
          <dd class="col-sm-8">{{ selectedPatient.address || '-' }}</dd>

          <dt class="col-sm-4 text-muted">Registrato il</dt>
          <dd class="col-sm-8">{{ selectedPatient.registeredAt }}</dd>

          <dt class="col-sm-4 text-muted" *ngIf="selectedPatient.activatedAt">Attivato il</dt>
          <dd class="col-sm-8" *ngIf="selectedPatient.activatedAt">{{ selectedPatient.activatedAt }}</dd>
        </dl>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closePatientDetailModal()">Chiudi</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="showPatientDetailModal"></div>

<!-- Toast Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div *ngFor="let toast of toasts" class="toast show" role="alert">
    <div class="toast-header" [ngClass]="{
      'bg-success text-white': toast.type === 'success',
      'bg-danger text-white': toast.type === 'error',
      'bg-info text-white': toast.type === 'info'
    }">
      <strong class="me-auto">
        {{ toast.type === 'success' ? 'Successo' : toast.type === 'error' ? 'Errore' : 'Info' }}
      </strong>
    </div>
    <div class="toast-body">
      {{ toast.message }}
    </div>
  </div>
</div>
